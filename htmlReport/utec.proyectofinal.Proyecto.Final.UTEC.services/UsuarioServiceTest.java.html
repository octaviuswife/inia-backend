<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepPmsControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">UsuarioServiceTest.java</span></div><h1>UsuarioServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockedStatic;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Usuario;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.UsuarioRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.ActualizarPerfilRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.AprobarUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.GestionarUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.RegistroUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.UsuarioDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.EstadoUsuario;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Rol;

import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

/**
 * Tests unitarios para UsuarioService
 * 
 * Funcionalidades testeadas:
 * - Registro de nuevos usuarios
 * - Validación de duplicados (username y email)
 * - Aprobación de solicitudes pendientes
 * - Cambio de contraseña
 * - Activación/Desactivación de usuarios
 * - Gestión de roles
 */
@ExtendWith(MockitoExtension.class)
@org.mockito.junit.jupiter.MockitoSettings(strictness = org.mockito.quality.Strictness.LENIENT)
@DisplayName(&quot;Tests de UsuarioService&quot;)
<span class="fc" id="L53">class UsuarioServiceTest {</span>

    @Mock
    private UsuarioRepository usuarioRepository;

    @Mock
    private PasswordEncoder passwordEncoder;

    @Mock
    private NotificacionService notificacionService;

    @Mock
    private EmailService emailService;

    @Mock
    private TotpService totpService;

    @Mock
    private BackupCodeService backupCodeService;

    @InjectMocks
    private UsuarioService usuarioService;

    private RegistroUsuarioRequestDTO registroRequestDTO;
    private Usuario usuario;
    private Usuario analista;

    @BeforeEach
    void setUp() {
        // ARRANGE: Preparar datos de prueba
<span class="fc" id="L83">        registroRequestDTO = new RegistroUsuarioRequestDTO();</span>
<span class="fc" id="L84">        registroRequestDTO.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L85">        registroRequestDTO.setNombres(&quot;Juan&quot;);</span>
<span class="fc" id="L86">        registroRequestDTO.setApellidos(&quot;Pérez&quot;);</span>
<span class="fc" id="L87">        registroRequestDTO.setEmail(&quot;jperez@example.com&quot;);</span>
<span class="fc" id="L88">        registroRequestDTO.setContrasenia(&quot;Password123!&quot;);</span>

<span class="fc" id="L90">        usuario = new Usuario();</span>
<span class="fc" id="L91">        usuario.setUsuarioID(1);</span>
<span class="fc" id="L92">        usuario.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L93">        usuario.setNombres(&quot;Juan&quot;);</span>
<span class="fc" id="L94">        usuario.setApellidos(&quot;Pérez&quot;);</span>
<span class="fc" id="L95">        usuario.setEmail(&quot;jperez@example.com&quot;);</span>
<span class="fc" id="L96">        usuario.setEstado(EstadoUsuario.PENDIENTE);</span>
<span class="fc" id="L97">        usuario.setActivo(false);</span>

<span class="fc" id="L99">        analista = new Usuario();</span>
<span class="fc" id="L100">        analista.setUsuarioID(2);</span>
<span class="fc" id="L101">        analista.setNombre(&quot;analista1&quot;);</span>
<span class="fc" id="L102">        analista.setNombres(&quot;Ana&quot;);</span>
<span class="fc" id="L103">        analista.setApellidos(&quot;Listas&quot;);</span>
<span class="fc" id="L104">        analista.setEmail(&quot;analista@inia.com&quot;);</span>
<span class="fc" id="L105">        analista.setRol(Rol.ANALISTA);</span>
<span class="fc" id="L106">        analista.setActivo(true);</span>
<span class="fc" id="L107">        analista.setEstado(EstadoUsuario.ACTIVO);</span>
<span class="fc" id="L108">    }</span>

    @Test
    @DisplayName(&quot;Registrar usuario - debe crear usuario en estado PENDIENTE&quot;)
    void registrarSolicitud_debeCrearUsuarioPendiente() {
        // ARRANGE
<span class="fc" id="L114">        when(usuarioRepository.findByNombre(anyString())).thenReturn(Optional.empty());</span>
<span class="fc" id="L115">        when(usuarioRepository.findByEmail(anyString())).thenReturn(Optional.empty());</span>
<span class="fc" id="L116">        when(passwordEncoder.encode(anyString())).thenReturn(&quot;encodedPassword&quot;);</span>
<span class="fc" id="L117">        when(usuarioRepository.save(any(Usuario.class))).thenReturn(usuario);</span>
<span class="fc" id="L118">        when(usuarioRepository.findAllByRol(Rol.ANALISTA)).thenReturn(Arrays.asList(analista));</span>
<span class="fc" id="L119">        doNothing().when(notificacionService).notificarNuevoUsuario(anyLong());</span>
<span class="fc" id="L120">        doNothing().when(emailService).enviarEmailConfirmacionRegistro(anyString(), anyString());</span>
<span class="fc" id="L121">        doNothing().when(emailService).enviarEmailNuevoRegistro(anyString(), anyString(), anyString(), anyString());</span>

        // ACT
<span class="fc" id="L124">        UsuarioDTO resultado = usuarioService.registrarSolicitud(registroRequestDTO);</span>

        // ASSERT
<span class="fc" id="L127">        assertNotNull(resultado, &quot;El usuario registrado no debe ser nulo&quot;);</span>
<span class="fc" id="L128">        assertEquals(&quot;jperez&quot;, resultado.getNombre());</span>
<span class="fc" id="L129">        assertEquals(&quot;Juan&quot;, resultado.getNombres());</span>
<span class="fc" id="L130">        assertEquals(&quot;Pérez&quot;, resultado.getApellidos());</span>
<span class="fc" id="L131">        assertEquals(&quot;jperez@example.com&quot;, resultado.getEmail());</span>
        
<span class="fc" id="L133">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L134">        verify(passwordEncoder, times(1)).encode(&quot;Password123!&quot;);</span>
<span class="fc" id="L135">        verify(notificacionService, times(1)).notificarNuevoUsuario(anyLong());</span>
<span class="fc" id="L136">    }</span>

    @Test
    @DisplayName(&quot;Registrar usuario con nombre duplicado - debe lanzar excepción&quot;)
    void registrarSolicitud_conNombreDuplicado_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L142">        when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuario));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L145">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L146">            usuarioService.registrarSolicitud(registroRequestDTO);</span>
<span class="nc" id="L147">        });</span>
        
<span class="fc" id="L149">        assertEquals(&quot;El nombre de usuario ya existe&quot;, exception.getMessage());</span>
<span class="fc" id="L150">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L151">    }</span>

    @Test
    @DisplayName(&quot;Registrar usuario con email duplicado - debe lanzar excepción&quot;)
    void registrarSolicitud_conEmailDuplicado_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L157">        when(usuarioRepository.findByNombre(anyString())).thenReturn(Optional.empty());</span>
<span class="fc" id="L158">        when(usuarioRepository.findByEmail(&quot;jperez@example.com&quot;)).thenReturn(Optional.of(usuario));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L161">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L162">            usuarioService.registrarSolicitud(registroRequestDTO);</span>
<span class="nc" id="L163">        });</span>
        
<span class="fc" id="L165">        assertEquals(&quot;El email ya está registrado&quot;, exception.getMessage());</span>
<span class="fc" id="L166">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L167">    }</span>

    @Test
    @DisplayName(&quot;Listar solicitudes pendientes - debe retornar solo usuarios PENDIENTES&quot;)
    void listarSolicitudesPendientes_debeRetornarSoloPendientes() {
        // ARRANGE
<span class="fc" id="L173">        Usuario usuario2 = new Usuario();</span>
<span class="fc" id="L174">        usuario2.setUsuarioID(3);</span>
<span class="fc" id="L175">        usuario2.setNombre(&quot;mgarcia&quot;);</span>
<span class="fc" id="L176">        usuario2.setEstado(EstadoUsuario.PENDIENTE);</span>
        
<span class="fc" id="L178">        when(usuarioRepository.findByEstado(EstadoUsuario.PENDIENTE))</span>
<span class="fc" id="L179">            .thenReturn(Arrays.asList(usuario, usuario2));</span>

        // ACT
<span class="fc" id="L182">        List&lt;UsuarioDTO&gt; resultado = usuarioService.listarSolicitudesPendientes();</span>

        // ASSERT
<span class="fc" id="L185">        assertNotNull(resultado);</span>
<span class="fc" id="L186">        assertEquals(2, resultado.size());</span>
<span class="fc" id="L187">        verify(usuarioRepository, times(1)).findByEstado(EstadoUsuario.PENDIENTE);</span>
<span class="fc" id="L188">    }</span>

    @Test
    @DisplayName(&quot;Listar solicitudes pendientes paginadas - debe retornar página correcta&quot;)
    void listarSolicitudesPendientesPaginadas_debeRetornarPaginaCorrecta() {
        // ARRANGE
<span class="fc" id="L194">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(usuario));</span>
        
<span class="fc" id="L196">        when(usuarioRepository.findByEstado(eq(EstadoUsuario.PENDIENTE), any(Pageable.class)))</span>
<span class="fc" id="L197">            .thenReturn(usuariosPage);</span>

        // ACT
<span class="fc" id="L200">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarSolicitudesPendientesPaginadas(0, 10, null);</span>

        // ASSERT
<span class="fc" id="L203">        assertNotNull(resultado);</span>
<span class="fc" id="L204">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L205">        assertEquals(1, resultado.getContent().size());</span>
<span class="fc" id="L206">    }</span>

    @Test
    @DisplayName(&quot;Listar solicitudes con búsqueda - debe filtrar resultados&quot;)
    void listarSolicitudesPendientesPaginadas_conBusqueda_debeFiltrar() {
        // ARRANGE
<span class="fc" id="L212">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(usuario));</span>
        
<span class="fc" id="L214">        when(usuarioRepository.findByEstadoAndSearchTerm(</span>
<span class="fc" id="L215">            eq(EstadoUsuario.PENDIENTE), eq(&quot;juan&quot;), any(Pageable.class)))</span>
<span class="fc" id="L216">            .thenReturn(usuariosPage);</span>

        // ACT
<span class="fc" id="L219">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarSolicitudesPendientesPaginadas(0, 10, &quot;juan&quot;);</span>

        // ASSERT
<span class="fc" id="L222">        assertNotNull(resultado);</span>
<span class="fc" id="L223">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L224">        verify(usuarioRepository, times(1))</span>
<span class="fc" id="L225">            .findByEstadoAndSearchTerm(eq(EstadoUsuario.PENDIENTE), eq(&quot;juan&quot;), any(Pageable.class));</span>
<span class="fc" id="L226">    }</span>

    @Test
    @DisplayName(&quot;Aprobar usuario - debe cambiar estado a APROBADO y asignar rol&quot;)
    void aprobarUsuario_debeCambiarEstadoYAsignarRol() {
        // ARRANGE
<span class="fc" id="L232">        AprobarUsuarioRequestDTO aprobarRequest = new AprobarUsuarioRequestDTO();</span>
<span class="fc" id="L233">        aprobarRequest.setRol(Rol.ANALISTA);</span>
        
<span class="fc" id="L235">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L236">        when(usuarioRepository.save(any(Usuario.class))).thenReturn(usuario);</span>
<span class="fc" id="L237">        doNothing().when(emailService).enviarEmailBienvenida(anyString(), anyString());</span>

        // ACT
<span class="fc" id="L240">        UsuarioDTO resultado = usuarioService.aprobarUsuario(1, aprobarRequest);</span>

        // ASSERT
<span class="fc" id="L243">        assertNotNull(resultado);</span>
<span class="fc" id="L244">        verify(usuarioRepository, times(1)).findById(1);</span>
<span class="fc" id="L245">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L246">    }</span>

    @Test
    @DisplayName(&quot;Aprobar usuario inexistente - debe lanzar excepción&quot;)
    void aprobarUsuario_usuarioInexistente_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L252">        AprobarUsuarioRequestDTO aprobarRequest = new AprobarUsuarioRequestDTO();</span>
<span class="fc" id="L253">        aprobarRequest.setRol(Rol.ANALISTA);</span>
        
<span class="fc" id="L255">        when(usuarioRepository.findById(999)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L258">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L259">            usuarioService.aprobarUsuario(999, aprobarRequest);</span>
<span class="nc" id="L260">        });</span>
        
<span class="fc" id="L262">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L263">    }</span>

    @Test
    @DisplayName(&quot;Buscar usuario por ID - debe retornar usuario si existe&quot;)
    void buscarPorId_cuandoExiste_debeRetornarUsuario() {
        // ARRANGE
<span class="fc" id="L269">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>

        // ACT
<span class="fc" id="L272">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorId(1);</span>

        // ASSERT
<span class="fc" id="L275">        assertTrue(resultado.isPresent());</span>
<span class="fc" id="L276">        assertEquals(1, resultado.get().getUsuarioID());</span>
<span class="fc" id="L277">        assertEquals(&quot;jperez&quot;, resultado.get().getNombre());</span>
<span class="fc" id="L278">    }</span>

    @Test
    @DisplayName(&quot;Buscar usuario por ID inexistente - debe retornar Optional vacío&quot;)
    void buscarPorId_cuandoNoExiste_debeRetornarOptionalVacio() {
        // ARRANGE
<span class="fc" id="L284">        when(usuarioRepository.findById(999)).thenReturn(Optional.empty());</span>

        // ACT
<span class="fc" id="L287">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorId(999);</span>

        // ASSERT
<span class="fc" id="L290">        assertFalse(resultado.isPresent());</span>
<span class="fc" id="L291">    }</span>

    @Test
    @DisplayName(&quot;Gestionar usuario - debe cambiar rol y estado de usuario&quot;)
    void gestionarUsuario_debeCambiarRolYEstado() {
        // ARRANGE
<span class="fc" id="L297">        GestionarUsuarioRequestDTO gestionRequest = new GestionarUsuarioRequestDTO();</span>
<span class="fc" id="L298">        gestionRequest.setRol(Rol.ADMIN);</span>
<span class="fc" id="L299">        gestionRequest.setActivo(true);</span>
        
<span class="fc" id="L301">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L302">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; {</span>
<span class="fc" id="L303">            Usuario u = invocation.getArgument(0);</span>
<span class="fc" id="L304">            return u;</span>
        });

        // ACT
<span class="fc" id="L308">        UsuarioDTO resultado = usuarioService.gestionarUsuario(1, gestionRequest);</span>

        // ASSERT
<span class="fc" id="L311">        assertNotNull(resultado);</span>
<span class="fc" id="L312">        verify(usuarioRepository, times(1)).findById(1);</span>
<span class="fc" id="L313">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L314">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - actualiza nombres y apellidos correctamente&quot;)
    void actualizarPerfil_actualizaNombresYApellidos() {
        // ARRANGE
<span class="fc" id="L320">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L321">        request.setNombres(&quot;Juan Carlos&quot;);</span>
<span class="fc" id="L322">        request.setApellidos(&quot;Pérez García&quot;);</span>
        
<span class="fc" id="L324">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L325">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L326">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L327">        usuarioActual.setNombres(&quot;Juan&quot;);</span>
<span class="fc" id="L328">        usuarioActual.setApellidos(&quot;Pérez&quot;);</span>
<span class="fc" id="L329">        usuarioActual.setEmail(&quot;jperez@example.com&quot;);</span>
<span class="fc" id="L330">        usuarioActual.setContrasenia(&quot;encodedPassword&quot;);</span>
        
<span class="fc" id="L332">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L333">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L334">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L336">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L337">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L338">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L339">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L340">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            // ACT
<span class="fc" id="L343">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            // ASSERT
<span class="fc" id="L346">            assertNotNull(resultado);</span>
<span class="fc" id="L347">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L349">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - cambia contraseña con contraseña actual correcta&quot;)
    void actualizarPerfil_cambiaContraseniaCorrectamente() {
        // ARRANGE
<span class="fc" id="L355">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L356">        request.setContraseniaActual(&quot;oldPassword&quot;);</span>
<span class="fc" id="L357">        request.setContraseniaNueva(&quot;NewPassword123!&quot;);</span>
        
<span class="fc" id="L359">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L360">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L361">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L362">        usuarioActual.setContrasenia(&quot;encodedOldPassword&quot;);</span>
        
<span class="fc" id="L364">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L365">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L366">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L368">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L369">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L370">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L371">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L372">            when(passwordEncoder.matches(&quot;oldPassword&quot;, &quot;encodedOldPassword&quot;)).thenReturn(true);</span>
<span class="fc" id="L373">            when(passwordEncoder.encode(&quot;NewPassword123!&quot;)).thenReturn(&quot;encodedNewPassword&quot;);</span>
<span class="fc" id="L374">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            // ACT
<span class="fc" id="L377">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            // ASSERT
<span class="fc" id="L380">            assertNotNull(resultado);</span>
<span class="fc" id="L381">            verify(passwordEncoder, times(1)).encode(&quot;NewPassword123!&quot;);</span>
<span class="fc" id="L382">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L384">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - lanza excepción si contraseña actual es incorrecta&quot;)
    void actualizarPerfil_contraseniaActualIncorrecta_lanzaExcepcion() {
        // ARRANGE
<span class="fc" id="L390">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L391">        request.setContraseniaActual(&quot;wrongPassword&quot;);</span>
<span class="fc" id="L392">        request.setContraseniaNueva(&quot;NewPassword123!&quot;);</span>
        
<span class="fc" id="L394">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L395">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L396">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L397">        usuarioActual.setContrasenia(&quot;encodedOldPassword&quot;);</span>
        
<span class="fc" id="L399">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L400">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L401">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L403">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L404">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L405">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L406">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L407">            when(passwordEncoder.matches(&quot;wrongPassword&quot;, &quot;encodedOldPassword&quot;)).thenReturn(false);</span>
            
            // ACT &amp; ASSERT
<span class="fc" id="L410">            RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L411">                usuarioService.actualizarPerfil(request);</span>
<span class="nc" id="L412">            });</span>
            
<span class="fc" id="L414">            assertTrue(exception.getMessage().contains(&quot;Contraseña actual incorrecta&quot;));</span>
<span class="fc" id="L415">            verify(usuarioRepository, never()).save(any(Usuario.class));</span>
        }
<span class="fc" id="L417">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - sin filtros retorna todos paginados&quot;)
    void listarTodosUsuariosPaginados_sinFiltros() {
        // ARRANGE
<span class="fc" id="L423">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(usuario, analista));</span>
        
<span class="fc" id="L425">        when(usuarioRepository.findAll(any(Pageable.class))).thenReturn(usuariosPage);</span>
        
        // ACT
<span class="fc" id="L428">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, null, null, null);</span>
        
        // ASSERT
<span class="fc" id="L431">        assertNotNull(resultado);</span>
<span class="fc" id="L432">        assertEquals(2, resultado.getTotalElements());</span>
<span class="fc" id="L433">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - con rol ANALISTA&quot;)
    void listarTodosUsuariosPaginados_conRolAnalista() {
        // ARRANGE
<span class="fc" id="L439">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(analista));</span>
        
<span class="fc" id="L441">        when(usuarioRepository.findByRol(eq(Rol.ANALISTA), any(Pageable.class)))</span>
<span class="fc" id="L442">            .thenReturn(usuariosPage);</span>
        
        // ACT
<span class="fc" id="L445">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, null, Rol.ANALISTA, null);</span>
        
        // ASSERT
<span class="fc" id="L448">        assertNotNull(resultado);</span>
<span class="fc" id="L449">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L450">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - con activo=true&quot;)
    void listarTodosUsuariosPaginados_conActivoTrue() {
        // ARRANGE
<span class="fc" id="L456">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(analista));</span>
        
<span class="fc" id="L458">        when(usuarioRepository.findByActivo(eq(true), any(Pageable.class)))</span>
<span class="fc" id="L459">            .thenReturn(usuariosPage);</span>
        
        // ACT
<span class="fc" id="L462">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, null, null, true);</span>
        
        // ASSERT
<span class="fc" id="L465">        assertNotNull(resultado);</span>
<span class="fc" id="L466">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L467">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - con búsqueda&quot;)
    void listarTodosUsuariosPaginados_conBusqueda() {
        // ARRANGE
<span class="fc" id="L473">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(analista));</span>
        
<span class="fc" id="L475">        when(usuarioRepository.findBySearchTerm(eq(&quot;ana&quot;), any(Pageable.class)))</span>
<span class="fc" id="L476">            .thenReturn(usuariosPage);</span>
        
        // ACT
<span class="fc" id="L479">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, &quot;ana&quot;, null, null);</span>
        
        // ASSERT
<span class="fc" id="L482">        assertNotNull(resultado);</span>
<span class="fc" id="L483">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L484">    }</span>

    @Test
    @DisplayName(&quot;cambiarContrasenia - cambia contraseña correctamente&quot;)
    void cambiarContrasenia_cambiaCorrectamente() {
        // ARRANGE
<span class="fc" id="L490">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L491">        when(passwordEncoder.encode(&quot;NewPassword123!&quot;)).thenReturn(&quot;encodedNewPassword&quot;);</span>
<span class="fc" id="L492">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
        
        // ACT
<span class="fc" id="L495">        usuarioService.cambiarContrasenia(1, &quot;NewPassword123!&quot;);</span>
        
        // ASSERT
<span class="fc" id="L498">        verify(passwordEncoder, times(1)).encode(&quot;NewPassword123!&quot;);</span>
<span class="fc" id="L499">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L500">    }</span>

    @Test
    @DisplayName(&quot;cambiarContrasenia - lanza excepción si contraseña vacía&quot;)
    void cambiarContrasenia_contraseniaVacia_lanzaExcepcion() {
        // ARRANGE
<span class="fc" id="L506">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
        
        // ACT &amp; ASSERT
<span class="fc" id="L509">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L510">            usuarioService.cambiarContrasenia(1, &quot;&quot;);</span>
<span class="nc" id="L511">        });</span>
        
<span class="fc" id="L513">        assertTrue(exception.getMessage().contains(&quot;no puede estar vacía&quot;));</span>
<span class="fc" id="L514">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L515">    }</span>

    @Test
    @DisplayName(&quot;cambiarContrasenia - lanza excepción si contraseña muy corta&quot;)
    void cambiarContrasenia_contraseniaMuyCorta_lanzaExcepcion() {
        // ARRANGE
<span class="fc" id="L521">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
        
        // ACT &amp; ASSERT
<span class="fc" id="L524">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L525">            usuarioService.cambiarContrasenia(1, &quot;short&quot;);</span>
<span class="nc" id="L526">        });</span>
        
<span class="fc" id="L528">        assertTrue(exception.getMessage().contains(&quot;al menos 8 caracteres&quot;));</span>
<span class="fc" id="L529">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L530">    }</span>

    @Test
    @DisplayName(&quot;rechazarSolicitud - elimina usuario pendiente&quot;)
    void rechazarSolicitud_eliminaUsuarioPendiente() {
        // ARRANGE
<span class="fc" id="L536">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L537">        doNothing().when(notificacionService).notificarUsuarioRechazado(anyLong());</span>
<span class="fc" id="L538">        doNothing().when(usuarioRepository).delete(any(Usuario.class));</span>
        
        // ACT
<span class="fc" id="L541">        usuarioService.rechazarSolicitud(1);</span>
        
        // ASSERT
<span class="fc" id="L544">        verify(usuarioRepository, times(1)).delete(any(Usuario.class));</span>
<span class="fc" id="L545">        verify(notificacionService, times(1)).notificarUsuarioRechazado(1L);</span>
<span class="fc" id="L546">    }</span>

    @Test
    @DisplayName(&quot;rechazarSolicitud - lanza excepción si usuario no está pendiente&quot;)
    void rechazarSolicitud_usuarioNoEsPendiente_lanzaExcepcion() {
        // ARRANGE
<span class="fc" id="L552">        analista.setEstado(EstadoUsuario.ACTIVO);</span>
<span class="fc" id="L553">        when(usuarioRepository.findById(2)).thenReturn(Optional.of(analista));</span>
        
        // ACT &amp; ASSERT
<span class="fc" id="L556">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L557">            usuarioService.rechazarSolicitud(2);</span>
<span class="nc" id="L558">        });</span>
        
<span class="fc" id="L560">        assertTrue(exception.getMessage().contains(&quot;PENDIENTE&quot;));</span>
<span class="fc" id="L561">        verify(usuarioRepository, never()).delete(any(Usuario.class));</span>
<span class="fc" id="L562">    }</span>

    @Test
    @DisplayName(&quot;obtenerUsuarioActual - retorna usuario autenticado&quot;)
    void obtenerUsuarioActual_retornaUsuarioAutenticado() {
        // Este método es privado, pero podemos probarlo indirectamente a través de actualizarPerfil
<span class="fc" id="L568">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L569">        request.setNombres(&quot;Nuevo Nombre&quot;);</span>
        
<span class="fc" id="L571">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L572">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L573">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L575">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L576">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L577">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L578">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L579">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            // ACT - esto internamente llama a obtenerUsuarioActual()
<span class="fc" id="L582">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            // ASSERT
<span class="fc" id="L585">            assertNotNull(resultado);</span>
<span class="fc" id="L586">            verify(usuarioRepository, times(1)).findByNombre(&quot;jperez&quot;);</span>
        }
<span class="fc" id="L588">    }</span>

    @Test
    @DisplayName(&quot;crearAdminPredeterminado - crea admin con 2FA&quot;)
    void crearAdminPredeterminado_creaAdminConExito() {
        // ARRANGE
<span class="fc" id="L594">        when(usuarioRepository.existsByRol(Rol.ADMIN)).thenReturn(false);</span>
<span class="fc" id="L595">        when(totpService.generateSecret()).thenReturn(&quot;SECRET123&quot;);</span>
<span class="fc" id="L596">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; {</span>
<span class="fc" id="L597">            Usuario u = invocation.getArgument(0);</span>
<span class="fc" id="L598">            u.setUsuarioID(1);</span>
<span class="fc" id="L599">            return u;</span>
        });
        
        // ACT
<span class="fc" id="L603">        UsuarioDTO resultado = usuarioService.crearAdminPredeterminado();</span>
        
        // ASSERT
<span class="fc" id="L606">        assertNotNull(resultado);</span>
<span class="fc" id="L607">        verify(usuarioRepository, times(1)).existsByRol(Rol.ADMIN);</span>
<span class="fc" id="L608">        verify(totpService, times(1)).generateSecret();</span>
<span class="fc" id="L609">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L610">    }</span>

    @Test
    @DisplayName(&quot;crearAdminPredeterminado - lanza excepción si ya existe admin&quot;)
    void crearAdminPredeterminado_yaExisteAdmin_lanzaExcepcion() {
        // ARRANGE
<span class="fc" id="L616">        when(usuarioRepository.existsByRol(Rol.ADMIN)).thenReturn(true);</span>
        
        // ACT &amp; ASSERT
<span class="fc" id="L619">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L620">            usuarioService.crearAdminPredeterminado();</span>
<span class="nc" id="L621">        });</span>
        
<span class="fc" id="L623">        assertTrue(exception.getMessage().contains(&quot;Ya existe un administrador&quot;));</span>
<span class="fc" id="L624">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L625">    }</span>

    @Test
    @DisplayName(&quot;guardar - guarda usuario correctamente&quot;)
    void guardar_guardaUsuarioCorrectamente() {
        // ARRANGE
<span class="fc" id="L631">        Usuario usuarioAGuardar = new Usuario();</span>
<span class="fc" id="L632">        usuarioAGuardar.setNombre(&quot;newuser&quot;);</span>
<span class="fc" id="L633">        usuarioAGuardar.setEmail(&quot;newuser@example.com&quot;);</span>
        
<span class="fc" id="L635">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; {</span>
<span class="fc" id="L636">            Usuario u = invocation.getArgument(0);</span>
<span class="fc" id="L637">            u.setUsuarioID(10);</span>
<span class="fc" id="L638">            return u;</span>
        });
        
        // ACT
<span class="fc" id="L642">        Usuario resultado = usuarioService.guardar(usuarioAGuardar);</span>
        
        // ASSERT
<span class="fc" id="L645">        assertNotNull(resultado);</span>
<span class="fc" id="L646">        assertEquals(10, resultado.getUsuarioID());</span>
<span class="fc" id="L647">        verify(usuarioRepository, times(1)).save(usuarioAGuardar);</span>
<span class="fc" id="L648">    }</span>

    @Test
    @DisplayName(&quot;buscarPorEmail - encuentra usuario por email&quot;)
    void buscarPorEmail_encuentraUsuario() {
        // ARRANGE
<span class="fc" id="L654">        String email = &quot;jperez@example.com&quot;;</span>
<span class="fc" id="L655">        usuario.setEmail(email);</span>
<span class="fc" id="L656">        when(usuarioRepository.findByEmail(email)).thenReturn(Optional.of(usuario));</span>
        
        // ACT
<span class="fc" id="L659">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorEmail(email);</span>
        
        // ASSERT
<span class="fc" id="L662">        assertTrue(resultado.isPresent());</span>
<span class="fc" id="L663">        assertEquals(email, resultado.get().getEmail());</span>
<span class="fc" id="L664">        verify(usuarioRepository, times(1)).findByEmail(email);</span>
<span class="fc" id="L665">    }</span>

    @Test
    @DisplayName(&quot;buscarPorEmail - retorna empty si no encuentra usuario&quot;)
    void buscarPorEmail_noEncuentraUsuario() {
        // ARRANGE
<span class="fc" id="L671">        String email = &quot;noexiste@example.com&quot;;</span>
<span class="fc" id="L672">        when(usuarioRepository.findByEmail(email)).thenReturn(Optional.empty());</span>
        
        // ACT
<span class="fc" id="L675">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorEmail(email);</span>
        
        // ASSERT
<span class="fc" id="L678">        assertFalse(resultado.isPresent());</span>
<span class="fc" id="L679">        verify(usuarioRepository, times(1)).findByEmail(email);</span>
<span class="fc" id="L680">    }</span>

    @Test
    @DisplayName(&quot;obtenerPerfil - retorna perfil del usuario autenticado&quot;)
    void obtenerPerfil_retornaPerfilUsuarioActual() {
        // ARRANGE
<span class="fc" id="L686">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L687">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L688">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L690">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L691">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L692">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L693">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuario));</span>
            
            // ACT
<span class="fc" id="L696">            UsuarioDTO resultado = usuarioService.obtenerPerfil();</span>
            
            // ASSERT
<span class="fc" id="L699">            assertNotNull(resultado);</span>
<span class="fc" id="L700">            verify(usuarioRepository, times(1)).findByNombre(&quot;jperez&quot;);</span>
        }
<span class="fc" id="L702">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - actualiza email correctamente&quot;)
    void actualizarPerfil_actualizaEmailCorrectamente() {
        // ARRANGE
<span class="fc" id="L708">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L709">        request.setEmail(&quot;nuevo.email@example.com&quot;);</span>
        
<span class="fc" id="L711">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L712">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L713">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L714">        usuarioActual.setEmail(&quot;viejo@example.com&quot;);</span>
        
<span class="fc" id="L716">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L717">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L718">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L720">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L721">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L722">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L723">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L724">            when(usuarioRepository.findByEmailIgnoreCase(&quot;nuevo.email@example.com&quot;)).thenReturn(Optional.empty());</span>
<span class="fc" id="L725">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            // ACT
<span class="fc" id="L728">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            // ASSERT
<span class="fc" id="L731">            assertNotNull(resultado);</span>
<span class="fc" id="L732">            verify(usuarioRepository, times(1)).findByEmailIgnoreCase(&quot;nuevo.email@example.com&quot;);</span>
<span class="fc" id="L733">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L735">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - lanza excepción si email ya existe&quot;)
    void actualizarPerfil_emailYaExiste_lanzaExcepcion() {
        // ARRANGE
<span class="fc" id="L741">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L742">        request.setEmail(&quot;existente@example.com&quot;);</span>
        
<span class="fc" id="L744">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L745">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L746">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L747">        usuarioActual.setEmail(&quot;viejo@example.com&quot;);</span>
        
<span class="fc" id="L749">        Usuario otroUsuario = new Usuario();</span>
<span class="fc" id="L750">        otroUsuario.setUsuarioID(2);</span>
<span class="fc" id="L751">        otroUsuario.setEmail(&quot;existente@example.com&quot;);</span>
        
<span class="fc" id="L753">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L754">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L755">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L757">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L758">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L759">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L760">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L761">            when(usuarioRepository.findByEmailIgnoreCase(&quot;existente@example.com&quot;)).thenReturn(Optional.of(otroUsuario));</span>
            
            // ACT &amp; ASSERT
<span class="fc" id="L764">            RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L765">                usuarioService.actualizarPerfil(request);</span>
<span class="nc" id="L766">            });</span>
            
<span class="fc" id="L768">            assertTrue(exception.getMessage().contains(&quot;email ya está en uso&quot;));</span>
<span class="fc" id="L769">            verify(usuarioRepository, never()).save(any(Usuario.class));</span>
        }
<span class="fc" id="L771">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - actualiza nombre de usuario correctamente&quot;)
    void actualizarPerfil_actualizaNombreUsuarioCorrectamente() {
        // ARRANGE
<span class="fc" id="L777">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L778">        request.setNombre(&quot;nuevousuario&quot;);</span>
        
<span class="fc" id="L780">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L781">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L782">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
        
<span class="fc" id="L784">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L785">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L786">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L788">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L789">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L790">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L791">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L792">            when(usuarioRepository.findByNombreIgnoreCase(&quot;nuevousuario&quot;)).thenReturn(Optional.empty());</span>
<span class="fc" id="L793">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            // ACT
<span class="fc" id="L796">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            // ASSERT
<span class="fc" id="L799">            assertNotNull(resultado);</span>
<span class="fc" id="L800">            verify(usuarioRepository, times(1)).findByNombreIgnoreCase(&quot;nuevousuario&quot;);</span>
<span class="fc" id="L801">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L803">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - lanza excepción si nombre de usuario ya existe&quot;)
    void actualizarPerfil_nombreUsuarioYaExiste_lanzaExcepcion() {
        // ARRANGE
<span class="fc" id="L809">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L810">        request.setNombre(&quot;usuarioexistente&quot;);</span>
        
<span class="fc" id="L812">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L813">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L814">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
        
<span class="fc" id="L816">        Usuario otroUsuario = new Usuario();</span>
<span class="fc" id="L817">        otroUsuario.setUsuarioID(2);</span>
<span class="fc" id="L818">        otroUsuario.setNombre(&quot;usuarioexistente&quot;);</span>
        
<span class="fc" id="L820">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L821">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L822">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L824">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L825">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L826">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L827">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L828">            when(usuarioRepository.findByNombreIgnoreCase(&quot;usuarioexistente&quot;)).thenReturn(Optional.of(otroUsuario));</span>
            
            // ACT &amp; ASSERT
<span class="fc" id="L831">            RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L832">                usuarioService.actualizarPerfil(request);</span>
<span class="nc" id="L833">            });</span>
            
<span class="fc" id="L835">            assertTrue(exception.getMessage().contains(&quot;nombre de usuario ya está en uso&quot;));</span>
<span class="fc" id="L836">            verify(usuarioRepository, never()).save(any(Usuario.class));</span>
        }
<span class="fc" id="L838">    }</span>

    @Test
    @DisplayName(&quot;gestionarUsuario - actualiza estado activo/inactivo&quot;)
    void gestionarUsuario_actualizaEstadoActivo() {
        // ARRANGE
<span class="fc" id="L844">        GestionarUsuarioRequestDTO gestionRequest = new GestionarUsuarioRequestDTO();</span>
<span class="fc" id="L845">        gestionRequest.setRol(Rol.ANALISTA);</span>
<span class="fc" id="L846">        gestionRequest.setActivo(false); // Cambiar a inactivo</span>
        
<span class="fc" id="L848">        analista.setActivo(true); // Comienza activo</span>
<span class="fc" id="L849">        when(usuarioRepository.findById(2)).thenReturn(Optional.of(analista));</span>
<span class="fc" id="L850">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        // ACT
<span class="fc" id="L853">        UsuarioDTO resultado = usuarioService.gestionarUsuario(2, gestionRequest);</span>

        // ASSERT
<span class="fc" id="L856">        assertNotNull(resultado);</span>
<span class="fc" id="L857">        verify(usuarioRepository, times(1)).findById(2);</span>
<span class="fc" id="L858">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L859">    }</span>

    @Test
    @DisplayName(&quot;gestionarUsuario - cambia rol del usuario&quot;)
    void gestionarUsuario_cambiaRol() {
        // ARRANGE
<span class="fc" id="L865">        GestionarUsuarioRequestDTO gestionRequest = new GestionarUsuarioRequestDTO();</span>
<span class="fc" id="L866">        gestionRequest.setRol(Rol.ADMIN); // Cambiar de ANALISTA a ADMIN</span>
<span class="fc" id="L867">        gestionRequest.setActivo(true);</span>
        
<span class="fc" id="L869">        analista.setRol(Rol.ANALISTA); // Comienza como ANALISTA</span>
<span class="fc" id="L870">        when(usuarioRepository.findById(2)).thenReturn(Optional.of(analista));</span>
<span class="fc" id="L871">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        // ACT
<span class="fc" id="L874">        UsuarioDTO resultado = usuarioService.gestionarUsuario(2, gestionRequest);</span>

        // ASSERT
<span class="fc" id="L877">        assertNotNull(resultado);</span>
<span class="fc" id="L878">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L879">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>