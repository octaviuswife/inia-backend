<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoteServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">LoteServiceTest.java</span></div><h1>LoteServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PmsRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.GerminacionRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.DosnRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.TetrazolioRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PurezaRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.LoteRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.LoteDTO;

import java.time.LocalDate;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * Tests unitarios para LoteService
 * 
 * ¿Qué estamos testeando?
 * - La lógica de negocio del servicio de lotes
 * - Validaciones y transformaciones de datos
 * - Interacciones con el repositorio
 */
@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de LoteService&quot;)
<span class="fc" id="L38">class LoteServiceTest {</span>

    @Mock
    private LoteRepository loteRepository;

    @Mock
    private PmsRepository pmsRepository;

    @Mock
    private GerminacionRepository germinacionRepository;

    @Mock
    private DosnRepository dosnRepository;

    @Mock
    private TetrazolioRepository tetrazolioRepository;

    @Mock
    private PurezaRepository purezaRepository;

    @InjectMocks
    private LoteService loteService;

    private LoteRequestDTO loteRequestDTO;
    private Lote lote;

    @BeforeEach
    void setUp() {
        // ARRANGE: Preparar datos de prueba que usaremos en varios tests
<span class="fc" id="L67">        loteRequestDTO = new LoteRequestDTO();</span>
<span class="fc" id="L68">        loteRequestDTO.setNomLote(&quot;LOTE-TEST-001&quot;);</span>
<span class="fc" id="L69">        loteRequestDTO.setFechaRecibo(LocalDate.now());</span>
        
<span class="fc" id="L71">        lote = new Lote();</span>
<span class="fc" id="L72">        lote.setLoteID(1L);</span>
<span class="fc" id="L73">        lote.setNomLote(&quot;LOTE-TEST-001&quot;);</span>
<span class="fc" id="L74">        lote.setActivo(true);</span>
<span class="fc" id="L75">    }</span>

    @Test
    @DisplayName(&quot;Crear lote - debe asignar activo=true automáticamente&quot;)
    void crearLote_debeAsignarActivoTrue() {
        // ARRANGE: Configurar el mock para que devuelva el lote cuando se guarde
<span class="fc" id="L81">        when(loteRepository.save(any(Lote.class))).thenReturn(lote);</span>

        // ACT: Ejecutar el método que queremos probar
<span class="fc" id="L84">        LoteDTO resultado = loteService.crearLote(loteRequestDTO);</span>

        // ASSERT: Verificar que el lote se creó correctamente
<span class="fc" id="L87">        assertNotNull(resultado, &quot;El lote creado no debe ser nulo&quot;);</span>
<span class="fc" id="L88">        assertEquals(&quot;LOTE-TEST-001&quot;, resultado.getNomLote(), &quot;El nombre del lote debe coincidir&quot;);</span>
        
        // Verificar que se llamó al método save exactamente 1 vez
<span class="fc" id="L91">        verify(loteRepository, times(1)).save(any(Lote.class));</span>
<span class="fc" id="L92">    }</span>

    @Test
    @DisplayName(&quot;Obtener lote por ID - debe retornar el lote si existe&quot;)
    void obtenerLotePorId_cuandoExiste_debeRetornarLote() {
        // ARRANGE
<span class="fc" id="L98">        when(loteRepository.findByIdWithCultivarAndEspecie(1L)).thenReturn(Optional.of(lote));</span>

        // ACT
<span class="fc" id="L101">        LoteDTO resultado = loteService.obtenerLotePorId(1L);</span>

        // ASSERT
<span class="fc" id="L104">        assertNotNull(resultado);</span>
<span class="fc" id="L105">        assertEquals(1L, resultado.getLoteID());</span>
<span class="fc" id="L106">        assertEquals(&quot;LOTE-TEST-001&quot;, resultado.getNomLote());</span>
<span class="fc" id="L107">        verify(loteRepository, times(1)).findByIdWithCultivarAndEspecie(1L);</span>
<span class="fc" id="L108">    }</span>

    @Test
    @DisplayName(&quot;Obtener lote por ID inexistente - debe lanzar excepción&quot;)
    void obtenerLotePorId_cuandoNoExiste_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L114">        when(loteRepository.findByIdWithCultivarAndEspecie(999L)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L117">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L118">            loteService.obtenerLotePorId(999L);</span>
<span class="nc" id="L119">        }, &quot;Debe lanzar excepción cuando el lote no existe&quot;);</span>

<span class="fc" id="L121">        verify(loteRepository, times(1)).findByIdWithCultivarAndEspecie(999L);</span>
<span class="fc" id="L122">    }</span>

    @Test
    @DisplayName(&quot;Eliminar lote - debe cambiar activo a false&quot;)
    void eliminarLote_debeCambiarActivoAFalse() {
        // ARRANGE
<span class="fc" id="L128">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L129">        when(loteRepository.save(any(Lote.class))).thenReturn(lote);</span>

        // ACT
<span class="fc" id="L132">        loteService.eliminarLote(1L);</span>

        // ASSERT
<span class="fc" id="L135">        verify(loteRepository, times(1)).findById(1L);</span>
<span class="fc" id="L136">        verify(loteRepository, times(1)).save(any(Lote.class));</span>
<span class="fc" id="L137">    }</span>

    @Test
    @DisplayName(&quot;Eliminar lote inexistente - lanza excepción&quot;)
    void eliminarLote_inexistente_lanzaExcepcion() {
<span class="fc" id="L142">        when(loteRepository.findById(99L)).thenReturn(Optional.empty());</span>
<span class="pc" id="L143">        assertThrows(RuntimeException.class, () -&gt; loteService.eliminarLote(99L));</span>
<span class="fc" id="L144">    }</span>

    @Test
    @DisplayName(&quot;Reactivar lote - debe cambiar activo a true&quot;)
    void reactivarLote_debeCambiarActivoATrue() {
        // ARRANGE
<span class="fc" id="L150">        lote.setActivo(false); // Lote inicialmente inactivo</span>
<span class="fc" id="L151">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L152">        when(loteRepository.save(any(Lote.class))).thenReturn(lote);</span>

        // ACT
<span class="fc" id="L155">        LoteDTO resultado = loteService.reactivarLote(1L);</span>

        // ASSERT
<span class="fc" id="L158">        assertNotNull(resultado);</span>
<span class="fc" id="L159">        verify(loteRepository, times(1)).findById(1L);</span>
<span class="fc" id="L160">        verify(loteRepository, times(1)).save(any(Lote.class));</span>
<span class="fc" id="L161">    }</span>

    @Test
    @DisplayName(&quot;Reactivar lote ya activo - lanza excepción&quot;)
    void reactivarLote_yaActivo_lanzaExcepcion() {
<span class="fc" id="L166">        lote.setActivo(true);</span>
<span class="fc" id="L167">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="pc" id="L168">        assertThrows(RuntimeException.class, () -&gt; loteService.reactivarLote(1L));</span>
<span class="fc" id="L169">    }</span>

    @Test
    @DisplayName(&quot;Actualizar lote inactivo - debe lanzar excepción&quot;)
    void actualizarLote_inactivo_lanzaExcepcion() {
<span class="fc" id="L174">        lote.setActivo(false);</span>
<span class="fc" id="L175">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L176">        LoteRequestDTO req = new LoteRequestDTO();</span>
<span class="fc" id="L177">        req.setFechaRecibo(LocalDate.now());</span>
<span class="pc" id="L178">        assertThrows(RuntimeException.class, () -&gt; loteService.actualizarLote(1L, req));</span>
<span class="fc" id="L179">    }</span>

    @Test
    @DisplayName(&quot;Actualizar lote cambiando tipos con análisis existente - bloquea remoción&quot;)
    void actualizarLote_removerTipoNoPermitido_lanza() {
<span class="fc" id="L184">        lote.setActivo(true);</span>
<span class="fc" id="L185">        lote.setTiposAnalisisAsignados(java.util.List.of(utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis.PMS));</span>
<span class="fc" id="L186">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L187">        when(pmsRepository.existsByLoteLoteID(1L)).thenReturn(true);</span>
<span class="fc" id="L188">        LoteRequestDTO req = new LoteRequestDTO();</span>
<span class="fc" id="L189">        req.setTiposAnalisisAsignados(java.util.List.of()); // intentar remover PMS</span>
<span class="fc" id="L190">        req.setFechaRecibo(LocalDate.now());</span>
<span class="pc" id="L191">        assertThrows(RuntimeException.class, () -&gt; loteService.actualizarLote(1L, req));</span>
<span class="fc" id="L192">    }</span>

    @Test
    @DisplayName(&quot;Puede remover tipo analisis cuando no hay análisis creados&quot;)
    void puedeRemoverTipoAnalisis_sinAnalisis_true() {
<span class="fc" id="L197">        when(pmsRepository.existsByLoteLoteID(1L)).thenReturn(false);</span>
<span class="fc" id="L198">        boolean result = loteService.puedeRemoverTipoAnalisis(1L, utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis.PMS);</span>
<span class="fc" id="L199">        assertTrue(result);</span>
<span class="fc" id="L200">    }</span>

    @Test
    @DisplayName(&quot;esLoteElegibleParaTipoAnalisis - requiere activo, tipo asignado y puede crear&quot;)
    void esLoteElegible_paraCrear() {
<span class="fc" id="L205">        lote.setActivo(true);</span>
<span class="fc" id="L206">        lote.setTiposAnalisisAsignados(java.util.List.of(utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis.PMS));</span>
<span class="fc" id="L207">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L208">        when(pmsRepository.existsByLoteLoteID(1L)).thenReturn(false); // permite crear</span>
<span class="fc" id="L209">        assertTrue(loteService.esLoteElegibleParaTipoAnalisis(1L, utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis.PMS));</span>
<span class="fc" id="L210">    }</span>

    @Test
    @DisplayName(&quot;esLoteElegibleParaTipoAnalisis - falso si lote inactivo&quot;)
    void esLoteElegible_inactivo_false() {
<span class="fc" id="L215">        lote.setActivo(false);</span>
<span class="fc" id="L216">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L217">        assertFalse(loteService.esLoteElegibleParaTipoAnalisis(1L, utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis.PMS));</span>
<span class="fc" id="L218">    }</span>

    @Test
    @DisplayName(&quot;contarAnalisisPendientes - cuenta tipos sin análisis&quot;)
    void contarAnalisisPendientes_casos() {
<span class="fc" id="L223">        Lote lote2 = new Lote();</span>
<span class="fc" id="L224">        lote2.setLoteID(2L);</span>
<span class="fc" id="L225">        lote2.setActivo(true);</span>
<span class="fc" id="L226">        lote.setTiposAnalisisAsignados(java.util.List.of(utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis.PMS));</span>
<span class="fc" id="L227">        lote2.setTiposAnalisisAsignados(java.util.List.of(utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis.GERMINACION));</span>
<span class="fc" id="L228">        when(loteRepository.findByActivoTrue()).thenReturn(java.util.List.of(lote, lote2));</span>
<span class="fc" id="L229">        when(pmsRepository.existsByLoteLoteID(1L)).thenReturn(false);</span>
<span class="fc" id="L230">        when(germinacionRepository.existsByLoteLoteID(2L)).thenReturn(false);</span>
<span class="fc" id="L231">        long count = loteService.contarAnalisisPendientes();</span>
<span class="fc" id="L232">        assertEquals(2L, count);</span>
<span class="fc" id="L233">    }</span>

    @Test
    @DisplayName(&quot;obtenerEstadisticasLotes - retorna mapa con claves esperadas&quot;)
    void obtenerEstadisticasLotes_ok() {
<span class="fc" id="L238">        when(loteRepository.count()).thenReturn(10L);</span>
<span class="fc" id="L239">        when(loteRepository.countLotesActivos()).thenReturn(7L);</span>
<span class="fc" id="L240">        when(loteRepository.countLotesInactivos()).thenReturn(3L);</span>
<span class="fc" id="L241">        var stats = loteService.obtenerEstadisticasLotes();</span>
<span class="fc" id="L242">        assertEquals(10L, stats.get(&quot;total&quot;));</span>
<span class="fc" id="L243">        assertEquals(7L, stats.get(&quot;activos&quot;));</span>
<span class="fc" id="L244">        assertEquals(3L, stats.get(&quot;inactivos&quot;));</span>
<span class="fc" id="L245">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>