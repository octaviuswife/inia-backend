<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificacionServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepPmsControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">NotificacionServiceTest.java</span></div><h1>NotificacionServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.*;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.*;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.NotificacionRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.NotificacionDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.EstadoUsuario;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Rol;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoNotificacion;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyInt;
import static org.mockito.Mockito.*;

/**
 * Tests unitarios para NotificacionService
 * 
 * Funcionalidades testeadas:
 * - Creación de notificaciones manuales
 * - Notificaciones automáticas (registro, aprobación, rechazo de usuarios)
 * - Notificaciones de análisis (finalizado, aprobado, a repetir)
 * - Listado de notificaciones
 * - Marcar como leídas
 * - Eliminar notificaciones
 * - Contar notificaciones no leídas
 * - Seguridad de acceso a notificaciones
 */
@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de NotificacionService&quot;)
<span class="fc" id="L50">class NotificacionServiceTest {</span>

    @Mock
    private NotificacionRepository notificacionRepository;

    @Mock
    private UsuarioRepository usuarioRepository;

    @Mock
    private AnalisisRepository analisisRepository;

    @Mock
    private AnalisisHistorialRepository analisisHistorialRepository;

    @Mock
    private NotificationWebSocketService wsService;

    @Mock
    private SecurityContext securityContext;

    @Mock
    private Authentication authentication;

    @InjectMocks
    private NotificacionService notificacionService;

    private Usuario usuarioTest;
    private Usuario adminTest;
    private Lote loteTest;
    private Analisis analisisTest;

    @BeforeEach
    void setUp() {
        // Usuario normal
<span class="fc" id="L84">        usuarioTest = new Usuario();</span>
<span class="fc" id="L85">        usuarioTest.setUsuarioID(1);</span>
<span class="fc" id="L86">        usuarioTest.setNombre(&quot;testuser&quot;);</span>
<span class="fc" id="L87">        usuarioTest.setNombres(&quot;Test&quot;);</span>
<span class="fc" id="L88">        usuarioTest.setApellidos(&quot;User&quot;);</span>
<span class="fc" id="L89">        usuarioTest.setRol(Rol.ANALISTA);</span>
<span class="fc" id="L90">        usuarioTest.setEstado(EstadoUsuario.ACTIVO);</span>

        // Usuario administrador
<span class="fc" id="L93">        adminTest = new Usuario();</span>
<span class="fc" id="L94">        adminTest.setUsuarioID(2);</span>
<span class="fc" id="L95">        adminTest.setNombre(&quot;admin&quot;);</span>
<span class="fc" id="L96">        adminTest.setNombres(&quot;Admin&quot;);</span>
<span class="fc" id="L97">        adminTest.setApellidos(&quot;User&quot;);</span>
<span class="fc" id="L98">        adminTest.setRol(Rol.ADMIN);</span>
<span class="fc" id="L99">        adminTest.setEstado(EstadoUsuario.ACTIVO);</span>

        // Lote de prueba
<span class="fc" id="L102">        loteTest = new Lote();</span>
<span class="fc" id="L103">        loteTest.setLoteID(1L);</span>
<span class="fc" id="L104">        loteTest.setFicha(&quot;LOTE-2024-001&quot;);</span>

        // Análisis de prueba
<span class="fc" id="L107">        analisisTest = new Germinacion();</span>
<span class="fc" id="L108">        analisisTest.setAnalisisID(1L);</span>
<span class="fc" id="L109">        analisisTest.setLote(loteTest);</span>
<span class="fc" id="L110">    }</span>

    @Test
    @DisplayName(&quot;Crear notificación manual - debe crear correctamente&quot;)
    void crearNotificacion_debeCrearCorrectamente() {
        // ARRANGE
<span class="fc" id="L116">        NotificacionRequestDTO request = new NotificacionRequestDTO();</span>
<span class="fc" id="L117">        request.setUsuarioId(1L);</span>
<span class="fc" id="L118">        request.setNombre(&quot;Notificación de prueba&quot;);</span>
<span class="fc" id="L119">        request.setMensaje(&quot;Mensaje de prueba&quot;);</span>
<span class="fc" id="L120">        request.setTipo(TipoNotificacion.USUARIO_REGISTRO);</span>

<span class="fc" id="L122">        Notificacion notificacionGuardada = new Notificacion();</span>
<span class="fc" id="L123">        notificacionGuardada.setId(1L);</span>
<span class="fc" id="L124">        notificacionGuardada.setNombre(request.getNombre());</span>
<span class="fc" id="L125">        notificacionGuardada.setMensaje(request.getMensaje());</span>
<span class="fc" id="L126">        notificacionGuardada.setUsuario(usuarioTest);</span>
<span class="fc" id="L127">        notificacionGuardada.setTipo(request.getTipo());</span>

<span class="fc" id="L129">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuarioTest));</span>
<span class="fc" id="L130">        when(notificacionRepository.save(any(Notificacion.class))).thenReturn(notificacionGuardada);</span>

        // ACT
<span class="fc" id="L133">        NotificacionDTO resultado = notificacionService.crearNotificacion(request);</span>

        // ASSERT
<span class="fc" id="L136">        assertNotNull(resultado);</span>
<span class="fc" id="L137">        assertEquals(&quot;Notificación de prueba&quot;, resultado.getNombre());</span>
<span class="fc" id="L138">        assertEquals(&quot;Mensaje de prueba&quot;, resultado.getMensaje());</span>
<span class="fc" id="L139">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L140">    }</span>

    @Test
    @DisplayName(&quot;Crear notificación - usuario no encontrado debe lanzar excepción&quot;)
    void crearNotificacion_usuarioNoEncontrado_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L146">        NotificacionRequestDTO request = new NotificacionRequestDTO();</span>
<span class="fc" id="L147">        request.setUsuarioId(999L);</span>
<span class="fc" id="L148">        request.setNombre(&quot;Test&quot;);</span>
<span class="fc" id="L149">        request.setMensaje(&quot;Test&quot;);</span>

<span class="fc" id="L151">        when(usuarioRepository.findById(999)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L154">        assertThrows(RuntimeException.class, </span>
<span class="pc" id="L155">            () -&gt; notificacionService.crearNotificacion(request));</span>
<span class="fc" id="L156">        verify(notificacionRepository, never()).save(any(Notificacion.class));</span>
<span class="fc" id="L157">    }</span>

    @Test
    @DisplayName(&quot;Notificar nuevo usuario - debe notificar a todos los administradores&quot;)
    void notificarNuevoUsuario_debeNotificarATodosLosAdministradores() {
        // ARRANGE
<span class="fc" id="L163">        Usuario nuevoUsuario = new Usuario();</span>
<span class="fc" id="L164">        nuevoUsuario.setUsuarioID(3);</span>
<span class="fc" id="L165">        nuevoUsuario.setNombres(&quot;Nuevo&quot;);</span>
<span class="fc" id="L166">        nuevoUsuario.setApellidos(&quot;Usuario&quot;);</span>

<span class="fc" id="L168">        when(usuarioRepository.findById(3)).thenReturn(Optional.of(nuevoUsuario));</span>
<span class="fc" id="L169">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L170">            .thenReturn(Arrays.asList(adminTest, usuarioTest)); // 1 admin, 1 analista</span>
<span class="fc" id="L171">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L172">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L173">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(anyInt()))</span>
<span class="fc" id="L174">            .thenReturn(1L);</span>

        // ACT
<span class="fc" id="L177">        notificacionService.notificarNuevoUsuario(3L);</span>

        // ASSERT
<span class="fc" id="L180">        verify(notificacionRepository, times(1)).save(any(Notificacion.class)); // Solo al admin</span>
<span class="fc" id="L181">        verify(wsService, times(1)).sendToUser(any(), any(NotificacionDTO.class));</span>
<span class="fc" id="L182">    }</span>

    @Test
    @DisplayName(&quot;Notificar usuario aprobado - debe enviar notificación al usuario&quot;)
    void notificarUsuarioAprobado_debeEnviarNotificacionAlUsuario() {
        // ARRANGE
<span class="fc" id="L188">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuarioTest));</span>
<span class="fc" id="L189">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L190">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L191">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L192">            .thenReturn(1L);</span>

        // ACT
<span class="fc" id="L195">        notificacionService.notificarUsuarioAprobado(1L);</span>

        // ASSERT
<span class="fc" id="L198">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L199">        verify(wsService).sendToUser(eq(1), any(NotificacionDTO.class));</span>
<span class="fc" id="L200">        verify(wsService).sendUnreadCount(eq(1), eq(1L));</span>
<span class="fc" id="L201">    }</span>

    @Test
    @DisplayName(&quot;Notificar usuario rechazado - debe enviar notificación al usuario&quot;)
    void notificarUsuarioRechazado_debeEnviarNotificacionAlUsuario() {
        // ARRANGE
<span class="fc" id="L207">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuarioTest));</span>
<span class="fc" id="L208">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L209">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L210">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L211">            .thenReturn(1L);</span>

        // ACT
<span class="fc" id="L214">        notificacionService.notificarUsuarioRechazado(1L);</span>

        // ASSERT
<span class="fc" id="L217">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L218">        verify(wsService).sendToUser(eq(1), any(NotificacionDTO.class));</span>
<span class="fc" id="L219">    }</span>

    @Test
    @DisplayName(&quot;Notificar análisis finalizado - debe notificar a todos los administradores&quot;)
    void notificarAnalisisFinalizado_debeNotificarATodosLosAdministradores() {
        // ARRANGE
<span class="fc" id="L225">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L226">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L227">            .thenReturn(Collections.singletonList(adminTest));</span>
<span class="fc" id="L228">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L229">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L230">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(2))</span>
<span class="fc" id="L231">            .thenReturn(1L);</span>

        // ACT
<span class="fc" id="L234">        notificacionService.notificarAnalisisFinalizado(1L);</span>

        // ASSERT
<span class="fc" id="L237">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L238">        verify(wsService).sendToUser(eq(2), any(NotificacionDTO.class));</span>
<span class="fc" id="L239">    }</span>

    @Test
    @DisplayName(&quot;Obtener notificaciones por usuario - debe retornar página de notificaciones&quot;)
    void obtenerNotificacionesPorUsuario_debeRetornarPagina() {
        // ARRANGE
<span class="fc" id="L245">        Pageable pageable = PageRequest.of(0, 10);</span>
        
<span class="fc" id="L247">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L248">        notif1.setId(1L);</span>
<span class="fc" id="L249">        notif1.setNombre(&quot;Notificación 1&quot;);</span>
<span class="fc" id="L250">        notif1.setMensaje(&quot;Mensaje 1&quot;);</span>
<span class="fc" id="L251">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L252">        notif1.setLeido(false);</span>
<span class="fc" id="L253">        notif1.setActivo(true);</span>
<span class="fc" id="L254">        notif1.setTipo(TipoNotificacion.USUARIO_APROBADO);</span>

<span class="fc" id="L256">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L257">        notif2.setId(2L);</span>
<span class="fc" id="L258">        notif2.setNombre(&quot;Notificación 2&quot;);</span>
<span class="fc" id="L259">        notif2.setMensaje(&quot;Mensaje 2&quot;);</span>
<span class="fc" id="L260">        notif2.setUsuario(usuarioTest);</span>
<span class="fc" id="L261">        notif2.setLeido(true);</span>
<span class="fc" id="L262">        notif2.setActivo(true);</span>
<span class="fc" id="L263">        notif2.setTipo(TipoNotificacion.ANALISIS_APROBADO);</span>

<span class="fc" id="L265">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Arrays.asList(notif1, notif2));</span>

<span class="fc" id="L267">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L268">            .thenReturn(page);</span>

        // ACT
<span class="fc" id="L271">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesPorUsuario(1L, pageable);</span>

        // ASSERT
<span class="fc" id="L274">        assertNotNull(resultado);</span>
<span class="fc" id="L275">        assertEquals(2, resultado.getContent().size());</span>
<span class="fc" id="L276">        assertEquals(&quot;Notificación 1&quot;, resultado.getContent().get(0).getNombre());</span>
<span class="fc" id="L277">    }</span>

    @Test
    @DisplayName(&quot;Obtener notificaciones no leídas - debe retornar solo las no leídas&quot;)
    void obtenerNotificacionesNoLeidas_debeRetornarSoloNoLeidas() {
        // ARRANGE
<span class="fc" id="L283">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L284">        notif1.setId(1L);</span>
<span class="fc" id="L285">        notif1.setNombre(&quot;No leída 1&quot;);</span>
<span class="fc" id="L286">        notif1.setMensaje(&quot;Mensaje 1&quot;);</span>
<span class="fc" id="L287">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L288">        notif1.setLeido(false);</span>
<span class="fc" id="L289">        notif1.setActivo(true);</span>
<span class="fc" id="L290">        notif1.setTipo(TipoNotificacion.USUARIO_APROBADO);</span>

<span class="fc" id="L292">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrueOrderByFechaCreacionDesc(1))</span>
<span class="fc" id="L293">            .thenReturn(Collections.singletonList(notif1));</span>

        // ACT
<span class="fc" id="L296">        List&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesNoLeidas(1L);</span>

        // ASSERT
<span class="fc" id="L299">        assertNotNull(resultado);</span>
<span class="fc" id="L300">        assertEquals(1, resultado.size());</span>
<span class="fc" id="L301">        assertEquals(&quot;No leída 1&quot;, resultado.get(0).getNombre());</span>
<span class="fc" id="L302">        assertFalse(resultado.get(0).getLeido());</span>
<span class="fc" id="L303">    }</span>

    @Test
    @DisplayName(&quot;Marcar como leída - debe actualizar el estado&quot;)
    void marcarComoLeida_debeActualizarEstado() {
        // ARRANGE
<span class="fc" id="L309">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L310">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L311">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L312">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L314">        Notificacion notificacion = new Notificacion();</span>
<span class="fc" id="L315">        notificacion.setId(1L);</span>
<span class="fc" id="L316">        notificacion.setNombre(&quot;Test&quot;);</span>
<span class="fc" id="L317">        notificacion.setMensaje(&quot;Mensaje&quot;);</span>
<span class="fc" id="L318">        notificacion.setUsuario(usuarioTest);</span>
<span class="fc" id="L319">        notificacion.setLeido(false);</span>
<span class="fc" id="L320">        notificacion.setActivo(true);</span>
<span class="fc" id="L321">        notificacion.setTipo(TipoNotificacion.USUARIO_APROBADO);</span>

<span class="fc" id="L323">        when(notificacionRepository.findById(1L)).thenReturn(Optional.of(notificacion));</span>
<span class="fc" id="L324">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L325">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        // ACT
<span class="fc" id="L328">        NotificacionDTO resultado = notificacionService.marcarComoLeida(1L);</span>

        // ASSERT
<span class="fc" id="L331">        assertNotNull(resultado);</span>
<span class="fc" id="L332">        assertTrue(notificacion.getLeido());</span>
<span class="fc" id="L333">        verify(notificacionRepository).save(notificacion);</span>
<span class="fc" id="L334">    }</span>

    @Test
    @DisplayName(&quot;Marcar todas como leídas - debe actualizar todas las notificaciones&quot;)
    void marcarTodasComoLeidas_debeActualizarTodas() {
        // ARRANGE
<span class="fc" id="L340">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L341">        notif1.setLeido(false);</span>
        
<span class="fc" id="L343">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L344">        notif2.setLeido(false);</span>

<span class="fc" id="L346">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L347">            .thenReturn(Arrays.asList(notif1, notif2));</span>

        // ACT
<span class="fc" id="L350">        notificacionService.marcarTodasComoLeidas(1L);</span>

        // ASSERT
<span class="fc" id="L353">        assertTrue(notif1.getLeido());</span>
<span class="fc" id="L354">        assertTrue(notif2.getLeido());</span>
<span class="fc" id="L355">        verify(notificacionRepository).saveAll(any());</span>
<span class="fc" id="L356">    }</span>

    @Test
    @DisplayName(&quot;Eliminar notificación - debe marcar como inactiva&quot;)
    void eliminarNotificacion_debeMarcarComoInactiva() {
        // ARRANGE
<span class="fc" id="L362">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L363">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L364">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L365">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L367">        Notificacion notificacion = new Notificacion();</span>
<span class="fc" id="L368">        notificacion.setId(1L);</span>
<span class="fc" id="L369">        notificacion.setUsuario(usuarioTest);</span>
<span class="fc" id="L370">        notificacion.setActivo(true);</span>

<span class="fc" id="L372">        when(notificacionRepository.findById(1L)).thenReturn(Optional.of(notificacion));</span>

        // ACT
<span class="fc" id="L375">        notificacionService.eliminarNotificacion(1L);</span>

        // ASSERT
<span class="fc" id="L378">        assertFalse(notificacion.getActivo());</span>
<span class="fc" id="L379">        verify(notificacionRepository).save(notificacion);</span>
<span class="fc" id="L380">    }</span>

    @Test
    @DisplayName(&quot;Contar notificaciones no leídas - debe retornar cantidad correcta&quot;)
    void contarNotificacionesNoLeidas_debeRetornarCantidadCorrecta() {
        // ARRANGE
<span class="fc" id="L386">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L387">            .thenReturn(5L);</span>

        // ACT
<span class="fc" id="L390">        Long count = notificacionService.contarNotificacionesNoLeidas(1L);</span>

        // ASSERT
<span class="fc" id="L393">        assertEquals(5L, count);</span>
<span class="fc" id="L394">    }</span>

    @Test
    @DisplayName(&quot;Eliminar notificación de otro usuario - debe lanzar excepción&quot;)
    void eliminarNotificacion_deOtroUsuario_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L400">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L401">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L402">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L403">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L405">        Usuario otroUsuario = new Usuario();</span>
<span class="fc" id="L406">        otroUsuario.setUsuarioID(2);</span>
<span class="fc" id="L407">        otroUsuario.setRol(Rol.ANALISTA);</span>

<span class="fc" id="L409">        Notificacion notificacion = new Notificacion();</span>
<span class="fc" id="L410">        notificacion.setId(1L);</span>
<span class="fc" id="L411">        notificacion.setUsuario(otroUsuario);</span>
<span class="fc" id="L412">        notificacion.setActivo(true);</span>

<span class="fc" id="L414">        when(notificacionRepository.findById(1L)).thenReturn(Optional.of(notificacion));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L417">        assertThrows(RuntimeException.class, </span>
<span class="pc" id="L418">            () -&gt; notificacionService.eliminarNotificacion(1L));</span>
<span class="fc" id="L419">        verify(notificacionRepository, never()).save(any(Notificacion.class));</span>
<span class="fc" id="L420">    }</span>

    // ========== TESTS PARA NOTIFICACIONES DE ANÁLISIS ==========

    @Test
    @DisplayName(&quot;notificarAnalisisAprobado - debe notificar a usuarios involucrados (no admins)&quot;)
    void notificarAnalisisAprobado_debeNotificarAUsuariosInvolucrados() {
        // ARRANGE
<span class="fc" id="L428">        AnalisisHistorial historial1 = new AnalisisHistorial();</span>
<span class="fc" id="L429">        historial1.setUsuario(usuarioTest); // Analista</span>
        
<span class="fc" id="L431">        AnalisisHistorial historial2 = new AnalisisHistorial();</span>
<span class="fc" id="L432">        historial2.setUsuario(adminTest); // Admin (debe ser excluido)</span>

<span class="fc" id="L434">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(1L))</span>
<span class="fc" id="L435">            .thenReturn(Arrays.asList(historial1, historial2));</span>
<span class="fc" id="L436">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L437">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L438">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L439">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L440">            .thenReturn(1L);</span>

        // ACT
<span class="fc" id="L443">        notificacionService.notificarAnalisisAprobado(1L);</span>

        // ASSERT
<span class="fc" id="L446">        verify(notificacionRepository, times(1)).save(argThat(notif -&gt; </span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">            notif.getNombre().equals(&quot;Análisis aprobado&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">            notif.getUsuario().equals(usuarioTest) &amp;&amp;</span>
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">            notif.getAnalisisId().equals(1L) &amp;&amp;</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">            notif.getTipo() == TipoNotificacion.ANALISIS_APROBADO</span>
        ));
<span class="fc" id="L452">        verify(wsService, times(1)).sendToUser(eq(1), any(NotificacionDTO.class));</span>
<span class="fc" id="L453">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisAprobado - sin usuarios involucrados no debe crear notificaciones&quot;)
    void notificarAnalisisAprobado_sinUsuariosInvolucrados_noDebeCrearNotificaciones() {
        // ARRANGE
<span class="fc" id="L459">        AnalisisHistorial historial1 = new AnalisisHistorial();</span>
<span class="fc" id="L460">        historial1.setUsuario(adminTest); // Solo admin</span>

<span class="fc" id="L462">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(1L))</span>
<span class="fc" id="L463">            .thenReturn(Collections.singletonList(historial1));</span>
<span class="fc" id="L464">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>

        // ACT
<span class="fc" id="L467">        notificacionService.notificarAnalisisAprobado(1L);</span>

        // ASSERT
<span class="fc" id="L470">        verify(notificacionRepository, never()).save(any(Notificacion.class));</span>
<span class="fc" id="L471">        verify(wsService, never()).sendToUser(any(), any(NotificacionDTO.class));</span>
<span class="fc" id="L472">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisRepetir - debe notificar a usuarios involucrados&quot;)
    void notificarAnalisisRepetir_debeNotificarAUsuariosInvolucrados() {
        // ARRANGE
<span class="fc" id="L478">        Usuario analista2 = new Usuario();</span>
<span class="fc" id="L479">        analista2.setUsuarioID(3);</span>
<span class="fc" id="L480">        analista2.setNombres(&quot;Analista&quot;);</span>
<span class="fc" id="L481">        analista2.setApellidos(&quot;Dos&quot;);</span>
<span class="fc" id="L482">        analista2.setRol(Rol.ANALISTA);</span>

<span class="fc" id="L484">        AnalisisHistorial historial1 = new AnalisisHistorial();</span>
<span class="fc" id="L485">        historial1.setUsuario(usuarioTest);</span>
        
<span class="fc" id="L487">        AnalisisHistorial historial2 = new AnalisisHistorial();</span>
<span class="fc" id="L488">        historial2.setUsuario(analista2);</span>
        
<span class="fc" id="L490">        AnalisisHistorial historial3 = new AnalisisHistorial();</span>
<span class="fc" id="L491">        historial3.setUsuario(usuarioTest); // Duplicado, debe filtrar</span>

<span class="fc" id="L493">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(1L))</span>
<span class="fc" id="L494">            .thenReturn(Arrays.asList(historial1, historial2, historial3));</span>
<span class="fc" id="L495">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L496">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L497">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L498">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(anyInt()))</span>
<span class="fc" id="L499">            .thenReturn(1L);</span>

        // ACT
<span class="fc" id="L502">        notificacionService.notificarAnalisisRepetir(1L);</span>

        // ASSERT
<span class="fc" id="L505">        verify(notificacionRepository, times(2)).save(argThat(notif -&gt; </span>
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">            notif.getNombre().equals(&quot;Análisis marcado para repetir&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">            notif.getTipo() == TipoNotificacion.ANALISIS_REPETIR</span>
        ));
<span class="fc" id="L509">        verify(wsService, times(2)).sendToUser(any(), any(NotificacionDTO.class));</span>
<span class="fc" id="L510">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisPendienteAprobacion - debe notificar a todos los admins&quot;)
    void notificarAnalisisPendienteAprobacion_debeNotificarATodosLosAdmins() {
        // ARRANGE
<span class="fc" id="L516">        Usuario admin2 = new Usuario();</span>
<span class="fc" id="L517">        admin2.setUsuarioID(3);</span>
<span class="fc" id="L518">        admin2.setNombres(&quot;Admin&quot;);</span>
<span class="fc" id="L519">        admin2.setApellidos(&quot;Dos&quot;);</span>
<span class="fc" id="L520">        admin2.setRol(Rol.ADMIN);</span>
<span class="fc" id="L521">        admin2.setEstado(EstadoUsuario.ACTIVO);</span>

<span class="fc" id="L523">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L524">            .thenReturn(Arrays.asList(adminTest, admin2, usuarioTest)); // 2 admins, 1 analista</span>
<span class="fc" id="L525">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L526">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L527">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        // ACT
<span class="fc" id="L530">        notificacionService.notificarAnalisisPendienteAprobacion(1L);</span>

        // ASSERT
<span class="fc" id="L533">        verify(notificacionRepository, times(2)).save(argThat(notif -&gt; </span>
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">            notif.getNombre().equals(&quot;Análisis modificado - Requiere nueva aprobación&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">            notif.getMensaje().contains(&quot;ha sido modificado y requiere nueva aprobación&quot;)</span>
        ));
<span class="fc" id="L537">    }</span>

    // ========== TESTS PARA MÉTODOS CON VALIDACIÓN DE ACCESO ==========

    @Test
    @DisplayName(&quot;validarAccesoANotificaciones - admin puede acceder a cualquier usuario&quot;)
    void validarAccesoANotificaciones_adminPuedeAccederACualquierUsuario() {
        // ARRANGE
<span class="fc" id="L545">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L546">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L547">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L548">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>

<span class="fc" id="L550">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L551">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Collections.emptyList());</span>

<span class="fc" id="L553">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L554">            .thenReturn(page);</span>

        // ACT
<span class="fc" id="L557">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesPorUsuarioConValidacion(1L, pageable);</span>

        // ASSERT
<span class="fc" id="L560">        assertNotNull(resultado);</span>
<span class="fc" id="L561">        verify(notificacionRepository).findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable);</span>
<span class="fc" id="L562">    }</span>

    @Test
    @DisplayName(&quot;validarAccesoANotificaciones - usuario normal solo puede acceder a sus propias notificaciones&quot;)
    void validarAccesoANotificaciones_usuarioNormalSoloPuedeAccederASusPropias() {
        // ARRANGE
<span class="fc" id="L568">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L569">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L570">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L571">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L573">        Pageable pageable = PageRequest.of(0, 10);</span>

        // ACT &amp; ASSERT - Intentar acceder a notificaciones de otro usuario (ID 2)
<span class="fc" id="L576">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L577">            notificacionService.obtenerNotificacionesPorUsuarioConValidacion(2L, pageable));</span>
<span class="fc" id="L578">    }</span>

    @Test
    @DisplayName(&quot;obtenerMisNotificaciones - debe retornar notificaciones del usuario autenticado&quot;)
    void obtenerMisNotificaciones_debeRetornarNotificacionesDelUsuarioAutenticado() {
        // ARRANGE
<span class="fc" id="L584">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L585">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L586">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L587">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L589">        Pageable pageable = PageRequest.of(0, 10);</span>
        
<span class="fc" id="L591">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L592">        notif1.setId(1L);</span>
<span class="fc" id="L593">        notif1.setNombre(&quot;Mi notificación 1&quot;);</span>
<span class="fc" id="L594">        notif1.setMensaje(&quot;Mensaje 1&quot;);</span>
<span class="fc" id="L595">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L596">        notif1.setLeido(false);</span>
<span class="fc" id="L597">        notif1.setActivo(true);</span>
<span class="fc" id="L598">        notif1.setTipo(TipoNotificacion.ANALISIS_APROBADO);</span>

<span class="fc" id="L600">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Collections.singletonList(notif1));</span>

<span class="fc" id="L602">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L603">            .thenReturn(page);</span>

        // ACT
<span class="fc" id="L606">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerMisNotificaciones(pageable);</span>

        // ASSERT
<span class="fc" id="L609">        assertNotNull(resultado);</span>
<span class="fc" id="L610">        assertEquals(1, resultado.getContent().size());</span>
<span class="fc" id="L611">        assertEquals(&quot;Mi notificación 1&quot;, resultado.getContent().get(0).getNombre());</span>
<span class="fc" id="L612">        verify(notificacionRepository).findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable);</span>
<span class="fc" id="L613">    }</span>

    @Test
    @DisplayName(&quot;marcarTodasMisNotificacionesComoLeidas - debe marcar todas del usuario autenticado&quot;)
    void marcarTodasMisNotificacionesComoLeidas_debeMarcaTodasDelUsuarioAutenticado() {
        // ARRANGE
<span class="fc" id="L619">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L620">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L621">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L622">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L624">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L625">        notif1.setLeido(false);</span>
        
<span class="fc" id="L627">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L628">        notif2.setLeido(false);</span>

<span class="fc" id="L630">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L631">            .thenReturn(Arrays.asList(notif1, notif2));</span>

        // ACT
<span class="fc" id="L634">        notificacionService.marcarTodasMisNotificacionesComoLeidas();</span>

        // ASSERT
<span class="fc" id="L637">        assertTrue(notif1.getLeido());</span>
<span class="fc" id="L638">        assertTrue(notif2.getLeido());</span>
<span class="fc" id="L639">        verify(notificacionRepository).saveAll(any());</span>
<span class="fc" id="L640">    }</span>

    @Test
    @DisplayName(&quot;obtenerNotificacionesPorUsuarioConValidacion - debe validar y retornar notificaciones&quot;)
    void obtenerNotificacionesPorUsuarioConValidacion_debeValidarYRetornar() {
        // ARRANGE
<span class="fc" id="L646">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L647">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L648">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L649">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L651">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L652">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Collections.emptyList());</span>

<span class="fc" id="L654">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L655">            .thenReturn(page);</span>

        // ACT
<span class="fc" id="L658">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesPorUsuarioConValidacion(1L, pageable);</span>

        // ASSERT
<span class="fc" id="L661">        assertNotNull(resultado);</span>
<span class="fc" id="L662">        verify(notificacionRepository).findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable);</span>
<span class="fc" id="L663">    }</span>

    @Test
    @DisplayName(&quot;contarMisNotificacionesNoLeidas - debe contar solo del usuario autenticado&quot;)
    void contarMisNotificacionesNoLeidas_debeContarSoloDelUsuarioAutenticado() {
        // ARRANGE
<span class="fc" id="L669">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L670">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L671">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L672">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L674">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L675">            .thenReturn(3L);</span>

        // ACT
<span class="fc" id="L678">        Long count = notificacionService.contarMisNotificacionesNoLeidas();</span>

        // ASSERT
<span class="fc" id="L681">        assertEquals(3L, count);</span>
<span class="fc" id="L682">        verify(notificacionRepository).countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1);</span>
<span class="fc" id="L683">    }</span>

    @Test
    @DisplayName(&quot;obtenerNotificacionesNoLeidasConValidacion - debe validar acceso y retornar no leídas&quot;)
    void obtenerNotificacionesNoLeidasConValidacion_debeValidarYRetornar() {
        // ARRANGE
<span class="fc" id="L689">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L690">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L691">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L692">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L694">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L695">        notif1.setId(1L);</span>
<span class="fc" id="L696">        notif1.setNombre(&quot;No leída&quot;);</span>
<span class="fc" id="L697">        notif1.setMensaje(&quot;Mensaje&quot;);</span>
<span class="fc" id="L698">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L699">        notif1.setLeido(false);</span>
<span class="fc" id="L700">        notif1.setActivo(true);</span>
<span class="fc" id="L701">        notif1.setTipo(TipoNotificacion.ANALISIS_APROBADO);</span>

<span class="fc" id="L703">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrueOrderByFechaCreacionDesc(1))</span>
<span class="fc" id="L704">            .thenReturn(Collections.singletonList(notif1));</span>

        // ACT
<span class="fc" id="L707">        List&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesNoLeidasConValidacion(1L);</span>

        // ASSERT
<span class="fc" id="L710">        assertNotNull(resultado);</span>
<span class="fc" id="L711">        assertEquals(1, resultado.size());</span>
<span class="fc" id="L712">        assertFalse(resultado.get(0).getLeido());</span>
<span class="fc" id="L713">    }</span>

    @Test
    @DisplayName(&quot;obtenerNotificacionesNoLeidasConValidacion - usuario sin permisos debe lanzar excepción&quot;)
    void obtenerNotificacionesNoLeidasConValidacion_sinPermisos_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L719">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L720">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L721">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L722">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

        // ACT &amp; ASSERT - Intentar acceder a notificaciones de otro usuario (ID 2)
<span class="fc" id="L725">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L726">            notificacionService.obtenerNotificacionesNoLeidasConValidacion(2L));</span>
<span class="fc" id="L727">    }</span>

    @Test
    @DisplayName(&quot;contarNotificacionesNoLeidasConValidacion - debe validar acceso y contar&quot;)
    void contarNotificacionesNoLeidasConValidacion_debeValidarYContar() {
        // ARRANGE
<span class="fc" id="L733">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L734">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L735">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L736">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>

<span class="fc" id="L738">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L739">            .thenReturn(5L);</span>

        // ACT
<span class="fc" id="L742">        Long count = notificacionService.contarNotificacionesNoLeidasConValidacion(1L);</span>

        // ASSERT
<span class="fc" id="L745">        assertEquals(5L, count);</span>
<span class="fc" id="L746">        verify(notificacionRepository).countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1);</span>
<span class="fc" id="L747">    }</span>

    @Test
    @DisplayName(&quot;contarNotificacionesNoLeidasConValidacion - usuario sin permisos debe lanzar excepción&quot;)
    void contarNotificacionesNoLeidasConValidacion_sinPermisos_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L753">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L754">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L755">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L756">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L759">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L760">            notificacionService.contarNotificacionesNoLeidasConValidacion(2L));</span>
<span class="fc" id="L761">    }</span>

    @Test
    @DisplayName(&quot;marcarTodasComoLeidasConValidacion - debe validar acceso y marcar todas&quot;)
    void marcarTodasComoLeidasConValidacion_debeValidarYMarcarTodas() {
        // ARRANGE
<span class="fc" id="L767">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L768">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L769">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L770">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L772">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L773">        notif1.setLeido(false);</span>
        
<span class="fc" id="L775">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L776">        notif2.setLeido(false);</span>

<span class="fc" id="L778">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L779">            .thenReturn(Arrays.asList(notif1, notif2));</span>

        // ACT
<span class="fc" id="L782">        notificacionService.marcarTodasComoLeidasConValidacion(1L);</span>

        // ASSERT
<span class="fc" id="L785">        assertTrue(notif1.getLeido());</span>
<span class="fc" id="L786">        assertTrue(notif2.getLeido());</span>
<span class="fc" id="L787">        verify(notificacionRepository).saveAll(any());</span>
<span class="fc" id="L788">    }</span>

    @Test
    @DisplayName(&quot;marcarTodasComoLeidasConValidacion - usuario sin permisos debe lanzar excepción&quot;)
    void marcarTodasComoLeidasConValidacion_sinPermisos_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L794">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L795">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L796">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L797">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L800">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L801">            notificacionService.marcarTodasComoLeidasConValidacion(2L));</span>
<span class="fc" id="L802">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisAprobado - análisis no encontrado debe lanzar excepción&quot;)
    void notificarAnalisisAprobado_analisisNoEncontrado_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L808">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(999L))</span>
<span class="fc" id="L809">            .thenReturn(Collections.emptyList());</span>
<span class="fc" id="L810">        when(analisisRepository.findById(999L)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L813">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L814">            notificacionService.notificarAnalisisAprobado(999L));</span>
<span class="fc" id="L815">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisRepetir - análisis no encontrado debe lanzar excepción&quot;)
    void notificarAnalisisRepetir_analisisNoEncontrado_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L821">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(999L))</span>
<span class="fc" id="L822">            .thenReturn(Collections.emptyList());</span>
<span class="fc" id="L823">        when(analisisRepository.findById(999L)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L826">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L827">            notificacionService.notificarAnalisisRepetir(999L));</span>
<span class="fc" id="L828">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisPendienteAprobacion - análisis no encontrado debe lanzar excepción&quot;)
    void notificarAnalisisPendienteAprobacion_analisisNoEncontrado_debeLanzarExcepcion() {
        // ARRANGE
<span class="fc" id="L834">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L835">            .thenReturn(Collections.singletonList(adminTest));</span>
<span class="fc" id="L836">        when(analisisRepository.findById(999L)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L839">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L840">            notificacionService.notificarAnalisisPendienteAprobacion(999L));</span>
<span class="fc" id="L841">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>