<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TablaGermServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">TablaGermServiceTest.java</span></div><h1>TablaGermServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Germinacion;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.RepGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.TablaGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.GerminacionRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.RepGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.TablaGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.ValoresGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PorcentajesRedondeoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.TablaGermRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.TablaGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Instituto;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * Tests unitarios para TablaGermService
 * 
 * Funcionalidades testeadas:
 * - Creación de tablas de germinación
 * - Validación de fechas
 * - Finalización de tablas
 * - Actualización de porcentajes de redondeo
 */
@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de TablaGermService&quot;)
<span class="fc" id="L45">class TablaGermServiceTest {</span>

    @Mock
    private TablaGermRepository tablaGermRepository;

    @Mock
    private GerminacionRepository germinacionRepository;

    @Mock
    private RepGermRepository repGermRepository;

    @Mock
    private ValoresGermRepository valoresGermRepository;

    @Mock
    private AnalisisService analisisService;

    @InjectMocks
    private TablaGermService tablaGermService;

    private Germinacion germinacion;
    private TablaGerm tablaGerm;
    private TablaGermRequestDTO requestDTO;

    @BeforeEach
    void setUp() {
<span class="fc" id="L71">        germinacion = new Germinacion();</span>
<span class="fc" id="L72">        germinacion.setAnalisisID(1L);</span>

<span class="fc" id="L74">        tablaGerm = new TablaGerm();</span>
<span class="fc" id="L75">        tablaGerm.setTablaGermID(15L);</span>
<span class="fc" id="L76">        tablaGerm.setFinalizada(false);</span>
<span class="fc" id="L77">        tablaGerm.setTratamiento(&quot;Agar&quot;);</span>
<span class="fc" id="L78">        tablaGerm.setProductoYDosis(&quot;Sin producto&quot;);</span>
<span class="fc" id="L79">        tablaGerm.setNumSemillasPRep(100);</span>
<span class="fc" id="L80">        tablaGerm.setMetodo(&quot;Entre papel&quot;);</span>
<span class="fc" id="L81">        tablaGerm.setTemperatura(&quot;25&quot;);</span>
<span class="fc" id="L82">        tablaGerm.setTienePrefrio(false);</span>
<span class="fc" id="L83">        tablaGerm.setTienePretratamiento(false);</span>
<span class="fc" id="L84">        tablaGerm.setDiasPrefrio(0);</span>
<span class="fc" id="L85">        tablaGerm.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L86">        tablaGerm.setFechaGerminacion(LocalDate.of(2024, 1, 15));</span>
<span class="fc" id="L87">        tablaGerm.setFechaConteos(Arrays.asList(LocalDate.of(2024, 1, 18), LocalDate.of(2024, 1, 22), LocalDate.of(2024, 1, 25)));</span>
<span class="fc" id="L88">        tablaGerm.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L89">        tablaGerm.setNumDias(&quot;10&quot;);</span>
<span class="fc" id="L90">        tablaGerm.setNumeroRepeticiones(8);</span>
<span class="fc" id="L91">        tablaGerm.setNumeroConteos(3);</span>
<span class="fc" id="L92">        tablaGerm.setGerminacion(germinacion);</span>

<span class="fc" id="L94">        requestDTO = new TablaGermRequestDTO();</span>
<span class="fc" id="L95">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L96">        requestDTO.setTratamiento(&quot;Agar&quot;);</span>
<span class="fc" id="L97">        requestDTO.setProductoYDosis(&quot;Sin producto&quot;);</span>
<span class="fc" id="L98">        requestDTO.setNumSemillasPRep(100);</span>
<span class="fc" id="L99">        requestDTO.setMetodo(&quot;Entre papel&quot;);</span>
<span class="fc" id="L100">        requestDTO.setTemperatura(&quot;25&quot;);</span>
<span class="fc" id="L101">        requestDTO.setTienePrefrio(false);</span>
<span class="fc" id="L102">        requestDTO.setTienePretratamiento(false);</span>
<span class="fc" id="L103">        requestDTO.setDiasPrefrio(0);</span>
<span class="fc" id="L104">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L105">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 15));</span>
<span class="fc" id="L106">        requestDTO.setFechaConteos(Arrays.asList(LocalDate.of(2024, 1, 18), LocalDate.of(2024, 1, 22), LocalDate.of(2024, 1, 25)));</span>
<span class="fc" id="L107">        requestDTO.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L108">        requestDTO.setNumDias(&quot;10&quot;);</span>
<span class="fc" id="L109">        requestDTO.setNumeroRepeticiones(8);</span>
<span class="fc" id="L110">        requestDTO.setNumeroConteos(3);</span>
<span class="fc" id="L111">    }</span>

    @Test
    @DisplayName(&quot;Crear tabla - debe crear exitosamente&quot;)
    void crearTablaGerm_debeCrearExitosamente() {
        // ARRANGE
<span class="fc" id="L117">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>
<span class="fc" id="L118">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>

        // ACT
<span class="fc" id="L121">        TablaGermDTO resultado = tablaGermService.crearTablaGerm(1L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L124">        assertNotNull(resultado);</span>
<span class="fc" id="L125">        assertEquals(15L, resultado.getTablaGermID());</span>
<span class="fc" id="L126">        assertEquals(&quot;Agar&quot;, resultado.getTratamiento());</span>
<span class="fc" id="L127">        verify(tablaGermRepository, times(1)).save(any(TablaGerm.class));</span>
<span class="fc" id="L128">    }</span>

    @Test
    @DisplayName(&quot;Crear tabla - debe lanzar excepción si germinación no existe&quot;)
    void crearTablaGerm_debeLanzarExcepcionSiGerminacionNoExiste() {
        // ARRANGE
<span class="fc" id="L134">        when(germinacionRepository.findById(999L)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L137">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L138">            tablaGermService.crearTablaGerm(999L, requestDTO);</span>
<span class="nc" id="L139">        });</span>
        
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;no encontrada&quot;) || </span>
<span class="pc bnc" id="L142" title="All 2 branches missed.">                   exception.getMessage().contains(&quot;no existe&quot;));</span>
<span class="fc" id="L143">        verify(tablaGermRepository, never()).save(any(TablaGerm.class));</span>
<span class="fc" id="L144">    }</span>

    @Test
    @DisplayName(&quot;Obtener tabla por ID - debe retornar si existe&quot;)
    void obtenerTablaGermPorId_debeRetornarSiExiste() {
        // ARRANGE
<span class="fc" id="L150">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>

        // ACT
<span class="fc" id="L153">        TablaGermDTO resultado = tablaGermService.obtenerTablaGermPorId(15L);</span>

        // ASSERT
<span class="fc" id="L156">        assertNotNull(resultado);</span>
<span class="fc" id="L157">        assertEquals(15L, resultado.getTablaGermID());</span>
<span class="fc" id="L158">        verify(tablaGermRepository, times(1)).findById(15L);</span>
<span class="fc" id="L159">    }</span>

    @Test
    @DisplayName(&quot;Obtener tabla por ID - debe lanzar excepción si no existe&quot;)
    void obtenerTablaGermPorId_debeLanzarExcepcionSiNoExiste() {
        // ARRANGE
<span class="fc" id="L165">        when(tablaGermRepository.findById(999L)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L168">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L169">            tablaGermService.obtenerTablaGermPorId(999L);</span>
<span class="nc" id="L170">        });</span>
        
<span class="fc" id="L172">        assertTrue(exception.getMessage().contains(&quot;no encontrada&quot;));</span>
<span class="fc" id="L173">    }</span>

    @Test
    @DisplayName(&quot;Actualizar tabla - debe actualizar correctamente&quot;)
    void actualizarTablaGerm_debeActualizarCorrectamente() {
        // ARRANGE
<span class="fc" id="L179">        requestDTO.setTemperatura(&quot;28&quot;);</span>
<span class="fc" id="L180">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L181">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L182">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L185">        TablaGermDTO resultado = tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L188">        assertNotNull(resultado);</span>
<span class="fc" id="L189">        verify(tablaGermRepository, times(1)).save(any(TablaGerm.class));</span>
<span class="fc" id="L190">    }</span>

    @Test
    @DisplayName(&quot;Eliminar tabla - debe eliminar correctamente&quot;)
    void eliminarTablaGerm_debeEliminarCorrectamente() {
        // ARRANGE
<span class="fc" id="L196">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L197">        when(valoresGermRepository.findByTablaGermId(15L)).thenReturn(Arrays.asList());</span>
<span class="fc" id="L198">        doNothing().when(tablaGermRepository).deleteById(15L);</span>

        // ACT
<span class="fc" id="L201">        tablaGermService.eliminarTablaGerm(15L);</span>

        // ASSERT
<span class="fc" id="L204">        verify(tablaGermRepository, times(1)).deleteById(15L);</span>
<span class="fc" id="L205">    }</span>

    @Test
    @DisplayName(&quot;Eliminar tabla - debe lanzar excepción si no existe&quot;)
    void eliminarTablaGerm_debeLanzarExcepcionSiNoExiste() {
        // ARRANGE
<span class="fc" id="L211">        when(tablaGermRepository.findById(999L)).thenReturn(Optional.empty());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L214">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L215">            tablaGermService.eliminarTablaGerm(999L);</span>
<span class="nc" id="L216">        });</span>
        
<span class="fc" id="L218">        assertTrue(exception.getMessage().contains(&quot;no encontrada&quot;));</span>
<span class="fc" id="L219">        verify(tablaGermRepository, never()).deleteById(anyLong());</span>
<span class="fc" id="L220">    }</span>

    @Test
    @DisplayName(&quot;Finalizar tabla - debe marcar como finalizada&quot;)
    void finalizarTabla_debMarcarComoFinalizada() {
        // ARRANGE
        // Crear repeticiones mockeadas con conteos completos
<span class="fc" id="L227">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L229">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L230">            rep.setNormales(Arrays.asList(10, 15, 20)); // 3 conteos</span>
<span class="fc" id="L231">            rep.setAnormales(10); // Total de anormales</span>
<span class="fc" id="L232">            rep.setDuras(0);</span>
<span class="fc" id="L233">            rep.setFrescas(0);</span>
<span class="fc" id="L234">            rep.setMuertas(5);</span>
<span class="fc" id="L235">            rep.setTablaGerm(tablaGerm); // Establecer la relación con la tabla</span>
<span class="fc" id="L236">            repeticiones.add(rep);</span>
        }
<span class="fc" id="L238">        tablaGerm.setRepGerm(repeticiones);</span>
        
        // Configurar porcentajes para que estén completos
<span class="fc" id="L241">        tablaGerm.setPorcentajeNormalesConRedondeo(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L242">        tablaGerm.setPorcentajeAnormalesConRedondeo(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L243">        tablaGerm.setPorcentajeDurasConRedondeo(new BigDecimal(&quot;0.0&quot;));</span>
<span class="fc" id="L244">        tablaGerm.setPorcentajeFrescasConRedondeo(new BigDecimal(&quot;0.0&quot;));</span>
<span class="fc" id="L245">        tablaGerm.setPorcentajeMuertasConRedondeo(new BigDecimal(&quot;5.0&quot;));</span>
        
<span class="fc" id="L247">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L248">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>

        // ACT
<span class="fc" id="L251">        TablaGermDTO resultado = tablaGermService.finalizarTabla(15L);</span>

        // ASSERT
<span class="fc" id="L254">        assertNotNull(resultado);</span>
<span class="fc" id="L255">        verify(tablaGermRepository).save(argThat(tabla -&gt; tabla.getFinalizada()));</span>
<span class="fc" id="L256">    }</span>

    @Test
    @DisplayName(&quot;Obtener tablas por germinación - debe retornar lista&quot;)
    void obtenerTablasPorGerminacion_debeRetornarLista() {
        // ARRANGE
<span class="fc" id="L262">        TablaGerm tabla2 = new TablaGerm();</span>
<span class="fc" id="L263">        tabla2.setTablaGermID(16L);</span>
        
<span class="fc" id="L265">        when(tablaGermRepository.findByGerminacionId(1L))</span>
<span class="fc" id="L266">            .thenReturn(Arrays.asList(tablaGerm, tabla2));</span>

        // ACT
<span class="fc" id="L269">        List&lt;TablaGermDTO&gt; resultado = tablaGermService.obtenerTablasPorGerminacion(1L);</span>

        // ASSERT
<span class="fc" id="L272">        assertNotNull(resultado);</span>
<span class="fc" id="L273">        assertEquals(2, resultado.size());</span>
<span class="fc" id="L274">        assertEquals(15L, resultado.get(0).getTablaGermID());</span>
<span class="fc" id="L275">        assertEquals(16L, resultado.get(1).getTablaGermID());</span>
<span class="fc" id="L276">    }</span>

    @Test
    @DisplayName(&quot;Contar tablas por germinación - debe retornar cantidad&quot;)
    void contarTablasPorGerminacion_debeRetornarCantidad() {
        // ARRANGE
<span class="fc" id="L282">        when(tablaGermRepository.countByGerminacionId(1L)).thenReturn(2L);</span>

        // ACT
<span class="fc" id="L285">        Long resultado = tablaGermService.contarTablasPorGerminacion(1L);</span>

        // ASSERT
<span class="fc" id="L288">        assertEquals(2L, resultado);</span>
<span class="fc" id="L289">        verify(tablaGermRepository, times(1)).countByGerminacionId(1L);</span>
<span class="fc" id="L290">    }</span>

    @Test
    @DisplayName(&quot;Puede ingresar porcentajes - debe retornar false si tabla no finalizada&quot;)
    void puedeIngresarPorcentajes_debeRetornarTrueSiTablaFinalizada() {
        // ARRANGE
<span class="fc" id="L296">        tablaGerm.setFinalizada(false); // La tabla en setUp no está finalizada</span>
<span class="fc" id="L297">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>

        // ACT
<span class="fc" id="L300">        Boolean resultado = tablaGermService.puedeIngresarPorcentajes(15L);</span>

        // ASSERT
<span class="fc" id="L303">        assertFalse(resultado); // Debe retornar false porque no está finalizada</span>
<span class="fc" id="L304">    }</span>

    @Test
    @DisplayName(&quot;Actualizar porcentajes - debe actualizar correctamente&quot;)
    void actualizarPorcentajes_debeActualizarCorrectamente() {
        // ARRANGE
<span class="fc" id="L310">        PorcentajesRedondeoRequestDTO porcentajesDTO = new PorcentajesRedondeoRequestDTO();</span>
<span class="fc" id="L311">        porcentajesDTO.setPorcentajeNormalesConRedondeo(new BigDecimal(&quot;85.5&quot;));</span>
<span class="fc" id="L312">        porcentajesDTO.setPorcentajeAnormalesConRedondeo(new BigDecimal(&quot;8.2&quot;));</span>
<span class="fc" id="L313">        porcentajesDTO.setPorcentajeDurasConRedondeo(new BigDecimal(&quot;3.1&quot;));</span>
<span class="fc" id="L314">        porcentajesDTO.setPorcentajeFrescasConRedondeo(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L315">        porcentajesDTO.setPorcentajeMuertasConRedondeo(new BigDecimal(&quot;1.2&quot;));</span>

        // Crear repeticiones mockeadas con conteos completos
<span class="fc" id="L318">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L320">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L321">            rep.setNormales(Arrays.asList(10, 15, 20)); // 3 conteos</span>
<span class="fc" id="L322">            rep.setAnormales(10); // Total de anormales</span>
<span class="fc" id="L323">            rep.setDuras(0);</span>
<span class="fc" id="L324">            rep.setFrescas(0);</span>
<span class="fc" id="L325">            rep.setMuertas(5);</span>
<span class="fc" id="L326">            rep.setTablaGerm(tablaGerm); // Establecer la relación con la tabla</span>
<span class="fc" id="L327">            repeticiones.add(rep);</span>
        }
<span class="fc" id="L329">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L330">        tablaGerm.setFinalizada(true);</span>
        
<span class="fc" id="L332">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L333">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L334">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L337">        TablaGermDTO resultado = tablaGermService.actualizarPorcentajes(15L, porcentajesDTO);</span>

        // ASSERT
<span class="fc" id="L340">        assertNotNull(resultado);</span>
<span class="fc" id="L341">        verify(tablaGermRepository, times(1)).save(any(TablaGerm.class));</span>
<span class="fc" id="L342">    }</span>

    @Test
    @DisplayName(&quot;Validar fechas - debe lanzar excepción si fecha germinación es anterior a fecha ingreso&quot;)
    void crearTablaGerm_debeValidarFechas() {
        // ARRANGE
<span class="fc" id="L348">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 20));</span>
<span class="fc" id="L349">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 15));</span>
        
<span class="fc" id="L351">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        // ACT &amp; ASSERT
        // El servicio debe validar que fecha germinación sea posterior a fecha ingreso
<span class="fc" id="L355">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L356">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L357">        });</span>
        
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;fecha de germinación&quot;) || </span>
<span class="pc bnc" id="L360" title="All 2 branches missed.">                   exception.getMessage().contains(&quot;fecha de ingreso&quot;));</span>
<span class="fc" id="L361">    }</span>

    // ========== TESTS PARA MÉTODOS PRIVADOS PROBADOS INDIRECTAMENTE ==========

    @Test
    @DisplayName(&quot;reiniciarDatosConteo - debe reiniciar datos cuando fecha de conteo cambia a futuro&quot;)
    void reiniciarDatosConteo_debeReiniciarCuandoCambiaFechaConteo() {
        // ARRANGE
<span class="fc" id="L369">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L370">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L371">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L372">        rep1.setNumRep(1);</span>
<span class="fc" id="L373">        rep1.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L374">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L375">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L377">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L378">        tablaGerm.setFechaGerminacion(LocalDate.of(2024, 1, 17));</span>
<span class="fc" id="L379">        tablaGerm.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
        
        // Cambiar fecha del segundo conteo a una entre germinación y último conteo
<span class="fc" id="L382">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 17));</span>
<span class="fc" id="L383">        requestDTO.getFechaConteos().set(1, LocalDate.of(2024, 1, 23));</span>
<span class="fc" id="L384">        requestDTO.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L385">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 26));</span>
        
<span class="fc" id="L387">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L388">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L389">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L390">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L393">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L396">        verify(repGermRepository, atLeastOnce()).save(any(RepGerm.class));</span>
<span class="fc" id="L397">    }</span>

    @Test
    @DisplayName(&quot;validarFechasConteosEnEdicion - debe validar primer conteo posterior a germinación&quot;)
    void validarFechasConteosEnEdicion_debeValidarPrimerConteo() {
        // ARRANGE
<span class="fc" id="L403">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 17));</span>
<span class="fc" id="L404">        requestDTO.getFechaConteos().set(0, LocalDate.of(2024, 1, 17)); // Igual a germinación</span>
        
<span class="fc" id="L406">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L407">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT &amp; ASSERT
<span class="fc" id="L410">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L411">            tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>
<span class="nc" id="L412">        });</span>
        
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;primer conteo&quot;) || </span>
<span class="pc bnc" id="L415" title="All 2 branches missed.">                   exception.getMessage().contains(&quot;debe ser posterior&quot;));</span>
<span class="fc" id="L416">    }</span>

    @Test
    @DisplayName(&quot;mapearValoresGermADTO - debe mapear correctamente al actualizar valores&quot;)
    void mapearValoresGermADTO_debeMapeaCorrectamente() {
        // ARRANGE - Este método se usa internamente en obtenerTablaGermPorId
        // Crear ValoresGerm para probar el mapeo
<span class="fc" id="L423">        utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm valoresInia = </span>
<span class="fc" id="L424">            new utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm();</span>
<span class="fc" id="L425">        valoresInia.setValoresGermID(1L);</span>
<span class="fc" id="L426">        valoresInia.setInstituto(Instituto.INIA);</span>
<span class="fc" id="L427">        valoresInia.setNormales(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L428">        valoresInia.setAnormales(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L429">        valoresInia.setDuras(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L430">        valoresInia.setFrescas(new BigDecimal(&quot;1.0&quot;));</span>
<span class="fc" id="L431">        valoresInia.setMuertas(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L432">        valoresInia.setGerminacion(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L433">        valoresInia.setTablaGerm(tablaGerm);</span>
        
<span class="fc" id="L435">        tablaGerm.setValoresGerm(Arrays.asList(valoresInia));</span>
        
<span class="fc" id="L437">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>

        // ACT
<span class="fc" id="L440">        TablaGermDTO resultado = tablaGermService.obtenerTablaGermPorId(15L);</span>

        // ASSERT
<span class="fc" id="L443">        assertNotNull(resultado.getValoresGerm());</span>
<span class="fc" id="L444">        assertEquals(1, resultado.getValoresGerm().size());</span>
<span class="fc" id="L445">        assertEquals(Instituto.INIA, resultado.getValoresGerm().get(0).getInstituto());</span>
<span class="fc" id="L446">        assertEquals(new BigDecimal(&quot;85.0&quot;), resultado.getValoresGerm().get(0).getNormales());</span>
<span class="fc" id="L447">    }</span>

    @Test
    @DisplayName(&quot;reiniciarCamposUltimoConteo - debe reiniciar cuando fecha último conteo cambia a futuro&quot;)
    void reiniciarCamposUltimoConteo_debeReiniciarCuandoFechaCambiaAFuturo() {
        // ARRANGE
<span class="fc" id="L453">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L454">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L455">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L456">        rep1.setNumRep(1);</span>
<span class="fc" id="L457">        rep1.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L458">        rep1.setAnormales(10);</span>
<span class="fc" id="L459">        rep1.setDuras(2);</span>
<span class="fc" id="L460">        rep1.setFrescas(1);</span>
<span class="fc" id="L461">        rep1.setMuertas(3);</span>
<span class="fc" id="L462">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L463">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L465">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L466">        tablaGerm.setFechaUltConteo(LocalDate.now().minusDays(1)); // Fecha pasada</span>
<span class="fc" id="L467">        tablaGerm.setFechaFinal(LocalDate.now().plusDays(10)); // Asegurar que fecha final es posterior</span>
        
        // Cambiar fecha a futuro
<span class="fc" id="L470">        requestDTO.setFechaUltConteo(LocalDate.now().plusDays(5));</span>
<span class="fc" id="L471">        requestDTO.setFechaFinal(LocalDate.now().plusDays(10)); // Asegurar que fecha final es posterior</span>
        
<span class="fc" id="L473">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L474">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L475">        when(repGermRepository.findByTablaGermId(15L)).thenReturn(repeticiones);</span>
<span class="fc" id="L476">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L477">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L480">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L483">        verify(repGermRepository, atLeastOnce()).save(argThat(rep -&gt; </span>
<span class="pc bpc" id="L484" title="2 of 4 branches missed.">            rep.getAnormales() == 0 &amp;&amp; rep.getDuras() == 0 &amp;&amp; </span>
<span class="pc bpc" id="L485" title="2 of 4 branches missed.">            rep.getFrescas() == 0 &amp;&amp; rep.getMuertas() == 0</span>
        ));
<span class="fc" id="L487">    }</span>

    @Test
    @DisplayName(&quot;actualizarValoresInia - debe actualizar valores cuando se finalizan porcentajes&quot;)
    void actualizarValoresInia_debeActualizarCuandoSeFinalizanPorcentajes() {
        // ARRANGE
<span class="fc" id="L493">        PorcentajesRedondeoRequestDTO porcentajesDTO = new PorcentajesRedondeoRequestDTO();</span>
<span class="fc" id="L494">        porcentajesDTO.setPorcentajeNormalesConRedondeo(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L495">        porcentajesDTO.setPorcentajeAnormalesConRedondeo(new BigDecimal(&quot;8.0&quot;));</span>
<span class="fc" id="L496">        porcentajesDTO.setPorcentajeDurasConRedondeo(new BigDecimal(&quot;3.0&quot;));</span>
<span class="fc" id="L497">        porcentajesDTO.setPorcentajeFrescasConRedondeo(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L498">        porcentajesDTO.setPorcentajeMuertasConRedondeo(new BigDecimal(&quot;2.0&quot;));</span>

<span class="fc" id="L500">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L502">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L503">            rep.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L504">            rep.setAnormales(10);</span>
<span class="fc" id="L505">            rep.setDuras(0);</span>
<span class="fc" id="L506">            rep.setFrescas(0);</span>
<span class="fc" id="L507">            rep.setMuertas(5);</span>
<span class="fc" id="L508">            rep.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L509">            repeticiones.add(rep);</span>
        }
<span class="fc" id="L511">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L512">        tablaGerm.setFinalizada(true);</span>
        
        // Crear ValoresGerm existente
<span class="fc" id="L515">        utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm valoresInia = </span>
<span class="fc" id="L516">            new utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm();</span>
<span class="fc" id="L517">        valoresInia.setInstituto(Instituto.INIA);</span>
<span class="fc" id="L518">        valoresInia.setTablaGerm(tablaGerm);</span>
        
<span class="fc" id="L520">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L521">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L522">        when(valoresGermRepository.findByTablaGermIdAndInstituto(15L, Instituto.INIA))</span>
<span class="fc" id="L523">            .thenReturn(Optional.of(valoresInia));</span>
<span class="fc" id="L524">        when(valoresGermRepository.save(any())).thenReturn(valoresInia);</span>
<span class="fc" id="L525">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L528">        tablaGermService.actualizarPorcentajes(15L, porcentajesDTO);</span>

        // ASSERT
<span class="fc" id="L531">        verify(valoresGermRepository).save(argThat(valores -&gt; </span>
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">            valores.getInstituto() == Instituto.INIA &amp;&amp;</span>
<span class="pc bpc" id="L533" title="1 of 2 branches missed.">            valores.getNormales().compareTo(new BigDecimal(&quot;85.0&quot;)) == 0 &amp;&amp;</span>
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">            valores.getGerminacion().compareTo(new BigDecimal(&quot;85.0&quot;)) == 0</span>
        ));
<span class="fc" id="L536">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe actualizar prefrío cuando está activo&quot;)
    void actualizarEntidadDesdeSolicitud_debeActualizarPrefrio() {
        // ARRANGE
<span class="fc" id="L542">        requestDTO.setTienePrefrio(true);</span>
<span class="fc" id="L543">        requestDTO.setDiasPrefrio(7);</span>
<span class="fc" id="L544">        requestDTO.setDescripcionPrefrio(&quot;7 días a 4°C&quot;);</span>
<span class="fc" id="L545">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L546">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 20)); // 10 días después (suficiente)</span>
<span class="fc" id="L547">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L548">            LocalDate.of(2024, 1, 22), // Después de germinación</span>
<span class="fc" id="L549">            LocalDate.of(2024, 1, 23),</span>
<span class="fc" id="L550">            LocalDate.of(2024, 1, 24)</span>
        ));
<span class="fc" id="L552">        requestDTO.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L553">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 26));</span>
        
<span class="fc" id="L555">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L556">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L557">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L560">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L563">        verify(tablaGermRepository).save(argThat(tabla -&gt; </span>
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">            tabla.getTienePrefrio() &amp;&amp; </span>
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">            tabla.getDiasPrefrio() == 7 &amp;&amp;</span>
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">            &quot;7 días a 4°C&quot;.equals(tabla.getDescripcionPrefrio())</span>
        ));
<span class="fc" id="L568">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe limpiar prefrío cuando está inactivo&quot;)
    void actualizarEntidadDesdeSolicitud_debeLimpiarPrefrioInactivo() {
        // ARRANGE
<span class="fc" id="L574">        tablaGerm.setTienePrefrio(true);</span>
<span class="fc" id="L575">        tablaGerm.setDiasPrefrio(7);</span>
<span class="fc" id="L576">        tablaGerm.setDescripcionPrefrio(&quot;7 días a 4°C&quot;);</span>
        
<span class="fc" id="L578">        requestDTO.setTienePrefrio(false);</span>
<span class="fc" id="L579">        requestDTO.setDiasPrefrio(null);</span>
<span class="fc" id="L580">        requestDTO.setDescripcionPrefrio(null);</span>
        
<span class="fc" id="L582">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L583">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L584">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L587">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L590">        verify(tablaGermRepository).save(argThat(tabla -&gt; </span>
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">            !tabla.getTienePrefrio() &amp;&amp; </span>
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">            tabla.getDiasPrefrio() == 0 &amp;&amp;</span>
<span class="pc bpc" id="L593" title="1 of 2 branches missed.">            tabla.getDescripcionPrefrio() == null</span>
        ));
<span class="fc" id="L595">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe actualizar pretratamiento cuando está activo&quot;)
    void actualizarEntidadDesdeSolicitud_debeActualizarPretratamiento() {
        // ARRANGE
<span class="fc" id="L601">        requestDTO.setTienePretratamiento(true);</span>
<span class="fc" id="L602">        requestDTO.setDescripcionPretratamiento(&quot;Escarificación química&quot;);</span>
        
<span class="fc" id="L604">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L605">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L606">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L609">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L612">        verify(tablaGermRepository).save(argThat(tabla -&gt; </span>
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">            tabla.getTienePretratamiento() &amp;&amp;</span>
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">            &quot;Escarificación química&quot;.equals(tabla.getDescripcionPretratamiento())</span>
        ));
<span class="fc" id="L616">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe aumentar número de conteos&quot;)
    void actualizarEntidadDesdeSolicitud_debeAumentarNumeroConteos() {
        // ARRANGE
<span class="fc" id="L622">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L623">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L624">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L625">        rep1.setNumRep(1);</span>
<span class="fc" id="L626">        rep1.setNormales(new ArrayList&lt;&gt;(Arrays.asList(10, 15, 20))); // 3 conteos</span>
<span class="fc" id="L627">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L628">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L630">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L631">        tablaGerm.setNumeroConteos(3);</span>
        
<span class="fc" id="L633">        requestDTO.setNumeroConteos(5); // Aumentar a 5 conteos</span>
<span class="fc" id="L634">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L635">            LocalDate.of(2024, 1, 18), </span>
<span class="fc" id="L636">            LocalDate.of(2024, 1, 20),</span>
<span class="fc" id="L637">            LocalDate.of(2024, 1, 22), </span>
<span class="fc" id="L638">            LocalDate.of(2024, 1, 24),</span>
<span class="fc" id="L639">            LocalDate.of(2024, 1, 25)</span>
        ));
        
<span class="fc" id="L642">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L643">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L644">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L645">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L648">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L651">        verify(repGermRepository, atLeastOnce()).save(argThat(rep -&gt; </span>
<span class="pc bpc" id="L652" title="2 of 4 branches missed.">            rep.getNormales() != null &amp;&amp; rep.getNormales().size() == 5</span>
        ));
<span class="fc" id="L654">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe disminuir número de conteos&quot;)
    void actualizarEntidadDesdeSolicitud_debeDisminuirNumeroConteos() {
        // ARRANGE
<span class="fc" id="L660">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L661">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L662">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L663">        rep1.setNumRep(1);</span>
<span class="fc" id="L664">        rep1.setNormales(new ArrayList&lt;&gt;(Arrays.asList(10, 15, 20, 25, 30))); // 5 conteos</span>
<span class="fc" id="L665">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L666">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L668">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L669">        tablaGerm.setNumeroConteos(5);</span>
        
<span class="fc" id="L671">        requestDTO.setNumeroConteos(3); // Reducir a 3 conteos</span>
<span class="fc" id="L672">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L673">            LocalDate.of(2024, 1, 18), </span>
<span class="fc" id="L674">            LocalDate.of(2024, 1, 22), </span>
<span class="fc" id="L675">            LocalDate.of(2024, 1, 25)</span>
        ));
        
<span class="fc" id="L678">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L679">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L680">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L681">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L684">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L687">        verify(repGermRepository, atLeastOnce()).save(argThat(rep -&gt; </span>
<span class="pc bpc" id="L688" title="2 of 4 branches missed.">            rep.getNormales() != null &amp;&amp; rep.getNormales().size() == 3</span>
        ));
<span class="fc" id="L690">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe disminuir número de repeticiones&quot;)
    void actualizarEntidadDesdeSolicitud_debeDisminuirNumeroRepeticiones() {
        // ARRANGE
<span class="fc" id="L696">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L697" title="All 2 branches covered.">        for (int i = 1; i &lt;= 8; i++) {</span>
<span class="fc" id="L698">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L699">            rep.setRepGermID((long) i);</span>
<span class="fc" id="L700">            rep.setNumRep(i);</span>
<span class="fc" id="L701">            rep.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L702">            rep.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L703">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L706">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L707">        tablaGerm.setNumeroRepeticiones(8);</span>
        
<span class="fc" id="L709">        requestDTO.setNumeroRepeticiones(4); // Reducir a 4 repeticiones</span>
        
<span class="fc" id="L711">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L712">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L713">        when(repGermRepository.findByTablaGermId(15L)).thenReturn(repeticiones);</span>
<span class="fc" id="L714">        doNothing().when(repGermRepository).delete(any(RepGerm.class));</span>
<span class="fc" id="L715">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        // ACT
<span class="fc" id="L718">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        // ASSERT
<span class="fc" id="L721">        verify(repGermRepository, times(4)).delete(any(RepGerm.class));</span>
<span class="fc" id="L722">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar días de prefrío suficientes&quot;)
    void validarDatosTablaGerm_debeValidarDiasPrefrio() {
        // ARRANGE
<span class="fc" id="L728">        requestDTO.setTienePrefrio(true);</span>
<span class="fc" id="L729">        requestDTO.setDiasPrefrio(10);</span>
<span class="fc" id="L730">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L731">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 15)); // Solo 5 días, insuficientes</span>
        
<span class="fc" id="L733">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L736">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L737">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L738">        });</span>
        
<span class="fc" id="L740">        assertTrue(exception.getMessage().contains(&quot;días de prefrío&quot;));</span>
<span class="fc" id="L741">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar fechaFinal posterior a fechaGerminacion&quot;)
    void validarDatosTablaGerm_debeValidarFechaFinalPosteriorAGerminacion() {
        // ARRANGE
<span class="fc" id="L747">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 20));</span>
<span class="fc" id="L748">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 15)); // Anterior a germinación</span>
        
<span class="fc" id="L750">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L753">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L754">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L755">        });</span>
        
<span class="fc" id="L757">        assertTrue(exception.getMessage().contains(&quot;fecha final&quot;));</span>
<span class="fc" id="L758">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar número de repeticiones en rango 1-20&quot;)
    void validarDatosTablaGerm_debeValidarRangoRepeticiones() {
        // ARRANGE
<span class="fc" id="L764">        requestDTO.setNumeroRepeticiones(25); // Fuera del rango</span>
        
<span class="fc" id="L766">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L769">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L770">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L771">        });</span>
        
<span class="pc bpc" id="L773" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;repeticiones&quot;) &amp;&amp; </span>
<span class="pc bpc" id="L774" title="1 of 2 branches missed.">                   exception.getMessage().contains(&quot;20&quot;));</span>
<span class="fc" id="L775">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar número de conteos en rango 1-15&quot;)
    void validarDatosTablaGerm_debeValidarRangoConteos() {
        // ARRANGE
<span class="fc" id="L781">        requestDTO.setNumeroConteos(20); // Fuera del rango</span>
        
<span class="fc" id="L783">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L786">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L787">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L788">        });</span>
        
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;conteos&quot;) &amp;&amp; </span>
<span class="pc bpc" id="L791" title="1 of 2 branches missed.">                   exception.getMessage().contains(&quot;15&quot;));</span>
<span class="fc" id="L792">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar orden cronológico de fechas de conteos&quot;)
    void validarDatosTablaGerm_debeValidarOrdenCronologicoConteos() {
        // ARRANGE
<span class="fc" id="L798">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L799">            LocalDate.of(2024, 1, 25), // Posterior</span>
<span class="fc" id="L800">            LocalDate.of(2024, 1, 18), // Anterior - orden incorrecto</span>
<span class="fc" id="L801">            LocalDate.of(2024, 1, 22)</span>
        ));
        
<span class="fc" id="L804">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        // ACT &amp; ASSERT
<span class="fc" id="L807">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L808">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L809">        });</span>
        
<span class="fc" id="L811">        assertTrue(exception.getMessage().contains(&quot;posterior&quot;));</span>
<span class="fc" id="L812">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>