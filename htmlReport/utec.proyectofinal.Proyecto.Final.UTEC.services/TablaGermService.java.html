<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TablaGermService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">TablaGermService.java</span></div><h1>TablaGermService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.TablaGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Germinacion;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.RepGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.TablaGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.RepGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.ValoresGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.GerminacionRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.TablaGermRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PorcentajesRedondeoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.TablaGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.RepGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.ValoresGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Instituto;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;

@Service
<span class="fc" id="L29">public class TablaGermService {</span>

    @Autowired
    private TablaGermRepository tablaGermRepository;

    @Autowired
    private RepGermRepository repGermRepository;

    @Autowired
    private ValoresGermRepository valoresGermRepository;

    @Autowired
    private GerminacionRepository germinacionRepository;

    @Autowired
    private AnalisisService analisisService;

    // Crear nueva tabla asociada a una germinación
    public TablaGermDTO crearTablaGerm(Long germinacionId, TablaGermRequestDTO solicitud) {
        try {
<span class="fc" id="L49">            Optional&lt;Germinacion&gt; germinacionOpt = germinacionRepository.findById(germinacionId);</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">            if (germinacionOpt.isEmpty()) {</span>
<span class="fc" id="L51">                throw new RuntimeException(&quot;Germinación no encontrada con ID: &quot; + germinacionId);</span>
            }
            
<span class="fc" id="L54">            Germinacion germinacion = germinacionOpt.get();</span>
            
            
            // Validar datos de la solicitud
<span class="fc" id="L58">            validarDatosTablaGerm(solicitud, germinacion);</span>

            // Validar que la tabla anterior esté finalizada (si existe alguna tabla)
<span class="fc" id="L61">            List&lt;TablaGerm&gt; tablasExistentes = tablaGermRepository.findByGerminacionId(germinacionId);</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">            if (!tablasExistentes.isEmpty()) {</span>
                // Verificar que todas las tablas existentes estén finalizadas
<span class="nc" id="L64">                boolean algunaTablaNoFinalizada = tablasExistentes.stream()</span>
<span class="nc bnc" id="L65" title="All 4 branches missed.">                    .anyMatch(tabla -&gt; tabla.getFinalizada() == null || !tabla.getFinalizada());</span>
                
<span class="nc bnc" id="L67" title="All 2 branches missed.">                if (algunaTablaNoFinalizada) {</span>
<span class="nc" id="L68">                    throw new RuntimeException(&quot;No se puede crear una nueva tabla hasta que todas las tablas anteriores estén finalizadas&quot;);</span>
                }
                
            
            } else {
                // Si no hay tablas existentes, es la primera tabla: cambiar estado a EN_PROCESO
<span class="fc" id="L74">                germinacion.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L75">                germinacionRepository.save(germinacion);</span>
            }

<span class="fc" id="L78">            TablaGerm tablaGerm = mapearSolicitudAEntidad(solicitud, germinacion);</span>
            
            // Calcular total automáticamente desde las repeticiones existentes
<span class="fc" id="L81">            calcularYActualizarTotales(tablaGerm);</span>
            
<span class="fc" id="L83">            TablaGerm tablaGermGuardada = tablaGermRepository.save(tablaGerm);</span>

            // Crear ValoresGerm para INIA e INASE con valores iniciales en 0
<span class="fc" id="L86">            crearValoresGermAutomaticos(tablaGermGuardada);</span>

<span class="fc" id="L88">            return mapearEntidadADTO(tablaGermGuardada);</span>
<span class="fc" id="L89">        } catch (Exception e) {</span>
<span class="fc" id="L90">            throw new RuntimeException(&quot;Error al crear tabla de germinación: &quot; + e.getMessage(), e);</span>
        }
    }
    
    
    
    /**
     * Validar datos de la tabla de germinación
     */
    private void validarDatosTablaGerm(TablaGermRequestDTO solicitud, Germinacion germinacion) {
        // Validar campos obligatorios
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (solicitud.getFechaFinal() == null) {</span>
<span class="nc" id="L102">            throw new RuntimeException(&quot;La fecha final es obligatoria&quot;);</span>
        }
        
<span class="pc bpc" id="L105" title="2 of 4 branches missed.">        if (solicitud.getTratamiento() == null || solicitud.getTratamiento().trim().isEmpty()) {</span>
<span class="nc" id="L106">            throw new RuntimeException(&quot;El tratamiento es obligatorio&quot;);</span>
        }
        
<span class="pc bpc" id="L109" title="2 of 4 branches missed.">        if (solicitud.getMetodo() == null || solicitud.getMetodo().trim().isEmpty()) {</span>
<span class="nc" id="L110">            throw new RuntimeException(&quot;El método es obligatorio&quot;);</span>
        }
        
<span class="pc bpc" id="L113" title="2 of 4 branches missed.">        if (solicitud.getNumSemillasPRep() == null || solicitud.getNumSemillasPRep() &lt;= 0) {</span>
<span class="nc" id="L114">            throw new RuntimeException(&quot;El número de semillas por repetición es obligatorio y debe ser mayor a 0&quot;);</span>
        }
        
<span class="pc bpc" id="L117" title="2 of 4 branches missed.">        if (solicitud.getTemperatura() == null || solicitud.getTemperatura().trim().isEmpty()) {</span>
<span class="nc" id="L118">            throw new RuntimeException(&quot;La temperatura es obligatoria&quot;);</span>
        }
        
        // Validar fechas de germinación
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if (solicitud.getFechaIngreso() == null) {</span>
<span class="nc" id="L123">            throw new RuntimeException(&quot;La fecha de ingreso es obligatoria&quot;);</span>
        }
        
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if (solicitud.getFechaGerminacion() == null) {</span>
<span class="nc" id="L127">            throw new RuntimeException(&quot;La fecha de germinación es obligatoria&quot;);</span>
        }
        
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        if (solicitud.getFechaUltConteo() == null) {</span>
<span class="nc" id="L131">            throw new RuntimeException(&quot;La fecha de último conteo es obligatoria&quot;);</span>
        }
        
        // Validar que la fecha de germinación sea posterior a la de ingreso
<span class="fc bfc" id="L135" title="All 2 branches covered.">        if (!solicitud.getFechaGerminacion().isAfter(solicitud.getFechaIngreso())) {</span>
<span class="fc" id="L136">            throw new RuntimeException(&quot;La fecha de germinación debe ser posterior a la fecha de ingreso&quot;);</span>
        }
        
        // Si hay días de prefrío, validar que haya suficientes días entre fechaIngreso y fechaGerminacion
<span class="fc bfc" id="L140" title="All 2 branches covered.">        int diasPrefrio = (solicitud.getDiasPrefrio() != null) ? solicitud.getDiasPrefrio() : 0;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (diasPrefrio &gt; 0) {</span>
<span class="fc" id="L142">            long diasEntreFechas = java.time.temporal.ChronoUnit.DAYS.between(</span>
<span class="fc" id="L143">                solicitud.getFechaIngreso(), </span>
<span class="fc" id="L144">                solicitud.getFechaGerminacion()</span>
            );
<span class="fc bfc" id="L146" title="All 2 branches covered.">            if (diasEntreFechas &lt; diasPrefrio) {</span>
<span class="fc" id="L147">                throw new RuntimeException(&quot;Debe haber al menos &quot; + diasPrefrio + </span>
                    &quot; días entre la fecha de ingreso y la fecha de germinación (días de prefrío requeridos). &quot; +
<span class="fc" id="L149">                    &quot;Actualmente hay &quot; + diasEntreFechas + &quot; días.&quot;);</span>
            }
        }
        
        // Validar que la fecha de último conteo sea posterior a la de germinación
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (!solicitud.getFechaUltConteo().isAfter(solicitud.getFechaGerminacion())) {</span>
<span class="nc" id="L155">            throw new RuntimeException(&quot;La fecha de último conteo debe ser posterior a la fecha de germinación&quot;);</span>
        }
        
        // Validar fechaFinal (debe estar entre fechaGerminacion y fechaUltConteo, o después)
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (solicitud.getFechaFinal().isBefore(solicitud.getFechaGerminacion())) {</span>
<span class="fc" id="L160">            throw new RuntimeException(&quot;La fecha final debe ser posterior o igual a la fecha de germinación&quot;);</span>
        }
        
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        if (solicitud.getFechaFinal().isBefore(solicitud.getFechaUltConteo())) {</span>
<span class="nc" id="L164">            throw new RuntimeException(&quot;La fecha final debe ser igual o posterior a la fecha de último conteo&quot;);</span>
        }
        
        // Validar parámetros de repeticiones y conteos
<span class="pc bpc" id="L168" title="2 of 4 branches missed.">        if (solicitud.getNumeroRepeticiones() == null || solicitud.getNumeroRepeticiones() &lt;= 0) {</span>
<span class="nc" id="L169">            throw new RuntimeException(&quot;Debe especificar un número válido de repeticiones (mayor a 0)&quot;);</span>
        }
        
<span class="pc bpc" id="L172" title="1 of 4 branches missed.">        if (solicitud.getNumeroRepeticiones() &lt; 1 || solicitud.getNumeroRepeticiones() &gt; 20) {</span>
<span class="fc" id="L173">            throw new RuntimeException(&quot;El número de repeticiones debe estar entre 1 y 20&quot;);</span>
        }
        
<span class="pc bpc" id="L176" title="2 of 4 branches missed.">        if (solicitud.getNumeroConteos() == null || solicitud.getNumeroConteos() &lt;= 0) {</span>
<span class="nc" id="L177">            throw new RuntimeException(&quot;Debe especificar un número válido de conteos (mayor a 0)&quot;);</span>
        }
        
<span class="pc bpc" id="L180" title="1 of 4 branches missed.">        if (solicitud.getNumeroConteos() &lt; 1 || solicitud.getNumeroConteos() &gt; 15) {</span>
<span class="fc" id="L181">            throw new RuntimeException(&quot;El número de conteos debe estar entre 1 y 15&quot;);</span>
        }
        
        // Validar fechas de conteos
<span class="pc bpc" id="L185" title="2 of 4 branches missed.">        if (solicitud.getFechaConteos() == null || solicitud.getFechaConteos().isEmpty()) {</span>
<span class="nc" id="L186">            throw new RuntimeException(&quot;Debe especificar al menos una fecha de conteo&quot;);</span>
        }
        
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        if (solicitud.getFechaConteos().size() != solicitud.getNumeroConteos()) {</span>
<span class="nc" id="L190">            throw new RuntimeException(&quot;El número de fechas de conteos debe coincidir con el número de conteos definido&quot;);</span>
        }
        
        // Validar días de prefrío según el flag booleano y verificar que haya suficiente tiempo
<span class="fc bfc" id="L194" title="All 2 branches covered.">        if (Boolean.TRUE.equals(solicitud.getTienePrefrio())) {</span>
<span class="pc bpc" id="L195" title="2 of 4 branches missed.">            if (solicitud.getDiasPrefrio() != null &amp;&amp; solicitud.getDiasPrefrio() &gt; 0) {</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">                if (diasPrefrio &lt; 0) {</span>
<span class="nc" id="L197">                    throw new RuntimeException(&quot;Los días de prefrío deben ser mayores o iguales a 0&quot;);</span>
                }
            }
        }
        
        // Validar que las fechas de conteo estén dentro del rango
        // Los días de prefrío se cuentan entre fechaIngreso y fechaGerminacion
        // Por lo tanto, el primer conteo solo debe ser posterior a fechaGerminacion
<span class="fc bfc" id="L205" title="All 2 branches covered.">        for (int i = 0; i &lt; solicitud.getFechaConteos().size(); i++) {</span>
<span class="fc" id="L206">            java.time.LocalDate fechaConteo = solicitud.getFechaConteos().get(i);</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">            if (fechaConteo == null) {</span>
<span class="nc" id="L208">                throw new RuntimeException(&quot;La fecha de conteo &quot; + (i + 1) + &quot; no puede ser nula&quot;);</span>
            }
            
            // Validar que la primera fecha de conteo sea posterior a la fecha de germinación
<span class="fc bfc" id="L212" title="All 4 branches covered.">            if (i == 0 &amp;&amp; !fechaConteo.isAfter(solicitud.getFechaGerminacion())) {</span>
<span class="fc" id="L213">                throw new RuntimeException(&quot;El primer conteo debe realizarse después de la fecha de germinación (fecha mínima: &quot; + </span>
<span class="fc" id="L214">                    solicitud.getFechaGerminacion().plusDays(1) + &quot;)&quot;);</span>
            }
            
            // Validar que esté dentro del rango permitido
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">            if (fechaConteo.isBefore(solicitud.getFechaGerminacion()) || </span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">                fechaConteo.isAfter(solicitud.getFechaUltConteo())) {</span>
<span class="nc" id="L220">                throw new RuntimeException(&quot;La fecha de conteo &quot; + (i + 1) + </span>
                    &quot; debe estar entre la fecha de germinación y la fecha de último conteo&quot;);
            }
            
            // Validar orden cronológico - debe ser igual o posterior al anterior
<span class="fc bfc" id="L225" title="All 4 branches covered.">            if (i &gt; 0 &amp;&amp; fechaConteo.isBefore(solicitud.getFechaConteos().get(i - 1))) {</span>
<span class="fc" id="L226">                throw new RuntimeException(&quot;La fecha de conteo &quot; + (i + 1) + </span>
<span class="fc" id="L227">                    &quot; debe ser igual o posterior a la fecha de conteo &quot; + i);</span>
            }
        }
<span class="fc" id="L230">    }</span>
    
    /**
     * Validar porcentajes con redondeo
     */
    private void validarPorcentajes(PorcentajesRedondeoRequestDTO solicitud) {
        // Validar que todos los porcentajes estén entre 0 y 100
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeNormalesConRedondeo() != null) {</span>
<span class="fc" id="L238">            validarRangoPorcentaje(&quot;Normales&quot;, solicitud.getPorcentajeNormalesConRedondeo());</span>
        }
        
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeAnormalesConRedondeo() != null) {</span>
<span class="fc" id="L242">            validarRangoPorcentaje(&quot;Anormales&quot;, solicitud.getPorcentajeAnormalesConRedondeo());</span>
        }
        
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeDurasConRedondeo() != null) {</span>
<span class="fc" id="L246">            validarRangoPorcentaje(&quot;Duras&quot;, solicitud.getPorcentajeDurasConRedondeo());</span>
        }
        
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeFrescasConRedondeo() != null) {</span>
<span class="fc" id="L250">            validarRangoPorcentaje(&quot;Frescas&quot;, solicitud.getPorcentajeFrescasConRedondeo());</span>
        }
        
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeMuertasConRedondeo() != null) {</span>
<span class="fc" id="L254">            validarRangoPorcentaje(&quot;Muertas&quot;, solicitud.getPorcentajeMuertasConRedondeo());</span>
        }
        
        // Validar que la suma de todos los porcentajes sea aproximadamente 100
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeNormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">            solicitud.getPorcentajeAnormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">            solicitud.getPorcentajeDurasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">            solicitud.getPorcentajeFrescasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">            solicitud.getPorcentajeMuertasConRedondeo() != null) {</span>
            
<span class="fc" id="L264">            double suma = solicitud.getPorcentajeNormalesConRedondeo().doubleValue() +</span>
<span class="fc" id="L265">                         solicitud.getPorcentajeAnormalesConRedondeo().doubleValue() +</span>
<span class="fc" id="L266">                         solicitud.getPorcentajeDurasConRedondeo().doubleValue() +</span>
<span class="fc" id="L267">                         solicitud.getPorcentajeFrescasConRedondeo().doubleValue() +</span>
<span class="fc" id="L268">                         solicitud.getPorcentajeMuertasConRedondeo().doubleValue();</span>
            
            // Permitir un margen de error de ±1 debido al redondeo
<span class="pc bpc" id="L271" title="2 of 4 branches missed.">            if (suma &lt; 99.0 || suma &gt; 101.0) {</span>
<span class="nc" id="L272">                throw new RuntimeException(&quot;La suma de todos los porcentajes debe ser aproximadamente 100% (actual: &quot; + suma + &quot;%)&quot;);</span>
            }
        }
<span class="fc" id="L275">    }</span>
    
    /**
     * Validar que un porcentaje esté en el rango 0-100
     */
    private void validarRangoPorcentaje(String tipo, BigDecimal porcentaje) {
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (porcentaje.compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="nc" id="L282">            throw new RuntimeException(&quot;El porcentaje de &quot; + tipo + &quot; no puede ser negativo&quot;);</span>
        }
        
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        if (porcentaje.compareTo(new BigDecimal(&quot;100&quot;)) &gt; 0) {</span>
<span class="nc" id="L286">            throw new RuntimeException(&quot;El porcentaje de &quot; + tipo + &quot; no puede ser mayor a 100%&quot;);</span>
        }
<span class="fc" id="L288">    }</span>

    // Obtener tabla por ID
    public TablaGermDTO obtenerTablaGermPorId(Long id) {
<span class="fc" id="L292">        Optional&lt;TablaGerm&gt; tablaGerm = tablaGermRepository.findById(id);</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">        if (tablaGerm.isPresent()) {</span>
<span class="fc" id="L294">            return mapearEntidadADTO(tablaGerm.get());</span>
        } else {
<span class="fc" id="L296">            throw new RuntimeException(&quot;Tabla de germinación no encontrada con ID: &quot; + id);</span>
        }
    }

    // Actualizar tabla
    public TablaGermDTO actualizarTablaGerm(Long id, TablaGermRequestDTO solicitud) {
<span class="fc" id="L302">        Optional&lt;TablaGerm&gt; tablaGermExistente = tablaGermRepository.findById(id);</span>
        
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">        if (tablaGermExistente.isPresent()) {</span>
<span class="fc" id="L305">            TablaGerm tablaGerm = tablaGermExistente.get();</span>
            
<span class="fc" id="L307">            System.out.println(&quot; Actualizando tabla ID: &quot; + id);</span>
<span class="fc" id="L308">            System.out.println(&quot;  Fecha último conteo anterior: &quot; + tablaGerm.getFechaUltConteo());</span>
<span class="fc" id="L309">            System.out.println(&quot;  Fecha último conteo nueva: &quot; + solicitud.getFechaUltConteo());</span>
            
            // Verificar si necesitamos reiniciar campos del último conteo ANTES de actualizar
<span class="fc" id="L312">            boolean debeReiniciarCamposUltimoConteo = false;</span>
<span class="pc bpc" id="L313" title="2 of 4 branches missed.">            if (solicitud.getFechaUltConteo() != null &amp;&amp; tablaGerm.getFechaUltConteo() != null) {</span>
<span class="fc" id="L314">                java.time.LocalDate hoy = java.time.LocalDate.now();</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">                boolean fechaAnteriorEsPresenteOPasada = !tablaGerm.getFechaUltConteo().isAfter(hoy);</span>
<span class="fc" id="L316">                boolean fechaNuevaEsFutura = solicitud.getFechaUltConteo().isAfter(hoy);</span>
                
<span class="fc" id="L318">                System.out.println(&quot;  Fecha anterior es presente/pasada: &quot; + fechaAnteriorEsPresenteOPasada);</span>
<span class="fc" id="L319">                System.out.println(&quot;  Fecha nueva es futura: &quot; + fechaNuevaEsFutura);</span>
                
<span class="pc bpc" id="L321" title="1 of 4 branches missed.">                if (fechaAnteriorEsPresenteOPasada &amp;&amp; fechaNuevaEsFutura) {</span>
<span class="fc" id="L322">                    debeReiniciarCamposUltimoConteo = true;</span>
<span class="fc" id="L323">                    System.out.println(&quot;  ️ Se detectó cambio de fecha último conteo a futuro - se reiniciarán campos&quot;);</span>
                }
            }
            
            // Manejar edición de análisis finalizado según el rol del usuario
<span class="fc" id="L328">            analisisService.manejarEdicionAnalisisFinalizado(tablaGerm.getGerminacion());</span>
            
            // Validar datos de la solicitud
<span class="fc" id="L331">            validarDatosTablaGerm(solicitud, tablaGerm.getGerminacion());</span>
            
            // Si necesitamos reiniciar campos, hacerlo ANTES de actualizar la entidad
<span class="fc bfc" id="L334" title="All 2 branches covered.">            if (debeReiniciarCamposUltimoConteo) {</span>
<span class="fc" id="L335">                reiniciarCamposUltimoConteo(tablaGerm);</span>
            }
            
<span class="fc" id="L338">            actualizarEntidadDesdeSolicitud(tablaGerm, solicitud);</span>
            
            // Calcular total automáticamente desde las repeticiones
<span class="fc" id="L341">            calcularYActualizarTotales(tablaGerm);</span>
            
<span class="fc" id="L343">            TablaGerm tablaGermActualizada = tablaGermRepository.save(tablaGerm);</span>

<span class="fc" id="L345">            return mapearEntidadADTO(tablaGermActualizada);</span>
        } else {
<span class="nc" id="L347">            throw new RuntimeException(&quot;Tabla de germinación no encontrada con ID: &quot; + id);</span>
        }
    }

    // Eliminar tabla (eliminar realmente)
    public void eliminarTablaGerm(Long id) {
<span class="fc" id="L353">        Optional&lt;TablaGerm&gt; tablaGermExistente = tablaGermRepository.findById(id);</span>
        
<span class="fc bfc" id="L355" title="All 2 branches covered.">        if (tablaGermExistente.isPresent()) {</span>
            // Eliminar valores asociados primero
<span class="fc" id="L357">            List&lt;ValoresGerm&gt; valores = valoresGermRepository.findByTablaGermId(id);</span>
<span class="fc" id="L358">            valoresGermRepository.deleteAll(valores);</span>
            
<span class="fc" id="L360">            tablaGermRepository.deleteById(id);</span>
<span class="fc" id="L361">        } else {</span>
<span class="fc" id="L362">            throw new RuntimeException(&quot;Tabla de germinación no encontrada con ID: &quot; + id);</span>
        }
<span class="fc" id="L364">    }</span>

    // Obtener todas las tablas de una germinación
    public List&lt;TablaGermDTO&gt; obtenerTablasPorGerminacion(Long germinacionId) {
<span class="fc" id="L368">        List&lt;TablaGerm&gt; tablas = tablaGermRepository.findByGerminacionId(germinacionId);</span>
<span class="fc" id="L369">        return tablas.stream().map(this::mapearEntidadADTO).collect(Collectors.toList());</span>
    }

    // Contar tablas de una germinación
    public Long contarTablasPorGerminacion(Long germinacionId) {
<span class="fc" id="L374">        return tablaGermRepository.countByGerminacionId(germinacionId);</span>
    }

    // Actualizar solo los porcentajes con redondeo
    public TablaGermDTO actualizarPorcentajes(Long tablaId, PorcentajesRedondeoRequestDTO solicitud) {
<span class="fc" id="L379">        Optional&lt;TablaGerm&gt; tablaExistente = tablaGermRepository.findById(tablaId);</span>
        
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">        if (tablaExistente.isPresent()) {</span>
<span class="fc" id="L382">            TablaGerm tabla = tablaExistente.get();</span>
            
            // Manejar edición de análisis finalizado según el rol del usuario
<span class="fc" id="L385">            analisisService.manejarEdicionAnalisisFinalizado(tabla.getGerminacion());</span>
            
            // Validar que se puedan ingresar porcentajes
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">            if (!puedeIngresarPorcentajes(tablaId)) {</span>
<span class="nc" id="L389">                throw new RuntimeException(&quot;No se pueden ingresar porcentajes hasta completar todas las repeticiones&quot;);</span>
            }
            
            // Validar porcentajes
<span class="fc" id="L393">            validarPorcentajes(solicitud);</span>
            
            // Actualizar solo los porcentajes
<span class="fc" id="L396">            tabla.setPorcentajeNormalesConRedondeo(solicitud.getPorcentajeNormalesConRedondeo());</span>
<span class="fc" id="L397">            tabla.setPorcentajeAnormalesConRedondeo(solicitud.getPorcentajeAnormalesConRedondeo());</span>
<span class="fc" id="L398">            tabla.setPorcentajeDurasConRedondeo(solicitud.getPorcentajeDurasConRedondeo());</span>
<span class="fc" id="L399">            tabla.setPorcentajeFrescasConRedondeo(solicitud.getPorcentajeFrescasConRedondeo());</span>
<span class="fc" id="L400">            tabla.setPorcentajeMuertasConRedondeo(solicitud.getPorcentajeMuertasConRedondeo());</span>
            
<span class="fc" id="L402">            TablaGerm tablaActualizada = tablaGermRepository.save(tabla);</span>
            
            // Actualizar valores INIA con los porcentajes con redondeo ingresados
<span class="fc" id="L405">            actualizarValoresInia(tablaActualizada);</span>
            
<span class="fc" id="L407">            return mapearEntidadADTO(tablaActualizada);</span>
        } else {
<span class="nc" id="L409">            throw new RuntimeException(&quot;Tabla no encontrada con ID: &quot; + tablaId);</span>
        }
    }

    // Finalizar tabla (solo si todas las repeticiones están completas)
    public TablaGermDTO finalizarTabla(Long tablaId) {
<span class="fc" id="L415">        Optional&lt;TablaGerm&gt; tablaExistente = tablaGermRepository.findById(tablaId);</span>
        
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">        if (tablaExistente.isPresent()) {</span>
<span class="fc" id="L418">            TablaGerm tabla = tablaExistente.get();</span>
            
            // Validar que no esté ya finalizada
<span class="pc bpc" id="L421" title="2 of 4 branches missed.">            if (tabla.getFinalizada() != null &amp;&amp; tabla.getFinalizada()) {</span>
<span class="nc" id="L422">                throw new RuntimeException(&quot;La tabla ya está finalizada&quot;);</span>
            }
            
            // Validar que todas las repeticiones estén completas
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">            if (!todasLasRepeticionesCompletas(tabla)) {</span>
<span class="nc" id="L427">                throw new RuntimeException(&quot;No se puede finalizar la tabla. Faltan repeticiones por completar.&quot;);</span>
            }
            
            // Validar que todas las repeticiones cumplan con el rango de tolerancia del 5%
<span class="fc" id="L431">            validarRangoToleranciaRepeticiones(tabla);</span>
            
            // Validar que los campos de porcentaje con redondeo estén ingresados
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">            if (!camposPorcentajeCompletos(tabla)) {</span>
<span class="nc" id="L435">                throw new RuntimeException(&quot;No se puede finalizar la tabla. Debe ingresar todos los porcentajes con redondeo.&quot;);</span>
            }
            
            // Marcar como finalizada
<span class="fc" id="L439">            tabla.setFinalizada(true);</span>
<span class="fc" id="L440">            TablaGerm tablaActualizada = tablaGermRepository.save(tabla);</span>
            
<span class="fc" id="L442">            System.out.println(&quot;Tabla finalizada exitosamente con ID: &quot; + tablaId);</span>
<span class="fc" id="L443">            return mapearEntidadADTO(tablaActualizada);</span>
        } else {
<span class="nc" id="L445">            throw new RuntimeException(&quot;Tabla no encontrada con ID: &quot; + tablaId);</span>
        }
    }
    
    /**
     * Validar que todas las repeticiones estén dentro del rango de tolerancia del 5%
     */
    private void validarRangoToleranciaRepeticiones(TablaGerm tabla) {
<span class="pc bpc" id="L453" title="2 of 4 branches missed.">        if (tabla.getRepGerm() == null || tabla.getRepGerm().isEmpty()) {</span>
<span class="nc" id="L454">            return;</span>
        }
        
<span class="fc" id="L457">        Integer numSemillasPRep = tabla.getNumSemillasPRep();</span>
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">        if (numSemillasPRep == null) {</span>
<span class="nc" id="L459">            return;</span>
        }
        
<span class="fc" id="L462">        int limiteMinimo = (int) Math.floor(numSemillasPRep * 0.95);</span>
<span class="fc" id="L463">        int limiteMaximo = (int) Math.floor(numSemillasPRep * 1.05);</span>
        
<span class="fc" id="L465">        List&lt;String&gt; repeticionesFueraDeRango = new ArrayList&lt;&gt;();</span>
        
<span class="fc bfc" id="L467" title="All 2 branches covered.">        for (RepGerm rep : tabla.getRepGerm()) {</span>
<span class="fc" id="L468">            Integer total = rep.getTotal();</span>
<span class="pc bpc" id="L469" title="5 of 6 branches missed.">            if (total != null &amp;&amp; (total &lt; limiteMinimo || total &gt; limiteMaximo)) {</span>
<span class="nc" id="L470">                repeticionesFueraDeRango.add(&quot;Repetición &quot; + rep.getNumRep() + &quot; (total: &quot; + total + &quot;)&quot;);</span>
            }
        }
        
<span class="pc bpc" id="L474" title="1 of 2 branches missed.">        if (!repeticionesFueraDeRango.isEmpty()) {</span>
<span class="nc" id="L475">            throw new RuntimeException(&quot;No se puede finalizar la tabla. Las siguientes repeticiones están fuera del rango de tolerancia del 5% (&quot; + </span>
<span class="nc" id="L476">                limiteMinimo + &quot;-&quot; + limiteMaximo + &quot; semillas): &quot; + String.join(&quot;, &quot;, repeticionesFueraDeRango) + </span>
                &quot;. Se perdió más del 5% de las semillas o hay un exceso.&quot;);
        }
<span class="fc" id="L479">    }</span>

    // Validar que todas las repeticiones esperadas estén completas
    private boolean todasLasRepeticionesCompletas(TablaGerm tabla) {
<span class="pc bpc" id="L483" title="2 of 4 branches missed.">        if (tabla == null || tabla.getNumeroRepeticiones() == null) {</span>
<span class="nc" id="L484">            return false;</span>
        }
        
        // Contar repeticiones existentes
<span class="fc" id="L488">        List&lt;RepGerm&gt; repeticiones = tabla.getRepGerm();</span>
<span class="fc bfc" id="L489" title="All 2 branches covered.">        if (repeticiones == null) {</span>
<span class="fc" id="L490">            return false;</span>
        }
        
<span class="fc" id="L493">        int repeticionesEsperadas = tabla.getNumeroRepeticiones();</span>
<span class="fc" id="L494">        int repeticionesExistentes = repeticiones.size();</span>
        
        // Verificar que tengamos el número esperado de repeticiones
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">        if (repeticionesExistentes != repeticionesEsperadas) {</span>
<span class="nc" id="L498">            return false;</span>
        }
        
        // Verificar que cada repetición tenga todos sus conteos completos
<span class="fc" id="L502">        Integer numeroConteos = tabla.getNumeroConteos();</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        if (numeroConteos == null) {</span>
<span class="nc" id="L504">            return false;</span>
        }
        
<span class="fc bfc" id="L507" title="All 2 branches covered.">        for (RepGerm repeticion : repeticiones) {</span>
<span class="pc bpc" id="L508" title="2 of 4 branches missed.">            if (repeticion.getNormales() == null || repeticion.getNormales().size() != numeroConteos) {</span>
<span class="nc" id="L509">                return false;</span>
            }
            
            // Verificar que todos los valores estén completados (no sean null)
            // Los valores 0 son válidos ya que representan conteos no ingresados
<span class="fc bfc" id="L514" title="All 2 branches covered.">            for (Integer normal : repeticion.getNormales()) {</span>
<span class="pc bpc" id="L515" title="1 of 2 branches missed.">                if (normal == null) {</span>
<span class="nc" id="L516">                    return false;</span>
                }
            }
            
            // Verificar que al menos algunos valores sean mayores a 0 (que haya datos reales ingresados)
<span class="fc" id="L521">            boolean tieneValoresIngresados = repeticion.getNormales().stream()</span>
<span class="pc bpc" id="L522" title="2 of 4 branches missed.">                .anyMatch(valor -&gt; valor != null &amp;&amp; valor &gt; 0);</span>
            
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">            if (!tieneValoresIngresados) {</span>
<span class="nc" id="L525">                return false; // La repetición no tiene datos reales ingresados</span>
            }
        }
        
<span class="fc" id="L529">        return true;</span>
    }

    // Validar que todos los campos de porcentaje con redondeo estén ingresados
    private boolean camposPorcentajeCompletos(TablaGerm tabla) {
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">        return tabla.getPorcentajeNormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">               tabla.getPorcentajeAnormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L536" title="1 of 2 branches missed.">               tabla.getPorcentajeDurasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">               tabla.getPorcentajeFrescasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">               tabla.getPorcentajeMuertasConRedondeo() != null;</span>
    }

    // Validar que se puedan ingresar los porcentajes (todas las repeticiones completas)
    public boolean puedeIngresarPorcentajes(Long tablaId) {
<span class="fc" id="L543">        Optional&lt;TablaGerm&gt; tablaExistente = tablaGermRepository.findById(tablaId);</span>
        
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">        if (tablaExistente.isPresent()) {</span>
<span class="fc" id="L546">            TablaGerm tabla = tablaExistente.get();</span>
            
            // Los porcentajes se pueden editar incluso si la tabla está finalizada
            // Solo verificamos que todas las repeticiones estén completas
<span class="fc" id="L550">            return todasLasRepeticionesCompletas(tabla);</span>
        }
        
<span class="nc" id="L553">        return false;</span>
    }

    // Crear ValoresGerm automáticos para INIA e INASE con valores en 0
    private void crearValoresGermAutomaticos(TablaGerm tablaGerm) {
        // Crear valores para INIA
<span class="fc" id="L559">        ValoresGerm valoresInia = new ValoresGerm();</span>
<span class="fc" id="L560">        valoresInia.setInstituto(Instituto.INIA);</span>
<span class="fc" id="L561">        valoresInia.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L562">        inicializarValoresEnCero(valoresInia);</span>
<span class="fc" id="L563">        valoresGermRepository.save(valoresInia);</span>

        // Crear valores para INASE
<span class="fc" id="L566">        ValoresGerm valoresInase = new ValoresGerm();</span>
<span class="fc" id="L567">        valoresInase.setInstituto(Instituto.INASE);</span>
<span class="fc" id="L568">        valoresInase.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L569">        inicializarValoresEnCero(valoresInase);</span>
<span class="fc" id="L570">        valoresGermRepository.save(valoresInase);</span>
<span class="fc" id="L571">    }</span>

    // Inicializar todos los valores en 0
    private void inicializarValoresEnCero(ValoresGerm valores) {
<span class="fc" id="L575">        valores.setNormales(BigDecimal.ZERO);</span>
<span class="fc" id="L576">        valores.setAnormales(BigDecimal.ZERO);</span>
<span class="fc" id="L577">        valores.setDuras(BigDecimal.ZERO);</span>
<span class="fc" id="L578">        valores.setFrescas(BigDecimal.ZERO);</span>
<span class="fc" id="L579">        valores.setMuertas(BigDecimal.ZERO);</span>
<span class="fc" id="L580">        valores.setGerminacion(BigDecimal.ZERO);</span>
<span class="fc" id="L581">    }</span>



    // Actualizar valores de INIA con los porcentajes con redondeo ingresados manualmente
    private void actualizarValoresInia(TablaGerm tablaGerm) {
<span class="fc" id="L587">        Optional&lt;ValoresGerm&gt; valoresIniaOpt = valoresGermRepository.findByTablaGermIdAndInstituto(</span>
<span class="fc" id="L588">            tablaGerm.getTablaGermID(), Instituto.INIA);</span>
        
<span class="fc bfc" id="L590" title="All 2 branches covered.">        if (valoresIniaOpt.isPresent()) {</span>
<span class="fc" id="L591">            ValoresGerm valoresInia = valoresIniaOpt.get();</span>
            
            // Los valores de INIA son iguales a los porcentajes con redondeo
<span class="pc bpc" id="L594" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeNormalesConRedondeo() != null) {</span>
<span class="fc" id="L595">                valoresInia.setNormales(tablaGerm.getPorcentajeNormalesConRedondeo());</span>
            }
<span class="pc bpc" id="L597" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeAnormalesConRedondeo() != null) {</span>
<span class="fc" id="L598">                valoresInia.setAnormales(tablaGerm.getPorcentajeAnormalesConRedondeo());</span>
            }
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeDurasConRedondeo() != null) {</span>
<span class="fc" id="L601">                valoresInia.setDuras(tablaGerm.getPorcentajeDurasConRedondeo());</span>
            }
<span class="pc bpc" id="L603" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeFrescasConRedondeo() != null) {</span>
<span class="fc" id="L604">                valoresInia.setFrescas(tablaGerm.getPorcentajeFrescasConRedondeo());</span>
            }
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeMuertasConRedondeo() != null) {</span>
<span class="fc" id="L607">                valoresInia.setMuertas(tablaGerm.getPorcentajeMuertasConRedondeo());</span>
            }
            
            // Calcular germinación como la suma de normales
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">            valoresInia.setGerminacion(tablaGerm.getPorcentajeNormalesConRedondeo() != null ? </span>
<span class="pc" id="L612">                tablaGerm.getPorcentajeNormalesConRedondeo() : BigDecimal.ZERO);</span>
            
<span class="fc" id="L614">            valoresGermRepository.save(valoresInia);</span>
        }
<span class="fc" id="L616">    }</span>

    // Mapear de RequestDTO a Entity
    private TablaGerm mapearSolicitudAEntidad(TablaGermRequestDTO solicitud, Germinacion germinacion) {
<span class="fc" id="L620">        TablaGerm tablaGerm = new TablaGerm();</span>
        
<span class="fc" id="L622">        tablaGerm.setGerminacion(germinacion);</span>
        // total se calcula automáticamente cuando se agreguen repeticiones
<span class="fc" id="L624">        tablaGerm.setTotal(0);</span>
        
<span class="fc" id="L626">        tablaGerm.setFechaFinal(solicitud.getFechaFinal());</span>
        
        // Campo de control para finalización (por defecto false)
<span class="fc" id="L629">        tablaGerm.setFinalizada(false);</span>
        
        // Campos movidos desde Germinacion
<span class="fc" id="L632">        tablaGerm.setTratamiento(solicitud.getTratamiento());</span>
<span class="fc" id="L633">        tablaGerm.setProductoYDosis(solicitud.getProductoYDosis());</span>
<span class="fc" id="L634">        tablaGerm.setNumSemillasPRep(solicitud.getNumSemillasPRep());</span>
<span class="fc" id="L635">        tablaGerm.setMetodo(solicitud.getMetodo());</span>
<span class="fc" id="L636">        tablaGerm.setTemperatura(solicitud.getTemperatura());</span>
        
        // Campos Boolean para prefrío y pretratamiento con lógica condicional
<span class="fc" id="L639">        tablaGerm.setTienePrefrio(solicitud.getTienePrefrio());</span>
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">        if (Boolean.TRUE.equals(solicitud.getTienePrefrio())) {</span>
<span class="nc" id="L641">            tablaGerm.setDescripcionPrefrio(solicitud.getDescripcionPrefrio());</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">            tablaGerm.setDiasPrefrio(solicitud.getDiasPrefrio() != null ? solicitud.getDiasPrefrio() : 0);</span>
<span class="nc" id="L643">        } else {</span>
<span class="fc" id="L644">            tablaGerm.setDescripcionPrefrio(null);</span>
<span class="fc" id="L645">            tablaGerm.setDiasPrefrio(0);</span>
        }
        
<span class="fc" id="L648">        tablaGerm.setTienePretratamiento(solicitud.getTienePretratamiento());</span>
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">        if (Boolean.TRUE.equals(solicitud.getTienePretratamiento())) {</span>
<span class="nc" id="L650">            tablaGerm.setDescripcionPretratamiento(solicitud.getDescripcionPretratamiento());</span>
<span class="nc" id="L651">        } else {</span>
<span class="fc" id="L652">            tablaGerm.setDescripcionPretratamiento(null);</span>
        }
        
        // Campos de fechas y control de conteos
<span class="fc" id="L656">        tablaGerm.setFechaIngreso(solicitud.getFechaIngreso());</span>
<span class="fc" id="L657">        tablaGerm.setFechaGerminacion(solicitud.getFechaGerminacion());</span>
<span class="fc" id="L658">        tablaGerm.setFechaConteos(solicitud.getFechaConteos());</span>
<span class="fc" id="L659">        tablaGerm.setFechaUltConteo(solicitud.getFechaUltConteo());</span>
<span class="fc" id="L660">        tablaGerm.setNumDias(solicitud.getNumDias());</span>
<span class="fc" id="L661">        tablaGerm.setNumeroRepeticiones(solicitud.getNumeroRepeticiones());</span>
<span class="fc" id="L662">        tablaGerm.setNumeroConteos(solicitud.getNumeroConteos());</span>
        
<span class="fc" id="L664">        return tablaGerm;</span>
    }

    // Actualizar Entity desde RequestDTO
    private void actualizarEntidadDesdeSolicitud(TablaGerm tablaGerm, TablaGermRequestDTO solicitud) {
        // total y promedioSinRedondeo se calculan automáticamente
        
<span class="fc" id="L671">        tablaGerm.setFechaFinal(solicitud.getFechaFinal());</span>
        
        // Campos movidos desde Germinacion
<span class="fc" id="L674">        tablaGerm.setTratamiento(solicitud.getTratamiento());</span>
<span class="fc" id="L675">        tablaGerm.setProductoYDosis(solicitud.getProductoYDosis());</span>
<span class="fc" id="L676">        tablaGerm.setNumSemillasPRep(solicitud.getNumSemillasPRep());</span>
<span class="fc" id="L677">        tablaGerm.setMetodo(solicitud.getMetodo());</span>
<span class="fc" id="L678">        tablaGerm.setTemperatura(solicitud.getTemperatura());</span>
        
        // Campos Boolean para prefrío y pretratamiento con lógica condicional
<span class="fc" id="L681">        tablaGerm.setTienePrefrio(solicitud.getTienePrefrio());</span>
<span class="fc bfc" id="L682" title="All 2 branches covered.">        if (Boolean.TRUE.equals(solicitud.getTienePrefrio())) {</span>
<span class="fc" id="L683">            tablaGerm.setDescripcionPrefrio(solicitud.getDescripcionPrefrio());</span>
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">            tablaGerm.setDiasPrefrio(solicitud.getDiasPrefrio() != null ? solicitud.getDiasPrefrio() : 0);</span>
<span class="fc" id="L685">        } else {</span>
<span class="fc" id="L686">            tablaGerm.setDescripcionPrefrio(null);</span>
<span class="fc" id="L687">            tablaGerm.setDiasPrefrio(0);</span>
        }
        
<span class="fc" id="L690">        tablaGerm.setTienePretratamiento(solicitud.getTienePretratamiento());</span>
<span class="fc bfc" id="L691" title="All 2 branches covered.">        if (Boolean.TRUE.equals(solicitud.getTienePretratamiento())) {</span>
<span class="fc" id="L692">            tablaGerm.setDescripcionPretratamiento(solicitud.getDescripcionPretratamiento());</span>
<span class="fc" id="L693">        } else {</span>
<span class="fc" id="L694">            tablaGerm.setDescripcionPretratamiento(null);</span>
        };
        
        // Manejar cambios en el número de conteos
<span class="pc bpc" id="L698" title="2 of 4 branches missed.">        if (solicitud.getNumeroConteos() != null &amp;&amp; tablaGerm.getNumeroConteos() != null &amp;&amp;</span>
<span class="fc bfc" id="L699" title="All 2 branches covered.">            !solicitud.getNumeroConteos().equals(tablaGerm.getNumeroConteos())) {</span>
            
<span class="fc" id="L701">            Integer conteosAnteriores = tablaGerm.getNumeroConteos();</span>
<span class="fc" id="L702">            Integer conteosNuevos = solicitud.getNumeroConteos();</span>
            
<span class="fc" id="L704">            System.out.println(&quot; Cambio en número de conteos detectado: &quot; + conteosAnteriores + &quot; -&gt; &quot; + conteosNuevos);</span>
            
            // Ajustar el array de normales en todas las repeticiones
<span class="pc bpc" id="L707" title="2 of 4 branches missed.">            if (tablaGerm.getRepGerm() != null &amp;&amp; !tablaGerm.getRepGerm().isEmpty()) {</span>
<span class="fc bfc" id="L708" title="All 2 branches covered.">                for (RepGerm rep : tablaGerm.getRepGerm()) {</span>
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">                    List&lt;Integer&gt; normalesActuales = rep.getNormales() != null ? </span>
<span class="pc" id="L710">                        new ArrayList&lt;&gt;(rep.getNormales()) : new ArrayList&lt;&gt;();</span>
                    
<span class="fc bfc" id="L712" title="All 2 branches covered.">                    if (conteosNuevos &gt; conteosAnteriores) {</span>
                        // Agregar conteos al final (inicializados en 0)
<span class="fc" id="L714">                        int conteosAAgregar = conteosNuevos - conteosAnteriores;</span>
<span class="fc bfc" id="L715" title="All 2 branches covered.">                        for (int i = 0; i &lt; conteosAAgregar; i++) {</span>
<span class="fc" id="L716">                            normalesActuales.add(0);</span>
                        }
<span class="fc" id="L718">                        System.out.println(&quot;   Repetición &quot; + rep.getNumRep() + &quot;: agregados &quot; + conteosAAgregar + &quot; conteos al final&quot;);</span>
<span class="fc" id="L719">                    } else {</span>
                        // Eliminar conteos desde el final
<span class="fc" id="L721">                        int conteosAEliminar = conteosAnteriores - conteosNuevos;</span>
<span class="pc bpc" id="L722" title="1 of 4 branches missed.">                        for (int i = 0; i &lt; conteosAEliminar &amp;&amp; !normalesActuales.isEmpty(); i++) {</span>
<span class="fc" id="L723">                            normalesActuales.remove(normalesActuales.size() - 1);</span>
                        }
<span class="fc" id="L725">                        System.out.println(&quot;   Repetición &quot; + rep.getNumRep() + &quot;: eliminados &quot; + conteosAEliminar + &quot; conteos desde el final&quot;);</span>
                    }
                    
<span class="fc" id="L728">                    rep.setNormales(normalesActuales);</span>
<span class="fc" id="L729">                    repGermRepository.save(rep);</span>
                }
            }
            
            // Actualizar el número de conteos en la tabla
<span class="fc" id="L734">            tablaGerm.setNumeroConteos(conteosNuevos);</span>
        }
        
        // Manejar cambios en el número de repeticiones
<span class="pc bpc" id="L738" title="2 of 4 branches missed.">        if (solicitud.getNumeroRepeticiones() != null &amp;&amp; tablaGerm.getNumeroRepeticiones() != null &amp;&amp;</span>
<span class="fc bfc" id="L739" title="All 2 branches covered.">            !solicitud.getNumeroRepeticiones().equals(tablaGerm.getNumeroRepeticiones())) {</span>
            
<span class="fc" id="L741">            Integer repeticionesAnteriores = tablaGerm.getNumeroRepeticiones();</span>
<span class="fc" id="L742">            Integer repeticionesNuevas = solicitud.getNumeroRepeticiones();</span>
            
<span class="fc" id="L744">            System.out.println(&quot; Cambio en número de repeticiones detectado: &quot; + repeticionesAnteriores + &quot; -&gt; &quot; + repeticionesNuevas);</span>
            
<span class="pc bpc" id="L746" title="1 of 2 branches missed.">            if (repeticionesNuevas &lt; repeticionesAnteriores) {</span>
                // Eliminar repeticiones desde el final
<span class="fc" id="L748">                List&lt;RepGerm&gt; repeticiones = repGermRepository.findByTablaGermId(tablaGerm.getTablaGermID());</span>
<span class="fc" id="L749">                repeticiones.sort((r1, r2) -&gt; Integer.compare(r2.getNumRep(), r1.getNumRep())); // Ordenar descendente</span>
                
<span class="fc" id="L751">                int repeticionesAEliminar = repeticionesAnteriores - repeticionesNuevas;</span>
<span class="pc bpc" id="L752" title="1 of 4 branches missed.">                for (int i = 0; i &lt; repeticionesAEliminar &amp;&amp; i &lt; repeticiones.size(); i++) {</span>
<span class="fc" id="L753">                    RepGerm repAEliminar = repeticiones.get(i);</span>
<span class="fc" id="L754">                    System.out.println(&quot;  ️ Eliminando repetición &quot; + repAEliminar.getNumRep());</span>
<span class="fc" id="L755">                    repGermRepository.delete(repAEliminar);</span>
                }
            }
            // Si se aumentan las repeticiones, el usuario las creará manualmente
            
            // Actualizar el número de repeticiones en la tabla
<span class="fc" id="L761">            tablaGerm.setNumeroRepeticiones(repeticionesNuevas);</span>
        }
        
        // Actualizar fechas de conteos si se proporcionan
<span class="pc bpc" id="L765" title="2 of 4 branches missed.">        if (solicitud.getFechaConteos() != null &amp;&amp; !solicitud.getFechaConteos().isEmpty()) {</span>
            // Verificar si alguna fecha cambió
<span class="fc" id="L767">            boolean fechasCambiaron = false;</span>
<span class="pc bpc" id="L768" title="1 of 2 branches missed.">            if (tablaGerm.getFechaConteos() == null || </span>
<span class="fc bfc" id="L769" title="All 2 branches covered.">                tablaGerm.getFechaConteos().size() != solicitud.getFechaConteos().size()) {</span>
<span class="fc" id="L770">                fechasCambiaron = true;</span>
<span class="fc" id="L771">            } else {</span>
<span class="fc bfc" id="L772" title="All 2 branches covered.">                for (int i = 0; i &lt; solicitud.getFechaConteos().size(); i++) {</span>
<span class="fc bfc" id="L773" title="All 2 branches covered.">                    if (!solicitud.getFechaConteos().get(i).equals(tablaGerm.getFechaConteos().get(i))) {</span>
<span class="fc" id="L774">                        fechasCambiaron = true;</span>
                        // Verificar si la nueva fecha es posterior a la original
<span class="fc bfc" id="L776" title="All 2 branches covered.">                        if (solicitud.getFechaConteos().get(i).isAfter(tablaGerm.getFechaConteos().get(i))) {</span>
                            // Reiniciar datos de las repeticiones para este conteo
<span class="fc" id="L778">                            reiniciarDatosConteo(tablaGerm, i);</span>
                        }
                    }
                }
            }
            
<span class="fc bfc" id="L784" title="All 2 branches covered.">            if (fechasCambiaron) {</span>
                // Validar las nuevas fechas
<span class="fc" id="L786">                validarFechasConteosEnEdicion(solicitud, tablaGerm);</span>
<span class="fc" id="L787">                tablaGerm.setFechaConteos(solicitud.getFechaConteos());</span>
            }
        }
        
        // Actualizar otros campos de fechas
<span class="pc bpc" id="L792" title="1 of 2 branches missed.">        if (solicitud.getFechaIngreso() != null) {</span>
<span class="fc" id="L793">            tablaGerm.setFechaIngreso(solicitud.getFechaIngreso());</span>
        }
        
<span class="pc bpc" id="L796" title="1 of 2 branches missed.">        if (solicitud.getFechaGerminacion() != null) {</span>
<span class="fc" id="L797">            tablaGerm.setFechaGerminacion(solicitud.getFechaGerminacion());</span>
        }
        
<span class="pc bpc" id="L800" title="1 of 2 branches missed.">        if (solicitud.getFechaUltConteo() != null) {</span>
<span class="fc" id="L801">            tablaGerm.setFechaUltConteo(solicitud.getFechaUltConteo());</span>
        }
        
<span class="pc bpc" id="L804" title="1 of 2 branches missed.">        if (solicitud.getNumDias() != null) {</span>
<span class="fc" id="L805">            tablaGerm.setNumDias(solicitud.getNumDias());</span>
        }
        
        // Actualizar días de prefrío
<span class="fc bfc" id="L809" title="All 2 branches covered.">        if (solicitud.getDiasPrefrio() != null) {</span>
<span class="fc" id="L810">            tablaGerm.setDiasPrefrio(solicitud.getDiasPrefrio());</span>
        }
<span class="fc" id="L812">    }</span>
    
    /**
     * Reiniciar datos de un conteo específico en todas las repeticiones
     */
    private void reiniciarDatosConteo(TablaGerm tablaGerm, int indiceConteo) {
<span class="fc bfc" id="L818" title="All 2 branches covered.">        if (tablaGerm.getRepGerm() != null) {</span>
<span class="fc bfc" id="L819" title="All 2 branches covered.">            for (RepGerm rep : tablaGerm.getRepGerm()) {</span>
<span class="pc bpc" id="L820" title="2 of 4 branches missed.">                if (rep.getNormales() != null &amp;&amp; indiceConteo &lt; rep.getNormales().size()) {</span>
<span class="fc" id="L821">                    rep.getNormales().set(indiceConteo, 0);</span>
<span class="fc" id="L822">                    repGermRepository.save(rep);</span>
                }
            }
        }
<span class="fc" id="L826">    }</span>
    
    /**
     * Reiniciar campos del último conteo (anormales, duras, frescas, muertas) cuando 
     * la fecha de último conteo cambia de presente/pasada a futura
     */
    private void reiniciarCamposUltimoConteo(TablaGerm tablaGerm) {
<span class="fc" id="L833">        System.out.println(&quot; Reiniciando campos del último conteo para tabla ID: &quot; + tablaGerm.getTablaGermID());</span>
        
        // Cargar repeticiones explícitamente desde la base de datos
<span class="fc" id="L836">        List&lt;RepGerm&gt; repeticiones = repGermRepository.findByTablaGermId(tablaGerm.getTablaGermID());</span>
        
<span class="fc" id="L838">        System.out.println(&quot;   Repeticiones encontradas: &quot; + repeticiones.size());</span>
        
<span class="pc bpc" id="L840" title="2 of 4 branches missed.">        if (repeticiones != null &amp;&amp; !repeticiones.isEmpty()) {</span>
<span class="fc bfc" id="L841" title="All 2 branches covered.">            for (RepGerm rep : repeticiones) {</span>
<span class="fc" id="L842">                System.out.println(&quot;   Limpiando repetición &quot; + rep.getNumRep() + </span>
<span class="fc" id="L843">                    &quot; (ID: &quot; + rep.getRepGermID() + &quot;)&quot; +</span>
<span class="fc" id="L844">                    &quot; - Valores anteriores: anormales=&quot; + rep.getAnormales() + </span>
<span class="fc" id="L845">                    &quot;, duras=&quot; + rep.getDuras() + </span>
<span class="fc" id="L846">                    &quot;, frescas=&quot; + rep.getFrescas() + </span>
<span class="fc" id="L847">                    &quot;, muertas=&quot; + rep.getMuertas());</span>
                
                // Establecer todos los campos del último conteo a 0
<span class="fc" id="L850">                rep.setAnormales(0);</span>
<span class="fc" id="L851">                rep.setDuras(0);</span>
<span class="fc" id="L852">                rep.setFrescas(0);</span>
<span class="fc" id="L853">                rep.setMuertas(0);</span>
                
<span class="fc" id="L855">                RepGerm repGuardada = repGermRepository.save(rep);</span>
<span class="fc" id="L856">                System.out.println(&quot;   Repetición &quot; + rep.getNumRep() + &quot; limpiada - Nuevos valores: anormales=&quot; + </span>
<span class="fc" id="L857">                    repGuardada.getAnormales() + &quot;, duras=&quot; + repGuardada.getDuras() + </span>
<span class="fc" id="L858">                    &quot;, frescas=&quot; + repGuardada.getFrescas() + &quot;, muertas=&quot; + repGuardada.getMuertas());</span>
            }
<span class="fc" id="L860">        } else {</span>
<span class="nc" id="L861">            System.out.println(&quot;  ️ No se encontraron repeticiones para limpiar&quot;);</span>
        }
        
<span class="fc" id="L864">        System.out.println(&quot; Campos del último conteo reiniciados completamente&quot;);</span>
<span class="fc" id="L865">    }</span>
    
    /**
     * Validar fechas de conteos en edición
     */
    private void validarFechasConteosEnEdicion(TablaGermRequestDTO solicitud, TablaGerm tablaExistente) {
        // Aplicar las mismas validaciones que en creación
        // Los días de prefrío se cuentan entre fechaIngreso y fechaGerminacion
<span class="pc bpc" id="L873" title="1 of 2 branches missed.">        java.time.LocalDate fechaGerminacion = solicitud.getFechaGerminacion() != null ? </span>
<span class="pc" id="L874">            solicitud.getFechaGerminacion() : tablaExistente.getFechaGerminacion();</span>
        
<span class="fc bfc" id="L876" title="All 2 branches covered.">        for (int i = 0; i &lt; solicitud.getFechaConteos().size(); i++) {</span>
<span class="fc" id="L877">            java.time.LocalDate fechaConteo = solicitud.getFechaConteos().get(i);</span>
            
<span class="pc bpc" id="L879" title="1 of 4 branches missed.">            if (i == 0 &amp;&amp; !fechaConteo.isAfter(fechaGerminacion)) {</span>
<span class="nc" id="L880">                throw new RuntimeException(&quot;El primer conteo debe realizarse después de la fecha de germinación (fecha mínima: &quot; + </span>
<span class="nc" id="L881">                    fechaGerminacion.plusDays(1) + &quot;)&quot;);</span>
            }
        }
<span class="fc" id="L884">    }</span>

    // Mapear de Entity a DTO
    private TablaGermDTO mapearEntidadADTO(TablaGerm tablaGerm) {
<span class="fc" id="L888">        TablaGermDTO dto = new TablaGermDTO();</span>
        
<span class="fc" id="L890">        dto.setTablaGermID(tablaGerm.getTablaGermID());</span>
        
        // Mapear RepGerm entities a RepGermDTO
<span class="fc bfc" id="L893" title="All 2 branches covered.">        if (tablaGerm.getRepGerm() != null) {</span>
<span class="fc" id="L894">            List&lt;RepGermDTO&gt; repGermDTOs = tablaGerm.getRepGerm().stream()</span>
<span class="fc" id="L895">                .map(this::mapearRepGermADTO)</span>
<span class="fc" id="L896">                .collect(Collectors.toList());</span>
<span class="fc" id="L897">            dto.setRepGerm(repGermDTOs);</span>
        }
        
<span class="fc" id="L900">        dto.setTotal(tablaGerm.getTotal());</span>
<span class="fc" id="L901">        dto.setPromedioSinRedondeo(tablaGerm.getPromedioSinRedondeo());</span>
<span class="fc" id="L902">        dto.setPromediosSinRedPorConteo(tablaGerm.getPromediosSinRedPorConteo());</span>
        
        // Campos de porcentaje con redondeo
<span class="fc" id="L905">        dto.setPorcentajeNormalesConRedondeo(tablaGerm.getPorcentajeNormalesConRedondeo());</span>
<span class="fc" id="L906">        dto.setPorcentajeAnormalesConRedondeo(tablaGerm.getPorcentajeAnormalesConRedondeo());</span>
<span class="fc" id="L907">        dto.setPorcentajeDurasConRedondeo(tablaGerm.getPorcentajeDurasConRedondeo());</span>
<span class="fc" id="L908">        dto.setPorcentajeFrescasConRedondeo(tablaGerm.getPorcentajeFrescasConRedondeo());</span>
<span class="fc" id="L909">        dto.setPorcentajeMuertasConRedondeo(tablaGerm.getPorcentajeMuertasConRedondeo());</span>
        
        // Mapear ValoresGerm
<span class="fc bfc" id="L912" title="All 2 branches covered.">        if (tablaGerm.getValoresGerm() != null) {</span>
<span class="fc" id="L913">            List&lt;ValoresGermDTO&gt; valoresDTO = tablaGerm.getValoresGerm().stream()</span>
<span class="fc" id="L914">                .map(this::mapearValoresGermADTO)</span>
<span class="fc" id="L915">                .collect(Collectors.toList());</span>
<span class="fc" id="L916">            dto.setValoresGerm(valoresDTO);</span>
        }
        
<span class="fc" id="L919">        dto.setFechaFinal(tablaGerm.getFechaFinal());</span>
        
        // Campo de control para finalización
<span class="fc" id="L922">        dto.setFinalizada(tablaGerm.getFinalizada());</span>
        
        // Campos movidos desde Germinacion
<span class="fc" id="L925">        dto.setTratamiento(tablaGerm.getTratamiento());</span>
<span class="fc" id="L926">        dto.setProductoYDosis(tablaGerm.getProductoYDosis());</span>
<span class="fc" id="L927">        dto.setNumSemillasPRep(tablaGerm.getNumSemillasPRep());</span>
<span class="fc" id="L928">        dto.setMetodo(tablaGerm.getMetodo());</span>
<span class="fc" id="L929">        dto.setTemperatura(tablaGerm.getTemperatura());</span>
        
        // Campos Boolean para prefrío y pretratamiento
<span class="fc" id="L932">        dto.setTienePrefrio(tablaGerm.getTienePrefrio());</span>
<span class="fc" id="L933">        dto.setDescripcionPrefrio(tablaGerm.getDescripcionPrefrio());</span>
<span class="fc" id="L934">        dto.setTienePretratamiento(tablaGerm.getTienePretratamiento());</span>
<span class="fc" id="L935">        dto.setDescripcionPretratamiento(tablaGerm.getDescripcionPretratamiento());</span>
        
        // Campos de fechas y control de conteos
<span class="fc" id="L938">        dto.setFechaIngreso(tablaGerm.getFechaIngreso());</span>
<span class="fc" id="L939">        dto.setFechaGerminacion(tablaGerm.getFechaGerminacion());</span>
<span class="fc" id="L940">        dto.setFechaConteos(tablaGerm.getFechaConteos());</span>
<span class="fc" id="L941">        dto.setFechaUltConteo(tablaGerm.getFechaUltConteo());</span>
<span class="fc" id="L942">        dto.setNumDias(tablaGerm.getNumDias());</span>
<span class="fc" id="L943">        dto.setNumeroRepeticiones(tablaGerm.getNumeroRepeticiones());</span>
<span class="fc" id="L944">        dto.setNumeroConteos(tablaGerm.getNumeroConteos());</span>
<span class="fc" id="L945">        dto.setDiasPrefrio(tablaGerm.getDiasPrefrio());</span>
        
<span class="fc" id="L947">        return dto;</span>
    }
    
    // Mapear RepGerm a DTO
    private RepGermDTO mapearRepGermADTO(RepGerm repGerm) {
<span class="fc" id="L952">        RepGermDTO dto = new RepGermDTO();</span>
<span class="fc" id="L953">        dto.setRepGermID(repGerm.getRepGermID());</span>
<span class="fc" id="L954">        dto.setNumRep(repGerm.getNumRep());</span>
<span class="fc" id="L955">        dto.setNormales(repGerm.getNormales());</span>
<span class="fc" id="L956">        dto.setAnormales(repGerm.getAnormales());</span>
<span class="fc" id="L957">        dto.setDuras(repGerm.getDuras());</span>
<span class="fc" id="L958">        dto.setFrescas(repGerm.getFrescas());</span>
<span class="fc" id="L959">        dto.setMuertas(repGerm.getMuertas());</span>
<span class="fc" id="L960">        dto.setTotal(repGerm.getTotal());</span>
<span class="fc" id="L961">        dto.setTablaGermId(repGerm.getTablaGerm().getTablaGermID());</span>
<span class="fc" id="L962">        return dto;</span>
    }

    // Mapear ValoresGerm a DTO
    private ValoresGermDTO mapearValoresGermADTO(ValoresGerm valores) {
<span class="fc" id="L967">        ValoresGermDTO dto = new ValoresGermDTO();</span>
<span class="fc" id="L968">        dto.setValoresGermID(valores.getValoresGermID());</span>
<span class="fc" id="L969">        dto.setInstituto(valores.getInstituto());</span>
<span class="fc" id="L970">        dto.setNormales(valores.getNormales());</span>
<span class="fc" id="L971">        dto.setAnormales(valores.getAnormales());</span>
<span class="fc" id="L972">        dto.setDuras(valores.getDuras());</span>
<span class="fc" id="L973">        dto.setFrescas(valores.getFrescas());</span>
<span class="fc" id="L974">        dto.setMuertas(valores.getMuertas());</span>
<span class="fc" id="L975">        dto.setGerminacion(valores.getGerminacion());</span>
<span class="fc" id="L976">        dto.setTablaGermId(valores.getTablaGerm().getTablaGermID());</span>
<span class="fc" id="L977">        return dto;</span>
    }
    
    // Calcular y actualizar totales automáticamente
    private void calcularYActualizarTotales(TablaGerm tablaGerm) {
<span class="fc bfc" id="L982" title="All 2 branches covered.">        if (tablaGerm.getTablaGermID() == null) {</span>
            // Nueva tabla, total inicial será 0
<span class="fc" id="L984">            tablaGerm.setTotal(0);</span>
<span class="fc" id="L985">            return;</span>
        }
        
        // Obtener todas las repeticiones de esta tabla
<span class="fc" id="L989">        List&lt;RepGerm&gt; repeticiones = repGermRepository.findByTablaGermId(tablaGerm.getTablaGermID());</span>
        
        // El total es la suma de todos los totales de las repeticiones
<span class="fc" id="L992">        int totalCalculado = repeticiones.stream()</span>
<span class="pc bpc" id="L993" title="1 of 2 branches missed.">            .mapToInt(rep -&gt; rep.getTotal() != null ? rep.getTotal().intValue() : 0)</span>
<span class="fc" id="L994">            .sum();</span>
            
<span class="fc" id="L996">        tablaGerm.setTotal(totalCalculado);</span>
<span class="fc" id="L997">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>