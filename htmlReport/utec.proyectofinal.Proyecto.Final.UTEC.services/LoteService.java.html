<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoteService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">LoteService.java</span></div><h1>LoteService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Catalogo;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Contacto;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Cultivar;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.DatosHumedad;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.ContactoRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.CultivarRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.DosnRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.GerminacionRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PmsRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PurezaRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.TetrazolioRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.specifications.LoteSpecification;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.LoteRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.ValidacionLoteDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.*;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoLote;
import utec.proyectofinal.Proyecto.Final.UTEC.responses.ResponseListadoLoteSimple;

@Service
<span class="fc" id="L38">public class LoteService {</span>

    @Autowired
    private LoteRepository loteRepository;
    
    // Método para validar campos únicos
    public ValidacionLoteResponseDTO validarCamposUnicos(ValidacionLoteDTO solicitud) {
<span class="fc" id="L45">        ValidacionLoteResponseDTO resultado = new ValidacionLoteResponseDTO();</span>
        
        // Verificar ficha
<span class="fc bfc" id="L48" title="All 4 branches covered.">        if (solicitud.getFicha() != null &amp;&amp; !solicitud.getFicha().isEmpty()) {</span>
<span class="fc" id="L49">            boolean fichaExiste = loteRepository.findByFicha(solicitud.getFicha())</span>
<span class="fc" id="L50">                .stream()</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">                .anyMatch(lote -&gt; !lote.getLoteID().equals(solicitud.getLoteID()));</span>
<span class="fc" id="L52">            resultado.setFichaExiste(fichaExiste);</span>
        }
        
        // Verificar nombre del lote
<span class="pc bpc" id="L56" title="1 of 4 branches missed.">        if (solicitud.getNomLote() != null &amp;&amp; !solicitud.getNomLote().isEmpty()) {</span>
<span class="fc" id="L57">            boolean nomLoteExiste = loteRepository.findByNomLote(solicitud.getNomLote())</span>
<span class="fc" id="L58">                .stream()</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">                .anyMatch(lote -&gt; !lote.getLoteID().equals(solicitud.getLoteID()));</span>
<span class="fc" id="L60">            resultado.setNomLoteExiste(nomLoteExiste);</span>
        }
        
<span class="fc" id="L63">        return resultado;</span>
    }

    @Autowired
    private CultivarRepository cultivarRepository;
    
    @Autowired
    private ContactoRepository contactoRepository;
    
    @Autowired
    private CatalogoService catalogoService;
    
    // Repositorios para verificar análisis existentes
    @Autowired
    private PmsRepository pmsRepository;
    
    @Autowired
    private GerminacionRepository germinacionRepository;
    
    @Autowired
    private DosnRepository dosnRepository;
    
    @Autowired
    private TetrazolioRepository tetrazolioRepository;
    
    @Autowired
    private PurezaRepository purezaRepository;

    // Crear Lote con activo = true
    public LoteDTO crearLote(LoteRequestDTO solicitud) {
        try {
<span class="fc" id="L94">            System.out.println(&quot;Creando lote con solicitud: &quot; + solicitud);</span>
            
            // Validar fechaRecibo no sea posterior a la fecha actual
<span class="fc" id="L97">            validarFechaRecibo(solicitud.getFechaRecibo());</span>
            
<span class="fc" id="L99">            Lote lote = mapearSolicitudAEntidad(solicitud);</span>
<span class="fc" id="L100">            lote.setActivo(true);</span>
            
<span class="fc" id="L102">            System.out.println(&quot;Lote mapeado, guardando...&quot;);</span>
<span class="fc" id="L103">            Lote loteGuardado = loteRepository.save(lote);</span>
<span class="fc" id="L104">            System.out.println(&quot;Lote guardado con ID: &quot; + loteGuardado.getLoteID());</span>
<span class="fc" id="L105">            return mapearEntidadADTO(loteGuardado);</span>
<span class="fc" id="L106">        } catch (Exception e) {</span>
<span class="fc" id="L107">            System.err.println(&quot;Error al crear lote: &quot; + e.getMessage());</span>
<span class="fc" id="L108">            throw new RuntimeException(&quot;Error al crear lote: &quot; + e.getMessage(), e);</span>
        }
    }

    // Editar Lote
    public LoteDTO actualizarLote(Long id, LoteRequestDTO solicitud) {
<span class="fc" id="L114">        Optional&lt;Lote&gt; loteExistente = loteRepository.findById(id);</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">        if (loteExistente.isPresent()) {</span>
<span class="fc" id="L116">            Lote lote = loteExistente.get();</span>
            
            // Validar que el lote esté activo antes de permitir edición
<span class="fc bfc" id="L119" title="All 2 branches covered.">            if (!lote.getActivo()) {</span>
<span class="fc" id="L120">                throw new RuntimeException(&quot;No se puede editar un lote inactivo. Debe reactivarlo primero.&quot;);</span>
            }
            
            // Validar fechaRecibo no sea posterior a la fecha actual
<span class="fc" id="L124">            validarFechaRecibo(solicitud.getFechaRecibo());</span>
            
            // Validar cambios en tipos de análisis antes de actualizar
<span class="fc bfc" id="L127" title="All 2 branches covered.">            if (solicitud.getTiposAnalisisAsignados() != null) {</span>
<span class="nc" id="L128">                validarCambiosTiposAnalisis(lote, solicitud.getTiposAnalisisAsignados());</span>
            }
            
<span class="fc" id="L131">            actualizarEntidadDesdeSolicitud(lote, solicitud);</span>
<span class="fc" id="L132">            Lote loteActualizado = loteRepository.save(lote);</span>
<span class="fc" id="L133">            return mapearEntidadADTO(loteActualizado);</span>
        }
<span class="nc" id="L135">        throw new RuntimeException(&quot;Lote no encontrado con id: &quot; + id);</span>
    }
    
    // Método para verificar si un tipo de análisis puede ser removido del lote
    public boolean puedeRemoverTipoAnalisis(Long loteId, TipoAnalisis tipoAnalisis) {
        // Un tipo de análisis puede ser removido solo si no hay análisis creados de ese tipo
<span class="pc bpc" id="L141" title="1 of 6 branches missed.">        return switch (tipoAnalisis) {</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">            case PMS -&gt; !pmsRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">            case GERMINACION -&gt; !germinacionRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">            case DOSN -&gt; !dosnRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">            case TETRAZOLIO -&gt; !tetrazolioRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">            case PUREZA -&gt; !purezaRepository.existsByLoteLoteID(loteId);</span>
<span class="nc" id="L147">            default -&gt; true;</span>
        };
    }

    // Método para validar cambios en tipos de análisis durante la edición
    private void validarCambiosTiposAnalisis(Lote loteExistente, List&lt;TipoAnalisis&gt; nuevosTypes) {
<span class="fc" id="L153">        List&lt;TipoAnalisis&gt; tiposActuales = loteExistente.getTiposAnalisisAsignados();</span>
        
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (tiposActuales == null) {</span>
<span class="nc" id="L156">            tiposActuales = new ArrayList&lt;&gt;();</span>
        }
        
        // Verificar tipos que se están removiendo
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        for (TipoAnalisis tipoActual : tiposActuales) {</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            if (!nuevosTypes.contains(tipoActual)) {</span>
                // Este tipo se está removiendo, verificar si es posible
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">                if (!puedeRemoverTipoAnalisis(loteExistente.getLoteID(), tipoActual)) {</span>
<span class="fc" id="L164">                    throw new RuntimeException(&quot;No se puede remover el tipo de análisis &quot; + tipoActual.name() + </span>
                                             &quot; porque ya existen análisis creados de este tipo para el lote&quot;);
                }
            }
<span class="nc" id="L168">        }</span>
        
        // Los tipos que se están agregando siempre son permitidos
        // (no hay restricciones para agregar nuevos tipos de análisis)
<span class="nc" id="L172">    }</span>

    // Eliminar Lote (cambiar activo a false)
    public void eliminarLote(Long id) {
<span class="fc" id="L176">        Optional&lt;Lote&gt; loteExistente = loteRepository.findById(id);</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (loteExistente.isPresent()) {</span>
<span class="fc" id="L178">            Lote lote = loteExistente.get();</span>
<span class="fc" id="L179">            lote.setActivo(false);</span>
<span class="fc" id="L180">            loteRepository.save(lote);</span>
<span class="fc" id="L181">        } else {</span>
<span class="fc" id="L182">            throw new RuntimeException(&quot;Lote no encontrado con id: &quot; + id);</span>
        }
<span class="fc" id="L184">    }</span>

    // Reactivar Lote (cambiar activo a true)
    public LoteDTO reactivarLote(Long id) {
<span class="fc" id="L188">        Lote lote = loteRepository.findById(id)</span>
<span class="pc" id="L189">                .orElseThrow(() -&gt; new RuntimeException(&quot;Lote no encontrado con ID: &quot; + id));</span>
        
<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (lote.getActivo()) {</span>
<span class="fc" id="L192">            throw new RuntimeException(&quot;El lote ya está activo&quot;);</span>
        }
        
<span class="fc" id="L195">        lote.setActivo(true);</span>
<span class="fc" id="L196">        Lote loteReactivado = loteRepository.save(lote);</span>
<span class="fc" id="L197">        return mapearEntidadADTO(loteReactivado);</span>
    }

    // Listar todos los Lotes activos
    public ResponseListadoLoteSimple obtenerTodosLotesActivos() {
<span class="fc" id="L202">        List&lt;Lote&gt; lotes = loteRepository.findByActivoTrue();</span>
<span class="fc" id="L203">        List&lt;LoteSimpleDTO&gt; loteDTOs = lotes.stream()</span>
<span class="fc" id="L204">                .map(this::mapearEntidadASimpleDTO)</span>
<span class="fc" id="L205">                .collect(Collectors.toList());</span>
        
<span class="fc" id="L207">        ResponseListadoLoteSimple respuesta = new ResponseListadoLoteSimple();</span>
<span class="fc" id="L208">        respuesta.setLotes(loteDTOs);</span>
<span class="fc" id="L209">        return respuesta;</span>
    }

    // Listar todos los Lotes inactivos
    public ResponseListadoLoteSimple obtenerTodosLotesInactivos() {
<span class="fc" id="L214">        List&lt;Lote&gt; lotes = loteRepository.findByActivoFalse();</span>
<span class="fc" id="L215">        List&lt;LoteSimpleDTO&gt; loteDTOs = lotes.stream()</span>
<span class="fc" id="L216">                .map(this::mapearEntidadASimpleDTO)</span>
<span class="fc" id="L217">                .collect(Collectors.toList());</span>
        
<span class="fc" id="L219">        ResponseListadoLoteSimple respuesta = new ResponseListadoLoteSimple();</span>
<span class="fc" id="L220">        respuesta.setLotes(loteDTOs);</span>
<span class="fc" id="L221">        return respuesta;</span>
    }

    // Obtener Lote por ID (completo)
    public LoteDTO obtenerLotePorId(Long id) {
        // Usar JOIN FETCH para cargar cultivar y especie en una sola query
<span class="fc" id="L227">        Optional&lt;Lote&gt; lote = loteRepository.findByIdWithCultivarAndEspecie(id);</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (lote.isPresent()) {</span>
<span class="fc" id="L229">            return mapearEntidadADTO(lote.get());</span>
        }
<span class="fc" id="L231">        throw new RuntimeException(&quot;Lote no encontrado con id: &quot; + id);</span>
    }

    // Listar Lotes con paginado para listado
    public Page&lt;LoteListadoDTO&gt; obtenerLotesPaginadas(Pageable pageable) {
<span class="fc" id="L236">        Page&lt;Lote&gt; lotePage = loteRepository.findByActivo(true, pageable);</span>
<span class="fc" id="L237">        return lotePage.map(this::mapearEntidadAListadoDTO);</span>
    }

    // Listar Lotes Simple con paginado para listado
    public Page&lt;LoteSimpleDTO&gt; obtenerLotesSimplePaginadas(Pageable pageable) {
        // Obtener TODOS los lotes (activos e inactivos) con paginación
<span class="fc" id="L243">        Page&lt;Lote&gt; lotePage = loteRepository.findAll(pageable);</span>
        
        // Mapear a DTOs usando Page.map() como en PurezaService
<span class="fc" id="L246">        return lotePage.map(this::mapearEntidadASimpleDTO);</span>
    }

    /**
     * Listar Lotes Simple con paginado y filtros
     * @param pageable Información de paginación
     * @param searchTerm Término de búsqueda (opcional)
     * @param activo Filtro por estado activo (opcional)
     * @param cultivarNombre Filtro por nombre de cultivar (opcional)
     * @return Página de LoteSimpleDTO filtrados
     */
    public Page&lt;LoteSimpleDTO&gt; obtenerLotesSimplePaginadasConFiltros(
            Pageable pageable, 
            String searchTerm, 
            Boolean activo, 
            String cultivarNombre) {
        
        // Crear la especificación con los filtros
<span class="fc" id="L264">        Specification&lt;Lote&gt; spec = LoteSpecification.conFiltros(searchTerm, activo, cultivarNombre);</span>
        
        // Obtener lotes filtrados y paginados
<span class="fc" id="L267">        Page&lt;Lote&gt; lotePage = loteRepository.findAll(spec, pageable);</span>
        
        // Mapear a DTOs
<span class="fc" id="L270">        return lotePage.map(this::mapearEntidadASimpleDTO);</span>
    }

    private LoteListadoDTO mapearEntidadAListadoDTO(Lote lote) {
<span class="fc" id="L274">        LoteListadoDTO dto = new LoteListadoDTO();</span>
<span class="fc" id="L275">        dto.setLoteID(lote.getLoteID());</span>
<span class="fc" id="L276">        dto.setFicha(lote.getFicha());</span>
<span class="fc" id="L277">        dto.setFechaCosecha(lote.getFechaCosecha());</span>
<span class="fc" id="L278">        dto.setActivo(lote.getActivo());</span>
<span class="fc" id="L279">        return dto;</span>
    }

    // Mapear de RequestDTO a Entity para creación
    private Lote mapearSolicitudAEntidad(LoteRequestDTO solicitud) {
        try {
<span class="fc" id="L285">            System.out.println(&quot;Iniciando mapeo de solicitud a entidad&quot;);</span>
<span class="fc" id="L286">            Lote lote = new Lote();</span>
            
<span class="fc" id="L288">            System.out.println(&quot;Mapeando campos básicos...&quot;);</span>
<span class="fc" id="L289">            lote.setFicha(solicitud.getFicha());</span>
<span class="fc" id="L290">            lote.setNomLote(solicitud.getNomLote());</span>
            
            // Convertir String a enum TipoLote
<span class="fc bfc" id="L293" title="All 2 branches covered.">            if (solicitud.getTipo() != null) {</span>
<span class="fc" id="L294">                lote.setTipo(TipoLote.valueOf(solicitud.getTipo().toUpperCase()));</span>
            }
            
            // Mapear Empresa
<span class="fc bfc" id="L298" title="All 2 branches covered.">            if (solicitud.getEmpresaID() != null) {</span>
                try {
<span class="fc" id="L300">                    System.out.println(&quot;Buscando empresa con ID: &quot; + solicitud.getEmpresaID());</span>
<span class="fc" id="L301">                    Optional&lt;Contacto&gt; empresaOpt = contactoRepository.findById(solicitud.getEmpresaID());</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">                    if (empresaOpt.isPresent()) {</span>
<span class="fc" id="L303">                        lote.setEmpresa(empresaOpt.get());</span>
<span class="fc" id="L304">                        System.out.println(&quot;Empresa encontrada y asignada&quot;);</span>
                    } else {
<span class="nc" id="L306">                        System.out.println(&quot;Empresa no encontrada con ID: &quot; + solicitud.getEmpresaID());</span>
                    }
<span class="nc" id="L308">                } catch (Exception e) {</span>
<span class="nc" id="L309">                    System.err.println(&quot;Error al buscar empresa: &quot; + e.getMessage());</span>
<span class="fc" id="L310">                }</span>
            }
            
<span class="fc" id="L313">            lote.setCodigoCC(solicitud.getCodigoCC());</span>
<span class="fc" id="L314">            lote.setCodigoFF(solicitud.getCodigoFF());</span>
<span class="fc" id="L315">            lote.setFechaEntrega(solicitud.getFechaEntrega());</span>
<span class="fc" id="L316">            lote.setFechaRecibo(solicitud.getFechaRecibo());</span>
<span class="fc" id="L317">            lote.setUnidadEmbolsado(solicitud.getUnidadEmbolsado());</span>
<span class="fc" id="L318">            lote.setRemitente(solicitud.getRemitente());</span>
<span class="fc" id="L319">            lote.setObservaciones(solicitud.getObservaciones());</span>
<span class="fc" id="L320">            lote.setKilosLimpios(solicitud.getKilosLimpios());</span>
            
            // Mapear datos de humedad
<span class="pc bpc" id="L323" title="1 of 4 branches missed.">            if (solicitud.getDatosHumedad() != null &amp;&amp; !solicitud.getDatosHumedad().isEmpty()) {</span>
<span class="fc" id="L324">                List&lt;DatosHumedad&gt; datosHumedad = solicitud.getDatosHumedad().stream()</span>
<span class="fc" id="L325">                    .map(dhr -&gt; {</span>
<span class="fc" id="L326">                        DatosHumedad dh = new DatosHumedad();</span>
                        
                        // Obtener el catálogo de tipo humedad por ID
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">                        if (dhr.getTipoHumedadID() != null) {</span>
<span class="fc" id="L330">                            Catalogo tipoHumedad = catalogoService.obtenerEntidadPorId(dhr.getTipoHumedadID());</span>
<span class="fc" id="L331">                            dh.setTipoHumedad(tipoHumedad);</span>
                        }
                        
<span class="fc" id="L334">                        dh.setValor(dhr.getValor());</span>
<span class="fc" id="L335">                        dh.setLote(lote);</span>
<span class="fc" id="L336">                        return dh;</span>
                    })
<span class="fc" id="L338">                    .collect(Collectors.toList());</span>
<span class="fc" id="L339">                lote.setDatosHumedad(datosHumedad);</span>
            }
            
            // Mapear número de artículo
<span class="fc bfc" id="L343" title="All 2 branches covered.">            if (solicitud.getNumeroArticuloID() != null) {</span>
<span class="fc" id="L344">                Catalogo numeroArticulo = catalogoService.obtenerEntidadPorId(solicitud.getNumeroArticuloID());</span>
<span class="fc" id="L345">                lote.setNumeroArticulo(numeroArticulo);</span>
            }
            
            // Mapear origen
<span class="fc bfc" id="L349" title="All 2 branches covered.">            if (solicitud.getOrigenID() != null) {</span>
                try {
<span class="fc" id="L351">                    System.out.println(&quot;Buscando origen con ID: &quot; + solicitud.getOrigenID());</span>
<span class="fc" id="L352">                    Catalogo origen = catalogoService.obtenerEntidadPorId(solicitud.getOrigenID());</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">                    if (origen != null) {</span>
<span class="fc" id="L354">                        lote.setOrigen(origen);</span>
<span class="fc" id="L355">                        System.out.println(&quot;Origen encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L357">                        System.out.println(&quot;Origen no encontrado con ID: &quot; + solicitud.getOrigenID());</span>
                    }
<span class="nc" id="L359">                } catch (Exception e) {</span>
<span class="nc" id="L360">                    System.err.println(&quot;Error al buscar origen: &quot; + e.getMessage());</span>
<span class="fc" id="L361">                }</span>
            }
            
            // Mapear estado
<span class="fc bfc" id="L365" title="All 2 branches covered.">            if (solicitud.getEstadoID() != null) {</span>
                try {
<span class="fc" id="L367">                    System.out.println(&quot;Buscando estado con ID: &quot; + solicitud.getEstadoID());</span>
<span class="fc" id="L368">                    Catalogo estado = catalogoService.obtenerEntidadPorId(solicitud.getEstadoID());</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">                    if (estado != null) {</span>
<span class="fc" id="L370">                        lote.setEstado(estado);</span>
<span class="fc" id="L371">                        System.out.println(&quot;Estado encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L373">                        System.out.println(&quot;Estado no encontrado con ID: &quot; + solicitud.getEstadoID());</span>
                    }
<span class="nc" id="L375">                } catch (Exception e) {</span>
<span class="nc" id="L376">                    System.err.println(&quot;Error al buscar estado: &quot; + e.getMessage());</span>
<span class="fc" id="L377">                }</span>
            }
            
<span class="fc" id="L380">            lote.setFechaCosecha(solicitud.getFechaCosecha());</span>

<span class="fc" id="L382">            System.out.println(&quot;Mapeando entidades relacionadas...&quot;);</span>
            // Mapear entidades relacionadas usando repositorios
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">            if (solicitud.getCultivarID() != null) {</span>
                try {
<span class="fc" id="L386">                    System.out.println(&quot;Buscando cultivar con ID: &quot; + solicitud.getCultivarID());</span>
<span class="fc" id="L387">                    Optional&lt;Cultivar&gt; cultivarOpt = cultivarRepository.findById(solicitud.getCultivarID());</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">                    if (cultivarOpt.isPresent()) {</span>
<span class="fc" id="L389">                        lote.setCultivar(cultivarOpt.get());</span>
<span class="fc" id="L390">                        System.out.println(&quot;Cultivar encontrado y asignado&quot;);</span>
                    } else {
<span class="fc" id="L392">                        System.out.println(&quot;Cultivar no encontrado con ID: &quot; + solicitud.getCultivarID());</span>
                    }
<span class="nc" id="L394">                } catch (Exception e) {</span>
<span class="nc" id="L395">                    System.err.println(&quot;Error al buscar cultivar: &quot; + e.getMessage());</span>
<span class="fc" id="L396">                }</span>
            }

<span class="fc bfc" id="L399" title="All 2 branches covered.">            if (solicitud.getClienteID() != null) {</span>
                try {
<span class="fc" id="L401">                    System.out.println(&quot;Buscando cliente con ID: &quot; + solicitud.getClienteID());</span>
<span class="fc" id="L402">                    Optional&lt;Contacto&gt; clienteOpt = contactoRepository.findById(solicitud.getClienteID());</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">                    if (clienteOpt.isPresent()) {</span>
<span class="fc" id="L404">                        lote.setCliente(clienteOpt.get());</span>
<span class="fc" id="L405">                        System.out.println(&quot;Cliente encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L407">                        System.out.println(&quot;Cliente no encontrado con ID: &quot; + solicitud.getClienteID());</span>
                    }
<span class="nc" id="L409">                } catch (Exception e) {</span>
<span class="nc" id="L410">                    System.err.println(&quot;Error al buscar cliente: &quot; + e.getMessage());</span>
<span class="fc" id="L411">                }</span>
            }

<span class="fc bfc" id="L414" title="All 2 branches covered.">            if (solicitud.getDepositoID() != null) {</span>
                try {
<span class="fc" id="L416">                    System.out.println(&quot;Buscando deposito con ID: &quot; + solicitud.getDepositoID());</span>
<span class="fc" id="L417">                    Catalogo deposito = catalogoService.obtenerEntidadPorId(solicitud.getDepositoID());</span>
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">                    if (deposito != null) {</span>
<span class="fc" id="L419">                        lote.setDeposito(deposito);</span>
<span class="fc" id="L420">                        System.out.println(&quot;Deposito encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L422">                        System.out.println(&quot;Deposito no encontrado con ID: &quot; + solicitud.getDepositoID());</span>
                    }
<span class="nc" id="L424">                } catch (Exception e) {</span>
<span class="nc" id="L425">                    System.err.println(&quot;Error al buscar deposito: &quot; + e.getMessage());</span>
<span class="fc" id="L426">                }</span>
            }

            // Mapear tipos de análisis asignados
<span class="pc bpc" id="L430" title="1 of 4 branches missed.">            if (solicitud.getTiposAnalisisAsignados() != null &amp;&amp; !solicitud.getTiposAnalisisAsignados().isEmpty()) {</span>
                // Usar el método personalizado que elimina duplicados
<span class="fc" id="L432">                lote.setTiposAnalisisAsignados(solicitud.getTiposAnalisisAsignados());</span>
<span class="fc" id="L433">                System.out.println(&quot;Tipos de análisis asignados (sin duplicados): &quot; + lote.getTiposAnalisisAsignados());</span>
            }

<span class="fc" id="L436">            System.out.println(&quot;Mapeo completado exitosamente&quot;);</span>
<span class="fc" id="L437">            return lote;</span>
            
<span class="nc" id="L439">        } catch (Exception e) {</span>
<span class="nc" id="L440">            System.err.println(&quot;Error durante el mapeo: &quot; + e.getMessage());</span>
<span class="nc" id="L441">            throw new RuntimeException(&quot;Error durante el mapeo de la solicitud&quot;, e);</span>
        }
    }

    // Actualizar Entity desde RequestDTO para edición
    private void actualizarEntidadDesdeSolicitud(Lote lote, LoteRequestDTO solicitud) {
<span class="fc" id="L447">        lote.setFicha(solicitud.getFicha());</span>
<span class="fc" id="L448">        lote.setNomLote(solicitud.getNomLote());</span>
        
        // Convertir String a enum TipoLote
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">        if (solicitud.getTipo() != null) {</span>
<span class="nc" id="L452">            lote.setTipo(TipoLote.valueOf(solicitud.getTipo().toUpperCase()));</span>
        }
        
        // Mapear Empresa
<span class="fc bfc" id="L456" title="All 2 branches covered.">        if (solicitud.getEmpresaID() != null) {</span>
<span class="fc" id="L457">            Optional&lt;Contacto&gt; empresaOpt = contactoRepository.findById(solicitud.getEmpresaID());</span>
<span class="fc bfc" id="L458" title="All 2 branches covered.">            if (empresaOpt.isPresent()) {</span>
<span class="fc" id="L459">                lote.setEmpresa(empresaOpt.get());</span>
            } else {
<span class="fc" id="L461">                throw new RuntimeException(&quot;Empresa no encontrada con ID: &quot; + solicitud.getEmpresaID());</span>
            }
        }
        
<span class="fc" id="L465">        lote.setCodigoCC(solicitud.getCodigoCC());</span>
<span class="fc" id="L466">        lote.setCodigoFF(solicitud.getCodigoFF());</span>
<span class="fc" id="L467">        lote.setFechaEntrega(solicitud.getFechaEntrega());</span>
<span class="fc" id="L468">        lote.setFechaRecibo(solicitud.getFechaRecibo());</span>
<span class="fc" id="L469">        lote.setUnidadEmbolsado(solicitud.getUnidadEmbolsado());</span>
<span class="fc" id="L470">        lote.setRemitente(solicitud.getRemitente());</span>
<span class="fc" id="L471">        lote.setObservaciones(solicitud.getObservaciones());</span>
<span class="fc" id="L472">        lote.setKilosLimpios(solicitud.getKilosLimpios());</span>
        
        // Actualizar datos de humedad
<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (solicitud.getDatosHumedad() != null) {</span>
            // Limpiar datos existentes
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">            if (lote.getDatosHumedad() != null) {</span>
<span class="nc" id="L478">                lote.getDatosHumedad().clear();</span>
            }
            
            // Agregar nuevos datos
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">            if (!solicitud.getDatosHumedad().isEmpty()) {</span>
<span class="fc" id="L483">                List&lt;DatosHumedad&gt; datosHumedad = solicitud.getDatosHumedad().stream()</span>
<span class="fc" id="L484">                    .map(dhr -&gt; {</span>
<span class="fc" id="L485">                        DatosHumedad dh = new DatosHumedad();</span>
                        
                        // Obtener el catálogo de tipo humedad por ID
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">                        if (dhr.getTipoHumedadID() != null) {</span>
<span class="fc" id="L489">                            Catalogo tipoHumedad = catalogoService.obtenerEntidadPorId(dhr.getTipoHumedadID());</span>
<span class="fc" id="L490">                            dh.setTipoHumedad(tipoHumedad);</span>
                        }
                        
<span class="fc" id="L493">                        dh.setValor(dhr.getValor());</span>
<span class="fc" id="L494">                        dh.setLote(lote);</span>
<span class="fc" id="L495">                        return dh;</span>
                    })
<span class="fc" id="L497">                    .collect(Collectors.toList());</span>
<span class="fc" id="L498">                lote.setDatosHumedad(datosHumedad);</span>
            }
        }
        
        // Actualizar número de artículo
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        if (solicitud.getNumeroArticuloID() != null) {</span>
<span class="nc" id="L504">            Catalogo numeroArticulo = catalogoService.obtenerEntidadPorId(solicitud.getNumeroArticuloID());</span>
<span class="nc" id="L505">            lote.setNumeroArticulo(numeroArticulo);</span>
<span class="nc" id="L506">        } else {</span>
<span class="fc" id="L507">            lote.setNumeroArticulo(null);</span>
        }
        
        // Actualizar origen
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">        if (solicitud.getOrigenID() != null) {</span>
<span class="nc" id="L512">            Catalogo origen = catalogoService.obtenerEntidadPorId(solicitud.getOrigenID());</span>
<span class="nc" id="L513">            lote.setOrigen(origen);</span>
<span class="nc" id="L514">        } else {</span>
<span class="fc" id="L515">            lote.setOrigen(null);</span>
        }
        
        // Actualizar estado
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">        if (solicitud.getEstadoID() != null) {</span>
<span class="nc" id="L520">            Catalogo estado = catalogoService.obtenerEntidadPorId(solicitud.getEstadoID());</span>
<span class="nc" id="L521">            lote.setEstado(estado);</span>
<span class="nc" id="L522">        } else {</span>
<span class="fc" id="L523">            lote.setEstado(null);</span>
        }
        
<span class="fc" id="L526">        lote.setFechaCosecha(solicitud.getFechaCosecha());</span>

        // Actualizar entidades relacionadas usando repositorios
<span class="pc bpc" id="L529" title="1 of 2 branches missed.">        if (solicitud.getCultivarID() != null) {</span>
            try {
<span class="fc" id="L531">                Optional&lt;Cultivar&gt; cultivarOpt = cultivarRepository.findById(solicitud.getCultivarID());</span>
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">                if (cultivarOpt.isPresent()) {</span>
<span class="fc" id="L533">                    lote.setCultivar(cultivarOpt.get());</span>
                }
<span class="nc" id="L535">            } catch (Exception e) {</span>
                // Si no se encuentra el cultivar, no lo actualizamos
<span class="pc" id="L537">            }</span>
        } else {
<span class="nc" id="L539">            lote.setCultivar(null);</span>
        }

<span class="pc bpc" id="L542" title="1 of 2 branches missed.">        if (solicitud.getClienteID() != null) {</span>
            try {
<span class="nc" id="L544">                Optional&lt;Contacto&gt; clienteOpt = contactoRepository.findById(solicitud.getClienteID());</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">                if (clienteOpt.isPresent()) {</span>
<span class="nc" id="L546">                    lote.setCliente(clienteOpt.get());</span>
                }
<span class="nc" id="L548">            } catch (Exception e) {</span>
                // Si no se encuentra el cliente, no lo actualizamos
<span class="nc" id="L550">            }</span>
        } else {
<span class="fc" id="L552">            lote.setCliente(null);</span>
        }

<span class="pc bpc" id="L555" title="1 of 2 branches missed.">        if (solicitud.getDepositoID() != null) {</span>
            try {
<span class="nc" id="L557">                Catalogo deposito = catalogoService.obtenerEntidadPorId(solicitud.getDepositoID());</span>
<span class="nc" id="L558">                lote.setDeposito(deposito);</span>
<span class="nc" id="L559">            } catch (Exception e) {</span>
                // Si no se encuentra el deposito, no lo actualizamos
<span class="nc" id="L561">            }</span>
        } else {
<span class="fc" id="L563">            lote.setDeposito(null);</span>
        }
        
        // Mapear tipos de análisis asignados
<span class="pc bpc" id="L567" title="3 of 4 branches missed.">        if (solicitud.getTiposAnalisisAsignados() != null &amp;&amp; !solicitud.getTiposAnalisisAsignados().isEmpty()) {</span>
            // Usar el método personalizado que elimina duplicados
<span class="nc" id="L569">            lote.setTiposAnalisisAsignados(solicitud.getTiposAnalisisAsignados());</span>
        }
<span class="fc" id="L571">    }</span>

    // Mapear de Entity a DTO completo
    private LoteDTO mapearEntidadADTO(Lote lote) {
<span class="fc" id="L575">        LoteDTO dto = new LoteDTO();</span>
        
<span class="fc" id="L577">        dto.setLoteID(lote.getLoteID());</span>
<span class="fc" id="L578">        dto.setFicha(lote.getFicha());</span>
<span class="fc" id="L579">        dto.setNomLote(lote.getNomLote());</span>
        
        // Convertir enum TipoLote a String
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">        if (lote.getTipo() != null) {</span>
<span class="nc" id="L583">            dto.setTipo(lote.getTipo().name());</span>
        }
        
        // Mapear Empresa
<span class="fc bfc" id="L587" title="All 2 branches covered.">        if (lote.getEmpresa() != null) {</span>
<span class="fc" id="L588">            dto.setEmpresaID(lote.getEmpresa().getContactoID());</span>
<span class="fc" id="L589">            dto.setEmpresaNombre(lote.getEmpresa().getNombre());</span>
        }
        
<span class="fc" id="L592">        dto.setCodigoCC(lote.getCodigoCC());</span>
<span class="fc" id="L593">        dto.setCodigoFF(lote.getCodigoFF());</span>
<span class="fc" id="L594">        dto.setFechaEntrega(lote.getFechaEntrega());</span>
<span class="fc" id="L595">        dto.setFechaRecibo(lote.getFechaRecibo());</span>
<span class="fc" id="L596">        dto.setUnidadEmbolsado(lote.getUnidadEmbolsado());</span>
<span class="fc" id="L597">        dto.setRemitente(lote.getRemitente());</span>
<span class="fc" id="L598">        dto.setObservaciones(lote.getObservaciones());</span>
<span class="fc" id="L599">        dto.setKilosLimpios(lote.getKilosLimpios());</span>
        
        // Mapear datos de humedad
<span class="pc bpc" id="L602" title="1 of 4 branches missed.">        if (lote.getDatosHumedad() != null &amp;&amp; !lote.getDatosHumedad().isEmpty()) {</span>
<span class="fc" id="L603">            List&lt;DatosHumedadDTO&gt; datosHumedadDTO = lote.getDatosHumedad().stream()</span>
<span class="fc" id="L604">                .map(dh -&gt; {</span>
<span class="fc" id="L605">                    DatosHumedadDTO dhDTO = new DatosHumedadDTO();</span>
<span class="fc" id="L606">                    dhDTO.setDatosHumedadID(dh.getDatosHumedadID());</span>
                    
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">                    if (dh.getTipoHumedad() != null) {</span>
<span class="fc" id="L609">                        dhDTO.setTipoHumedadID(dh.getTipoHumedad().getId());</span>
<span class="fc" id="L610">                        dhDTO.setTipoHumedadValor(dh.getTipoHumedad().getValor());</span>
                    }
                    
<span class="fc" id="L613">                    dhDTO.setValor(dh.getValor());</span>
<span class="fc" id="L614">                    return dhDTO;</span>
                })
<span class="fc" id="L616">                .collect(Collectors.toList());</span>
<span class="fc" id="L617">            dto.setDatosHumedad(datosHumedadDTO);</span>
        }
        
        // Mapear número de artículo
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">        if (lote.getNumeroArticulo() != null) {</span>
<span class="nc" id="L622">            dto.setNumeroArticuloID(lote.getNumeroArticulo().getId());</span>
<span class="nc" id="L623">            dto.setNumeroArticuloValor(lote.getNumeroArticulo().getValor());</span>
        }
<span class="fc" id="L625">        dto.setFechaCosecha(lote.getFechaCosecha());</span>
<span class="fc" id="L626">        dto.setActivo(lote.getActivo());</span>

        // Mapear entidades relacionadas
<span class="pc bpc" id="L629" title="1 of 2 branches missed.">        if (lote.getCultivar() != null) {</span>
<span class="fc" id="L630">            dto.setCultivarID(lote.getCultivar().getCultivarID());</span>
<span class="fc" id="L631">            dto.setCultivarNombre(lote.getCultivar().getNombre());</span>
            
            // Mapear especie del cultivar
<span class="pc bpc" id="L634" title="1 of 2 branches missed.">            if (lote.getCultivar().getEspecie() != null) {</span>
<span class="fc" id="L635">                dto.setEspecieNombre(lote.getCultivar().getEspecie().getNombreComun());</span>
            }
        }

<span class="pc bpc" id="L639" title="1 of 2 branches missed.">        if (lote.getCliente() != null) {</span>
<span class="nc" id="L640">            dto.setClienteID(lote.getCliente().getContactoID());</span>
<span class="nc" id="L641">            dto.setClienteNombre(lote.getCliente().getNombre());</span>
        }

<span class="pc bpc" id="L644" title="1 of 2 branches missed.">        if (lote.getDeposito() != null) {</span>
<span class="nc" id="L645">            dto.setDepositoID(lote.getDeposito().getId());</span>
<span class="nc" id="L646">            dto.setDepositoValor(lote.getDeposito().getValor());</span>
        }
        
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">        if (lote.getOrigen() != null) {</span>
<span class="nc" id="L650">            dto.setOrigenID(lote.getOrigen().getId());</span>
<span class="nc" id="L651">            dto.setOrigenValor(lote.getOrigen().getValor());</span>
        }
        
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">        if (lote.getEstado() != null) {</span>
<span class="nc" id="L655">            dto.setEstadoID(lote.getEstado().getId());</span>
<span class="nc" id="L656">            dto.setEstadoValor(lote.getEstado().getValor());</span>
        }
        
        // Mapear tipos de análisis asignados - usar el getter personalizado que elimina duplicados
<span class="fc" id="L660">        List&lt;TipoAnalisis&gt; tiposAnalisis = lote.getTiposAnalisisAsignados();</span>
<span class="pc bpc" id="L661" title="2 of 4 branches missed.">        if (tiposAnalisis != null &amp;&amp; !tiposAnalisis.isEmpty()) {</span>
<span class="nc" id="L662">            dto.setTiposAnalisisAsignados(tiposAnalisis);</span>
        }

<span class="fc" id="L665">        return dto;</span>
    }

    // Mapear de Entity a DTO simple (solo ID, ficha, activo, cultivar, especie)
    private LoteSimpleDTO mapearEntidadASimpleDTO(Lote lote) {
<span class="fc" id="L670">        LoteSimpleDTO dto = new LoteSimpleDTO();</span>
<span class="fc" id="L671">        dto.setLoteID(lote.getLoteID());</span>
<span class="fc" id="L672">        dto.setFicha(lote.getFicha());</span>
<span class="fc" id="L673">        dto.setNomLote(lote.getNomLote());</span>
<span class="fc" id="L674">        dto.setActivo(lote.getActivo());</span>
        
        // Mapear cultivar nombre directamente
<span class="pc bpc" id="L677" title="1 of 2 branches missed.">        if (lote.getCultivar() != null) {</span>
<span class="fc" id="L678">            dto.setCultivarNombre(lote.getCultivar().getNombre());</span>
        }
        
        // Mapear especie nombre directamente
<span class="pc bpc" id="L682" title="2 of 4 branches missed.">        if (lote.getCultivar() != null &amp;&amp; lote.getCultivar().getEspecie() != null) {</span>
<span class="fc" id="L683">            dto.setEspecieNombre(lote.getCultivar().getEspecie().getNombreComun());</span>
        }
        
<span class="fc" id="L686">        return dto;</span>
    }

    private void validarFechaRecibo(LocalDate fechaRecibo) {
<span class="pc bpc" id="L690" title="1 of 4 branches missed.">        if (fechaRecibo != null &amp;&amp; fechaRecibo.isAfter(LocalDate.now())) {</span>
<span class="fc" id="L691">            throw new RuntimeException(&quot;La fecha de recibo no puede ser posterior a la fecha actual&quot;);</span>
        }
<span class="fc" id="L693">    }</span>
    
    // Método para verificar si un lote es elegible para crear un análisis de un tipo específico
    public boolean esLoteElegibleParaTipoAnalisis(Long loteId, TipoAnalisis tipoAnalisis) {
<span class="fc" id="L697">        Optional&lt;Lote&gt; loteOpt = loteRepository.findById(loteId);</span>
<span class="fc bfc" id="L698" title="All 2 branches covered.">        if (loteOpt.isEmpty()) {</span>
<span class="fc" id="L699">            return false;</span>
        }
        
<span class="fc" id="L702">        Lote lote = loteOpt.get();</span>
        
        // 0. Verificar que el lote esté activo
<span class="fc bfc" id="L705" title="All 2 branches covered.">        if (!lote.getActivo()) {</span>
<span class="fc" id="L706">            return false;</span>
        }
        
        // 1. Verificar que el lote tenga ese tipo de análisis asignado
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">        if (lote.getTiposAnalisisAsignados() == null || </span>
<span class="fc bfc" id="L711" title="All 2 branches covered.">            !lote.getTiposAnalisisAsignados().contains(tipoAnalisis)) {</span>
<span class="fc" id="L712">            return false;</span>
        }
        
        // 2. Verificar estado de análisis existentes de ese tipo
<span class="fc" id="L716">        return puedeCrearAnalisisDelTipo(loteId, tipoAnalisis);</span>
    }
    
    // Método para verificar si se puede crear un análisis de un tipo específico
    public boolean puedeCrearAnalisisDelTipo(Long loteId, TipoAnalisis tipoAnalisis) {
        // Verificar análisis existentes según el tipo
<span class="pc bpc" id="L722" title="1 of 6 branches missed.">        return switch (tipoAnalisis) {</span>
<span class="fc bfc" id="L723" title="All 2 branches covered.">            case PMS -&gt; !pmsRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L724" title="1 of 2 branches missed.">                       pmsRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L725" title="All 2 branches covered.">            case GERMINACION -&gt; !germinacionRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L726" title="1 of 2 branches missed.">                       germinacionRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L727" title="All 2 branches covered.">            case DOSN -&gt; !dosnRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">                       dosnRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L729" title="All 2 branches covered.">            case TETRAZOLIO -&gt; !tetrazolioRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L730" title="1 of 2 branches missed.">                       tetrazolioRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L731" title="All 2 branches covered.">            case PUREZA -&gt; !purezaRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">                       purezaRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="nc" id="L733">            default -&gt; true;</span>
        };
    }
    
    // Método para obtener lotes elegibles para un tipo de análisis específico
    public ResponseListadoLoteSimple obtenerLotesElegiblesParaTipoAnalisis(TipoAnalisis tipoAnalisis) {
<span class="fc" id="L739">        List&lt;Lote&gt; todosLosLotes = loteRepository.findByActivoTrue();</span>
        
<span class="fc" id="L741">        List&lt;LoteSimpleDTO&gt; lotesElegibles = todosLosLotes.stream()</span>
<span class="fc" id="L742">                .filter(lote -&gt; esLoteElegibleParaTipoAnalisis(lote.getLoteID(), tipoAnalisis))</span>
<span class="fc" id="L743">                .map(this::mapearEntidadASimpleDTO)</span>
<span class="fc" id="L744">                .collect(Collectors.toList());</span>
        
<span class="fc" id="L746">        ResponseListadoLoteSimple respuesta = new ResponseListadoLoteSimple();</span>
<span class="fc" id="L747">        respuesta.setLotes(lotesElegibles);</span>
<span class="fc" id="L748">        return respuesta;</span>
    }
    
    // Método para contar análisis pendientes (asignados pero no realizados o todos en A_REPETIR)
    public long contarAnalisisPendientes() {
<span class="fc" id="L753">        List&lt;Lote&gt; lotesActivos = loteRepository.findByActivoTrue();</span>
<span class="fc" id="L754">        long totalPendientes = 0;</span>
        
<span class="fc bfc" id="L756" title="All 2 branches covered.">        for (Lote lote : lotesActivos) {</span>
<span class="pc bpc" id="L757" title="1 of 2 branches missed.">            if (lote.getTiposAnalisisAsignados() == null) continue;</span>
            
<span class="fc bfc" id="L759" title="All 2 branches covered.">            for (TipoAnalisis tipo : lote.getTiposAnalisisAsignados()) {</span>
                // Verificar si el análisis no existe o todos están marcados como A_REPETIR
<span class="pc bpc" id="L761" title="1 of 6 branches missed.">                boolean pendiente = switch (tipo) {</span>
                    case PMS -&gt; {
                        // No existe ningún análisis
<span class="fc bfc" id="L764" title="All 2 branches covered.">                        if (!pmsRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L765">                            yield true;</span>
                        }
                        // Existen análisis, verificar si TODOS están en A_REPETIR
<span class="fc" id="L768">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pms&gt; analisis = </span>
<span class="fc" id="L769">                            pmsRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="fc bfc" id="L770" title="All 2 branches covered.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case GERMINACION -&gt; {
<span class="fc bfc" id="L773" title="All 2 branches covered.">                        if (!germinacionRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L774">                            yield true;</span>
                        }
<span class="fc" id="L776">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Germinacion&gt; analisis = </span>
<span class="fc" id="L777">                            germinacionRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case DOSN -&gt; {
<span class="fc bfc" id="L781" title="All 2 branches covered.">                        if (!dosnRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L782">                            yield true;</span>
                        }
<span class="fc" id="L784">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Dosn&gt; analisis = </span>
<span class="fc" id="L785">                            dosnRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L786" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case TETRAZOLIO -&gt; {
<span class="fc bfc" id="L789" title="All 2 branches covered.">                        if (!tetrazolioRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L790">                            yield true;</span>
                        }
<span class="fc" id="L792">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Tetrazolio&gt; analisis = </span>
<span class="fc" id="L793">                            tetrazolioRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L794" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case PUREZA -&gt; {
<span class="fc bfc" id="L797" title="All 2 branches covered.">                        if (!purezaRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L798">                            yield true;</span>
                        }
<span class="fc" id="L800">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pureza&gt; analisis = </span>
<span class="fc" id="L801">                            purezaRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L802" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
<span class="pc" id="L804">                    default -&gt; false;</span>
                };
                
<span class="fc bfc" id="L807" title="All 2 branches covered.">                if (pendiente) {</span>
<span class="fc" id="L808">                    totalPendientes++;</span>
                }
<span class="fc" id="L810">            }</span>
<span class="fc" id="L811">        }</span>
        
<span class="fc" id="L813">        return totalPendientes;</span>
    }
    
    // Obtener estadísticas de lotes
    public java.util.Map&lt;String, Long&gt; obtenerEstadisticasLotes() {
<span class="fc" id="L818">        long total = loteRepository.count();</span>
<span class="fc" id="L819">        long activos = loteRepository.countLotesActivos();</span>
<span class="fc" id="L820">        long inactivos = loteRepository.countLotesInactivos();</span>
        
<span class="fc" id="L822">        java.util.Map&lt;String, Long&gt; stats = new java.util.HashMap&lt;&gt;();</span>
<span class="fc" id="L823">        stats.put(&quot;total&quot;, total);</span>
<span class="fc" id="L824">        stats.put(&quot;activos&quot;, activos);</span>
<span class="fc" id="L825">        stats.put(&quot;inactivos&quot;, inactivos);</span>
        
<span class="fc" id="L827">        return stats;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>