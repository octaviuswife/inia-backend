<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnalisisServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepPmsControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">AnalisisServiceTest.java</span></div><h1>AnalisisServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.GrantedAuthority;
import java.util.Collection;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Analisis;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Germinacion;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.function.Consumer;
import java.util.function.Function;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de AnalisisService&quot;)
<span class="fc" id="L34">class AnalisisServiceTest {</span>

    @Mock
    private AnalisisHistorialService analisisHistorialService;

    @Mock
    private NotificacionService notificacionService;

    @InjectMocks
    private AnalisisService analisisService;

    private Analisis analisis;

    @BeforeEach
    void setUp() {
<span class="fc" id="L49">        analisis = new Germinacion();</span>
<span class="fc" id="L50">        analisis.setAnalisisID(1L);</span>
<span class="fc" id="L51">        analisis.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L52">        analisis.setActivo(true);</span>
<span class="fc" id="L53">    }</span>

    private void setRolAnalista(boolean esAnalista) {
<span class="fc" id="L56">        SecurityContext context = mock(SecurityContext.class);</span>
<span class="fc" id="L57">        Authentication auth = mock(Authentication.class);</span>
<span class="fc" id="L58">        lenient().when(context.getAuthentication()).thenReturn(auth);</span>
        // Usar wildcard para que coincida con la firma de Mockito (Collection&lt;? extends GrantedAuthority&gt;)
<span class="fc bfc" id="L60" title="All 2 branches covered.">        Collection&lt;? extends GrantedAuthority&gt; autoridades = esAnalista</span>
<span class="fc" id="L61">            ? java.util.Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_ANALISTA&quot;))</span>
<span class="fc" id="L62">            : java.util.Collections.emptyList();</span>
<span class="fc" id="L63">        lenient().doReturn(autoridades).when(auth).getAuthorities();</span>
<span class="fc" id="L64">        SecurityContextHolder.setContext(context);</span>
<span class="fc" id="L65">    }</span>

    @Test
    @DisplayName(&quot;Establecer fecha inicio - debe asignar fecha actual&quot;)
    void establecerFechaInicio_debeAsignarFechaActual() {
<span class="fc" id="L70">        analisisService.establecerFechaInicio(analisis);</span>

<span class="fc" id="L72">        assertNotNull(analisis.getFechaInicio());</span>
<span class="fc" id="L73">        assertTrue(analisis.getFechaInicio().isBefore(LocalDateTime.now().plusSeconds(1)));</span>
<span class="fc" id="L74">    }</span>

    @Test
    @DisplayName(&quot;Finalizar análisis como analista - debe dejar PENDIENTE_APROBACION y setear fechaFin, con notificación en catch&quot;)
    void finalizarAnalisis_analista_pendienteAprobacion_yNotificacionEnCatch() {
<span class="fc" id="L79">        setRolAnalista(true);</span>
<span class="fc" id="L80">        doNothing().when(analisisHistorialService).registrarModificacion(any());</span>
<span class="fc" id="L81">        doThrow(new RuntimeException(&quot;error notif&quot;)).when(notificacionService).notificarAnalisisFinalizado(1L);</span>

<span class="fc" id="L83">        Analisis res = analisisService.finalizarAnalisis(analisis);</span>
<span class="fc" id="L84">        assertEquals(Estado.PENDIENTE_APROBACION, res.getEstado());</span>
<span class="fc" id="L85">        assertNotNull(res.getFechaFin());</span>
<span class="fc" id="L86">        verify(analisisHistorialService, times(1)).registrarModificacion(analisis);</span>
<span class="fc" id="L87">    }</span>

    @Test
    @DisplayName(&quot;Finalizar análisis como admin - debe aprobar directamente&quot;)
    void finalizarAnalisis_admin_aprobado() {
<span class="fc" id="L92">        setRolAnalista(false);</span>
<span class="fc" id="L93">        doNothing().when(analisisHistorialService).registrarModificacion(any());</span>

<span class="fc" id="L95">        Analisis res = analisisService.finalizarAnalisis(analisis);</span>
<span class="fc" id="L96">        assertEquals(Estado.APROBADO, res.getEstado());</span>
<span class="fc" id="L97">        assertNotNull(res.getFechaFin());</span>
<span class="fc" id="L98">    }</span>

    @Test
    @DisplayName(&quot;Finalizar análisis inactivo - debe lanzar excepción&quot;)
    void finalizarAnalisis_inactivo_lanzaExcepcion() {
<span class="fc" id="L103">        analisis.setActivo(false);</span>
<span class="pc" id="L104">        assertThrows(RuntimeException.class, () -&gt; analisisService.finalizarAnalisis(analisis));</span>
<span class="fc" id="L105">    }</span>

    @Test
    @DisplayName(&quot;Finalizar análisis ya finalizado o a repetir - debe lanzar excepción&quot;)
    void finalizarAnalisis_estadoInvalido_lanzaExcepcion() {
<span class="fc" id="L110">        analisis.setEstado(Estado.APROBADO);</span>
<span class="pc" id="L111">        assertThrows(RuntimeException.class, () -&gt; analisisService.finalizarAnalisis(analisis));</span>
<span class="fc" id="L112">        analisis.setEstado(Estado.A_REPETIR);</span>
<span class="pc" id="L113">        assertThrows(RuntimeException.class, () -&gt; analisisService.finalizarAnalisis(analisis));</span>
<span class="fc" id="L114">    }</span>

    @Test
    @DisplayName(&quot;Aprobar análisis pendiente - debe cambiar a APROBADO&quot;)
    void aprobarAnalisis_pendiente_debeCambiarAAprobado() {
<span class="fc" id="L119">        analisis.setEstado(Estado.PENDIENTE_APROBACION);</span>

<span class="fc" id="L121">        Analisis resultado = analisisService.aprobarAnalisis(analisis);</span>

<span class="fc" id="L123">        assertEquals(Estado.APROBADO, resultado.getEstado());</span>
<span class="fc" id="L124">        assertNotNull(resultado.getFechaFin());</span>
<span class="fc" id="L125">        verify(analisisHistorialService, times(1)).registrarModificacion(analisis);</span>
<span class="fc" id="L126">    }</span>

    @Test
    @DisplayName(&quot;Aprobar análisis no pendiente - debe lanzar excepción&quot;)
    void aprobarAnalisis_noPendiente_debeLanzarExcepcion() {
<span class="fc" id="L131">        analisis.setEstado(Estado.EN_PROCESO);</span>

<span class="fc" id="L133">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L134">            analisisService.aprobarAnalisis(analisis);</span>
<span class="nc" id="L135">        });</span>

<span class="fc" id="L137">        assertTrue(exception.getMessage().contains(&quot;PENDIENTE_APROBACION&quot;));</span>
<span class="fc" id="L138">    }</span>

    @Test
    @DisplayName(&quot;Aprobar análisis inactivo - debe lanzar excepción&quot;)
    void aprobarAnalisis_analisisInactivo_debeLanzarExcepcion() {
<span class="fc" id="L143">        analisis.setActivo(false);</span>
<span class="fc" id="L144">        analisis.setEstado(Estado.PENDIENTE_APROBACION);</span>

<span class="fc" id="L146">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L147">            analisisService.aprobarAnalisis(analisis);</span>
<span class="nc" id="L148">        });</span>

<span class="fc" id="L150">        assertEquals(&quot;No se puede aprobar un análisis inactivo&quot;, exception.getMessage());</span>
<span class="fc" id="L151">    }</span>

    @Test
    @DisplayName(&quot;Manejar edición análisis finalizado - analista cambia a PENDIENTE_APROBACION&quot;)
    void manejarEdicionAnalisisFinalizado_analista_cambiaEstado() {
<span class="fc" id="L156">        setRolAnalista(true);</span>
<span class="fc" id="L157">        analisis.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L158">        analisisService.manejarEdicionAnalisisFinalizado(analisis);</span>
<span class="fc" id="L159">        assertEquals(Estado.PENDIENTE_APROBACION, analisis.getEstado());</span>
<span class="fc" id="L160">        verify(analisisHistorialService, times(1)).registrarModificacion(analisis);</span>
<span class="fc" id="L161">    }</span>

    @Test
    @DisplayName(&quot;Manejar edición análisis finalizado - admin mantiene estado&quot;)
    void manejarEdicionAnalisisFinalizado_admin_noCambia() {
<span class="fc" id="L166">        setRolAnalista(false);</span>
<span class="fc" id="L167">        analisis.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L168">        analisisService.manejarEdicionAnalisisFinalizado(analisis);</span>
<span class="fc" id="L169">        assertEquals(Estado.APROBADO, analisis.getEstado());</span>
<span class="fc" id="L170">        verify(analisisHistorialService, never()).registrarModificacion(any());</span>
<span class="fc" id="L171">    }</span>

    @Test
    @DisplayName(&quot;Manejar edición análisis no aprobado - no hace nada&quot;)
    void manejarEdicionAnalisisFinalizado_noAprobado_noHaceNada() {
<span class="fc" id="L176">        setRolAnalista(true);</span>
<span class="fc" id="L177">        analisis.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L178">        analisisService.manejarEdicionAnalisisFinalizado(analisis);</span>
<span class="fc" id="L179">        verify(analisisHistorialService, never()).registrarModificacion(any());</span>
<span class="fc" id="L180">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Test
    @DisplayName(&quot;finalizarAnalisisGenerico - ejecuta validador, finaliza y mapea&quot;)
    void finalizarAnalisisGenerico_valida_yMapea() {
<span class="fc" id="L186">        setRolAnalista(false); // admin -&gt; estado aprobado</span>
<span class="fc" id="L187">        JpaRepository&lt;Germinacion, Long&gt; repo = mock(JpaRepository.class);</span>
<span class="fc" id="L188">        Germinacion g = new Germinacion();</span>
<span class="fc" id="L189">        g.setAnalisisID(10L);</span>
<span class="fc" id="L190">        g.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L191">        g.setActivo(true);</span>
<span class="fc" id="L192">        when(repo.findById(10L)).thenReturn(Optional.of(g));</span>
<span class="fc" id="L193">        when(repo.save(any(Germinacion.class))).thenAnswer(i -&gt; i.getArgument(0));</span>
<span class="fc" id="L194">        AtomicBoolean valido = new AtomicBoolean(false);</span>
<span class="fc" id="L195">        Consumer&lt;Germinacion&gt; validator = a -&gt; valido.set(true);</span>
<span class="fc" id="L196">        Function&lt;Germinacion, String&gt; mapper = a -&gt; &quot;MAPPED-&quot; + a.getEstado();</span>

<span class="fc" id="L198">        String res = analisisService.finalizarAnalisisGenerico(10L, repo, mapper, validator);</span>
<span class="fc" id="L199">        assertTrue(valido.get());</span>
<span class="fc" id="L200">        assertEquals(&quot;MAPPED-&quot; + Estado.APROBADO, res);</span>
<span class="fc" id="L201">        verify(repo, times(1)).save(any());</span>
<span class="fc" id="L202">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Test
    @DisplayName(&quot;aprobarAnalisisGenerico - con otro análisis válido debe fallar&quot;)
    void aprobarAnalisisGenerico_otroValido_falla() {
<span class="fc" id="L208">        JpaRepository&lt;Germinacion, Long&gt; repo = mock(JpaRepository.class);</span>
<span class="fc" id="L209">        Germinacion actual = new Germinacion();</span>
<span class="fc" id="L210">        actual.setAnalisisID(20L);</span>
<span class="fc" id="L211">        actual.setActivo(true);</span>
<span class="fc" id="L212">        actual.setEstado(Estado.A_REPETIR);</span>
<span class="fc" id="L213">        actual.setLote(new utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote());</span>
<span class="fc" id="L214">        actual.getLote().setLoteID(5L);</span>
<span class="fc" id="L215">        actual.getLote().setFicha(&quot;F-5&quot;);</span>
<span class="fc" id="L216">        when(repo.findById(20L)).thenReturn(Optional.of(actual));</span>

        // Otro análisis válido (activo y estado != A_REPETIR)
<span class="fc" id="L219">        Germinacion otro = new Germinacion();</span>
<span class="fc" id="L220">        otro.setAnalisisID(21L);</span>
<span class="fc" id="L221">        otro.setActivo(true);</span>
<span class="fc" id="L222">        otro.setEstado(Estado.EN_PROCESO);</span>

<span class="fc" id="L224">        Function&lt;Long, java.util.List&lt;Germinacion&gt;&gt; buscarPorLote = id -&gt; List.of(actual, otro);</span>

<span class="fc" id="L226">        assertThrows(RuntimeException.class, () -&gt;</span>
<span class="nc" id="L227">            analisisService.aprobarAnalisisGenerico(20L, repo, a -&gt; &quot;DTO&quot;, a -&gt; {}, buscarPorLote)</span>
        );
<span class="fc" id="L229">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Test
    @DisplayName(&quot;aprobarAnalisisGenerico - sin otros válidos aprueba y guarda&quot;)
    void aprobarAnalisisGenerico_sinOtroValido_ok() {
<span class="fc" id="L235">        JpaRepository&lt;Germinacion, Long&gt; repo = mock(JpaRepository.class);</span>
<span class="fc" id="L236">        Germinacion actual = new Germinacion();</span>
<span class="fc" id="L237">        actual.setAnalisisID(22L);</span>
<span class="fc" id="L238">        actual.setActivo(true);</span>
<span class="fc" id="L239">        actual.setEstado(Estado.PENDIENTE_APROBACION);</span>
<span class="fc" id="L240">        actual.setLote(new utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote());</span>
<span class="fc" id="L241">        actual.getLote().setLoteID(6L);</span>
<span class="fc" id="L242">        when(repo.findById(22L)).thenReturn(Optional.of(actual));</span>
<span class="fc" id="L243">        when(repo.save(any())).thenAnswer(i -&gt; i.getArgument(0));</span>

<span class="pc" id="L245">        Function&lt;Long, java.util.List&lt;Germinacion&gt;&gt; buscarPorLote = id -&gt; List.of(actual);</span>
<span class="fc" id="L246">        String dto = analisisService.aprobarAnalisisGenerico(22L, repo, a -&gt; &quot;DTO-OK&quot;, a -&gt; {}, buscarPorLote);</span>
<span class="fc" id="L247">        assertEquals(&quot;DTO-OK&quot;, dto);</span>
<span class="fc" id="L248">        verify(repo).save(any());</span>
<span class="fc" id="L249">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Test
    @DisplayName(&quot;marcarParaRepetirGenerico - cambia estado y guarda&quot;)
    void marcarParaRepetirGenerico_ok() {
<span class="fc" id="L255">        JpaRepository&lt;Germinacion, Long&gt; repo = mock(JpaRepository.class);</span>
<span class="fc" id="L256">        Germinacion g = new Germinacion();</span>
<span class="fc" id="L257">        g.setAnalisisID(30L);</span>
<span class="fc" id="L258">        g.setActivo(true);</span>
<span class="fc" id="L259">        g.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L260">        when(repo.findById(30L)).thenReturn(Optional.of(g));</span>
<span class="fc" id="L261">        when(repo.save(any())).thenAnswer(i -&gt; i.getArgument(0));</span>
<span class="fc" id="L262">        String dto = analisisService.marcarParaRepetirGenerico(30L, repo, a -&gt; &quot;DTO&quot;, a -&gt; {});</span>
<span class="fc" id="L263">        assertEquals(&quot;DTO&quot;, dto);</span>
<span class="fc" id="L264">        assertEquals(Estado.A_REPETIR, g.getEstado());</span>
<span class="fc" id="L265">        verify(analisisHistorialService, times(1)).registrarModificacion(g);</span>
<span class="fc" id="L266">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Test
    @DisplayName(&quot;desactivarAnalisis - pone activo=false y guarda&quot;)
    void desactivarAnalisis_ok() {
<span class="fc" id="L272">        JpaRepository&lt;Germinacion, Long&gt; repo = mock(JpaRepository.class);</span>
<span class="fc" id="L273">        Germinacion g = new Germinacion();</span>
<span class="fc" id="L274">        g.setAnalisisID(40L);</span>
<span class="fc" id="L275">        g.setActivo(true);</span>
<span class="fc" id="L276">        when(repo.findById(40L)).thenReturn(Optional.of(g));</span>
<span class="fc" id="L277">        analisisService.desactivarAnalisis(40L, repo);</span>
<span class="fc" id="L278">        assertFalse(g.getActivo());</span>
<span class="fc" id="L279">        verify(repo).save(g);</span>
<span class="fc" id="L280">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Test
    @DisplayName(&quot;reactivarAnalisis - éxito y error si ya activo&quot;)
    void reactivarAnalisis_casos() {
<span class="fc" id="L286">        JpaRepository&lt;Germinacion, Long&gt; repo = mock(JpaRepository.class);</span>
<span class="fc" id="L287">        Germinacion inactivo = new Germinacion();</span>
<span class="fc" id="L288">        inactivo.setAnalisisID(50L);</span>
<span class="fc" id="L289">        inactivo.setActivo(false);</span>
<span class="fc" id="L290">        when(repo.findById(50L)).thenReturn(Optional.of(inactivo));</span>
<span class="fc" id="L291">        when(repo.save(any())).thenAnswer(i -&gt; i.getArgument(0));</span>
<span class="fc" id="L292">        String dto = analisisService.reactivarAnalisis(50L, repo, a -&gt; &quot;DTO&quot;);</span>
<span class="fc" id="L293">        assertEquals(&quot;DTO&quot;, dto);</span>
<span class="fc" id="L294">        assertTrue(inactivo.getActivo());</span>

<span class="fc" id="L296">        Germinacion activo = new Germinacion();</span>
<span class="fc" id="L297">        activo.setAnalisisID(51L);</span>
<span class="fc" id="L298">        activo.setActivo(true);</span>
<span class="fc" id="L299">        when(repo.findById(51L)).thenReturn(Optional.of(activo));</span>
<span class="pc" id="L300">        assertThrows(RuntimeException.class, () -&gt; analisisService.reactivarAnalisis(51L, repo, a -&gt; &quot;X&quot;));</span>
<span class="fc" id="L301">    }</span>

    @Test
    @DisplayName(&quot;Marcar para repetir - debe cambiar a A_REPETIR&quot;)
    void marcarParaRepetir_debeCambiarARepetir() {
<span class="fc" id="L306">        analisis.setEstado(Estado.APROBADO);</span>

<span class="fc" id="L308">        Analisis resultado = analisisService.marcarParaRepetir(analisis);</span>

<span class="fc" id="L310">        assertEquals(Estado.A_REPETIR, resultado.getEstado());</span>
<span class="fc" id="L311">        verify(analisisHistorialService, times(1)).registrarModificacion(analisis);</span>
<span class="fc" id="L312">    }</span>

    @Test
    @DisplayName(&quot;Marcar para repetir análisis inactivo - debe lanzar excepción&quot;)
    void marcarParaRepetir_analisisInactivo_debeLanzarExcepcion() {
<span class="fc" id="L317">        analisis.setActivo(false);</span>

<span class="fc" id="L319">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L320">            analisisService.marcarParaRepetir(analisis);</span>
<span class="nc" id="L321">        });</span>

<span class="fc" id="L323">        assertEquals(&quot;No se puede marcar para repetir un análisis inactivo&quot;, exception.getMessage());</span>
<span class="fc" id="L324">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>