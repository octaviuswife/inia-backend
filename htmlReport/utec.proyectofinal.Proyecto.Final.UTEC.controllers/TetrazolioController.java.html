<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TetrazolioController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepPmsControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.controllers</a> &gt; <span class="el_source">TetrazolioController.java</span></div><h1>TetrazolioController.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.controllers;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PorcentajesRedondeadosRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.TetrazolioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.TetrazolioDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.responses.ResponseListadoTetrazolio;
import utec.proyectofinal.Proyecto.Final.UTEC.services.TetrazolioService;

// CORS configurado globalmente en WebSecurityConfig
@RestController
@RequestMapping(&quot;/api/tetrazolios&quot;)
@Tag(name = &quot;Tetrazolio&quot;, description = &quot;API para gestión del análisis de tetrazolio&quot;)
@SecurityRequirement(name = &quot;bearerAuth&quot;)
<span class="fc" id="L32">public class TetrazolioController {</span>

    @Autowired
    private TetrazolioService tetrazolioService;

    // Crear nuevo Tetrazolio
    @Operation(summary = &quot;Crear análisis de tetrazolio&quot;, 
              description = &quot;Crea un nuevo análisis de tetrazolio con numeroRepeticiones y numeroConteos definidos&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN')&quot;)
    @PostMapping
    public ResponseEntity&lt;TetrazolioDTO&gt; crearTetrazolio(@RequestBody TetrazolioRequestDTO solicitud) {
<span class="fc" id="L43">        TetrazolioDTO tetrazolioCreado = tetrazolioService.crearTetrazolio(solicitud);</span>
<span class="fc" id="L44">        return ResponseEntity.status(HttpStatus.CREATED).body(tetrazolioCreado);</span>
    }

    // Obtener todos los Tetrazolios activos
    @Operation(summary = &quot;Listar todos los análisis de tetrazolio&quot;, 
              description = &quot;Obtiene todos los análisis de tetrazolio activos en el sistema&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN') or hasRole('OBSERVADOR')&quot;)
    @GetMapping
    public ResponseEntity&lt;ResponseListadoTetrazolio&gt; obtenerTodosTetrazolio() {
<span class="fc" id="L53">        ResponseListadoTetrazolio response = tetrazolioService.obtenerTodosTetrazolio();</span>
<span class="fc" id="L54">        return ResponseEntity.ok(response);</span>
    }

    // Obtener Tetrazolio por ID
    @Operation(summary = &quot;Obtener análisis de tetrazolio por ID&quot;, 
              description = &quot;Obtiene un análisis de tetrazolio específico por su ID&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN') or hasRole('OBSERVADOR')&quot;)
    @GetMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;TetrazolioDTO&gt; obtenerTetrazolioPorId(@PathVariable Long id) {
<span class="fc" id="L63">        TetrazolioDTO tetrazolio = tetrazolioService.obtenerTetrazolioPorId(id);</span>
<span class="fc" id="L64">        return ResponseEntity.ok(tetrazolio);</span>
    }

    // Actualizar Tetrazolio
    @Operation(summary = &quot;Actualizar análisis de tetrazolio&quot;, 
              description = &quot;Actualiza los detalles de un análisis de tetrazolio existente&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN')&quot;)
    @PutMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;TetrazolioDTO&gt; actualizarTetrazolio(@PathVariable Long id, @RequestBody TetrazolioRequestDTO solicitud) {
<span class="fc" id="L73">        TetrazolioDTO tetrazolioActualizado = tetrazolioService.actualizarTetrazolio(id, solicitud);</span>
<span class="fc" id="L74">        return ResponseEntity.ok(tetrazolioActualizado);</span>
    }

    // Actualizar porcentajes redondeados (solo cuando todas las repeticiones estén completas)
    @Operation(summary = &quot;Actualizar porcentajes redondeados&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN')&quot;)
    @PutMapping(&quot;/{id}/porcentajes&quot;)
    public ResponseEntity&lt;TetrazolioDTO&gt; actualizarPorcentajesRedondeados(@PathVariable Long id, @RequestBody PorcentajesRedondeadosRequestDTO solicitud) {
<span class="fc" id="L82">        TetrazolioDTO tetrazolioActualizado = tetrazolioService.actualizarPorcentajesRedondeados(id, solicitud);</span>
<span class="fc" id="L83">        return ResponseEntity.ok(tetrazolioActualizado);</span>
    }

    // Eliminar Tetrazolio (cambiar estado a INACTIVO)
    @Operation(summary = &quot;Eliminar análisis de tetrazolio&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN')&quot;)
    @DeleteMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;Void&gt; eliminarTetrazolio(@PathVariable Long id) {
<span class="fc" id="L91">        tetrazolioService.desactivarTetrazolio(id);</span>
<span class="fc" id="L92">        return ResponseEntity.noContent().build();</span>
    }

    // Desactivar Tetrazolio (soft delete)
    @Operation(summary = &quot;Desactivar análisis Tetrazolio&quot;, 
              description = &quot;Desactiva un análisis Tetrazolio (cambiar activo a false)&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @PutMapping(&quot;/{id}/desactivar&quot;)
    public ResponseEntity&lt;Void&gt; desactivarTetrazolio(@PathVariable Long id) {
<span class="fc" id="L101">        tetrazolioService.desactivarTetrazolio(id);</span>
<span class="fc" id="L102">        return ResponseEntity.ok().build();</span>
    }

    // Reactivar Tetrazolio
    @Operation(summary = &quot;Reactivar análisis Tetrazolio&quot;, 
              description = &quot;Reactiva un análisis Tetrazolio desactivado (solo administradores)&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @PutMapping(&quot;/{id}/reactivar&quot;)
    public ResponseEntity&lt;TetrazolioDTO&gt; reactivarTetrazolio(@PathVariable Long id) {
<span class="fc" id="L111">        TetrazolioDTO tetrazolioReactivado = tetrazolioService.reactivarTetrazolio(id);</span>
<span class="fc" id="L112">        return ResponseEntity.ok(tetrazolioReactivado);</span>
    }

    // Obtener Tetrazolios por Lote
    @Operation(summary = &quot;Obtener tetrazolios por lote&quot;, 
              description = &quot;Obtiene todos los análisis de tetrazolio asociados a un lote específico&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN') or hasRole('OBSERVADOR')&quot;)
    @GetMapping(&quot;/lote/{idLote}&quot;)
    public ResponseEntity&lt;List&lt;TetrazolioDTO&gt;&gt; obtenerTetrazoliosPorIdLote(@PathVariable Long idLote) {
<span class="fc" id="L121">        List&lt;TetrazolioDTO&gt; tetrazolios = tetrazolioService.obtenerTetrazoliosPorIdLote(idLote);</span>
<span class="fc" id="L122">        return ResponseEntity.ok(tetrazolios);</span>
    }

    // Obtener Tetrazolios con paginado para listado
    @Operation(summary = &quot;Obtener tetrazolios paginadas&quot;, 
              description = &quot;Obtiene la lista paginada de análisis de tetrazolio para el listado&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN') or hasRole('OBSERVADOR')&quot;)
    @GetMapping(&quot;/listado&quot;)
    public ResponseEntity&lt;org.springframework.data.domain.Page&lt;utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.TetrazolioListadoDTO&gt;&gt; obtenerTetrazoliosPaginadas(
            @org.springframework.web.bind.annotation.RequestParam(defaultValue = &quot;0&quot;) int page,
            @org.springframework.web.bind.annotation.RequestParam(defaultValue = &quot;10&quot;) int size,
            @org.springframework.web.bind.annotation.RequestParam(required = false) String search,
            @org.springframework.web.bind.annotation.RequestParam(required = false) Boolean activo,
            @org.springframework.web.bind.annotation.RequestParam(required = false) String estado,
            @org.springframework.web.bind.annotation.RequestParam(required = false) Long loteId) {
<span class="fc" id="L137">        org.springframework.data.domain.Pageable pageable = org.springframework.data.domain.PageRequest.of(page, size);</span>
<span class="fc" id="L138">        org.springframework.data.domain.Page&lt;utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.TetrazolioListadoDTO&gt; response = tetrazolioService.obtenerTetrazoliosPaginadasConFiltros(pageable, search, activo, estado, loteId);</span>
<span class="fc" id="L139">        return ResponseEntity.ok(response);</span>
    }

    // Finalizar análisis de tetrazolio
    @Operation(summary = &quot;Finalizar análisis de tetrazolio&quot;, 
              description = &quot;Finaliza un análisis de tetrazolio cambiando su estado según el rol del usuario (analista -&gt; PENDIENTE_APROBACION, admin -&gt; APROBADO)&quot;)
    @PreAuthorize(&quot;hasRole('ANALISTA') or hasRole('ADMIN')&quot;)
    @PutMapping(&quot;/{id}/finalizar&quot;)
    public ResponseEntity&lt;TetrazolioDTO&gt; finalizarAnalisis(@PathVariable Long id) {
<span class="fc" id="L148">        TetrazolioDTO tetrazolioFinalizado = tetrazolioService.finalizarAnalisis(id);</span>
<span class="fc" id="L149">        return ResponseEntity.ok(tetrazolioFinalizado);</span>
    }

    // Aprobar análisis (solo admin)
    @Operation(summary = &quot;Aprobar análisis de tetrazolio&quot;, 
              description = &quot;Aprueba un análisis de tetrazolio, cambiando su estado a APROBADO (solo administradores)&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @PutMapping(&quot;/{id}/aprobar&quot;)
    public ResponseEntity&lt;TetrazolioDTO&gt; aprobarAnalisis(@PathVariable Long id) {
<span class="fc" id="L158">        TetrazolioDTO tetrazolioAprobado = tetrazolioService.aprobarAnalisis(id);</span>
<span class="fc" id="L159">        return ResponseEntity.ok(tetrazolioAprobado);</span>
    }

    // Marcar análisis para repetir (solo admin)
    @Operation(summary = &quot;Marcar análisis de tetrazolio para repetir&quot;, 
              description = &quot;Marca un análisis de tetrazolio para repetir - solo administradores&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @PutMapping(&quot;/{id}/repetir&quot;)
    public ResponseEntity&lt;TetrazolioDTO&gt; marcarParaRepetir(@PathVariable Long id) {
<span class="fc" id="L168">        TetrazolioDTO tetrazolioRepetir = tetrazolioService.marcarParaRepetir(id);</span>
<span class="fc" id="L169">        return ResponseEntity.ok(tetrazolioRepetir);</span>
    }
    }
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>