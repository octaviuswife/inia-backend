<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DosnControllerIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepPmsControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.controllers</a> &gt; <span class="el_source">DosnControllerIntegrationTest.java</span></div><h1>DosnControllerIntegrationTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.controllers;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.MediaType;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.DosnRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.DosnDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.DosnListadoDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;
import utec.proyectofinal.Proyecto.Final.UTEC.responses.ResponseListadoDosn;
import utec.proyectofinal.Proyecto.Final.UTEC.services.DosnService;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.doNothing;
import static org.mockito.Mockito.when;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.csrf;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(DosnController.class)
@DisplayName(&quot;Tests de integración para DosnController&quot;)
<span class="fc" id="L36">class DosnControllerIntegrationTest {</span>

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @MockitoBean
    private DosnService dosnService;

    private DosnDTO dosnDTO;
    private DosnRequestDTO dosnRequestDTO;

    @BeforeEach
    void setUp() {
<span class="fc" id="L52">        dosnDTO = new DosnDTO();</span>
<span class="fc" id="L53">        dosnDTO.setAnalisisID(1L);</span>
<span class="fc" id="L54">        dosnDTO.setIdLote(100L);</span>
<span class="fc" id="L55">        dosnDTO.setComentarios(&quot;Test DOSN&quot;);</span>
<span class="fc" id="L56">        dosnDTO.setFechaInicio(LocalDateTime.now());</span>
<span class="fc" id="L57">        dosnDTO.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L58">        dosnDTO.setActivo(true);</span>

<span class="fc" id="L60">        dosnRequestDTO = new DosnRequestDTO();</span>
<span class="fc" id="L61">        dosnRequestDTO.setIdLote(100L);</span>
<span class="fc" id="L62">        dosnRequestDTO.setComentarios(&quot;Test DOSN&quot;);</span>
<span class="fc" id="L63">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;POST /api/dosn - Crear DOSN exitosamente&quot;)
    void crearDosn_debeRetornarDosnCreado() throws Exception {
<span class="fc" id="L69">        when(dosnService.crearDosn(any(DosnRequestDTO.class))).thenReturn(dosnDTO);</span>

<span class="fc" id="L71">        mockMvc.perform(post(&quot;/api/dosn&quot;)</span>
<span class="fc" id="L72">                .with(csrf())</span>
<span class="fc" id="L73">                .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L74">                .content(objectMapper.writeValueAsString(dosnRequestDTO)))</span>
<span class="fc" id="L75">                .andExpect(status().isCreated())</span>
<span class="fc" id="L76">                .andExpect(jsonPath(&quot;$.analisisID&quot;).value(1))</span>
<span class="fc" id="L77">                .andExpect(jsonPath(&quot;$.idLote&quot;).value(100))</span>
<span class="fc" id="L78">                .andExpect(jsonPath(&quot;$.estado&quot;).value(&quot;EN_PROCESO&quot;));</span>
<span class="fc" id="L79">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;GET /api/dosn - Obtener todas las DOSN&quot;)
    void obtenerTodasDosnActivas_debeRetornarRespuesta() throws Exception {
<span class="fc" id="L85">        ResponseListadoDosn response = new ResponseListadoDosn();</span>
<span class="fc" id="L86">        response.setDosns(Arrays.asList(dosnDTO));</span>
<span class="fc" id="L87">        when(dosnService.obtenerTodasDosnActivas()).thenReturn(response);</span>

<span class="fc" id="L89">        mockMvc.perform(get(&quot;/api/dosn&quot;)</span>
<span class="fc" id="L90">                .with(csrf()))</span>
<span class="fc" id="L91">                .andExpect(status().isOk())</span>
<span class="fc" id="L92">                .andExpect(jsonPath(&quot;$.dosns[0].analisisID&quot;).value(1));</span>
<span class="fc" id="L93">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/dosn/{id} - Obtener DOSN por ID&quot;)
    void obtenerDosnPorId_debeRetornarDosn() throws Exception {
<span class="fc" id="L99">        when(dosnService.obtenerDosnPorId(1L)).thenReturn(dosnDTO);</span>

<span class="fc" id="L101">        mockMvc.perform(get(&quot;/api/dosn/1&quot;)</span>
<span class="fc" id="L102">                .with(csrf()))</span>
<span class="fc" id="L103">                .andExpect(status().isOk())</span>
<span class="fc" id="L104">                .andExpect(jsonPath(&quot;$.analisisID&quot;).value(1))</span>
<span class="fc" id="L105">                .andExpect(jsonPath(&quot;$.idLote&quot;).value(100));</span>
<span class="fc" id="L106">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/dosn/listado - Obtener DOSN paginadas&quot;)
    void obtenerDosnPaginadas_debeRetornarPaginacion() throws Exception {
<span class="fc" id="L112">        DosnListadoDTO listadoDTO = new DosnListadoDTO();</span>
<span class="fc" id="L113">        listadoDTO.setAnalisisID(1L);</span>
<span class="fc" id="L114">        listadoDTO.setIdLote(100L);</span>
<span class="fc" id="L115">        listadoDTO.setEstado(Estado.EN_PROCESO);</span>

<span class="fc" id="L117">        Page&lt;DosnListadoDTO&gt; page = new PageImpl&lt;&gt;(Arrays.asList(listadoDTO), PageRequest.of(0, 10), 1);</span>
<span class="fc" id="L118">        when(dosnService.obtenerDosnPaginadasConFiltros(any(), any(), any(), any(), any())).thenReturn(page);</span>

<span class="fc" id="L120">        mockMvc.perform(get(&quot;/api/dosn/listado&quot;)</span>
<span class="fc" id="L121">                .param(&quot;page&quot;, &quot;0&quot;)</span>
<span class="fc" id="L122">                .param(&quot;size&quot;, &quot;10&quot;)</span>
<span class="fc" id="L123">                .with(csrf()))</span>
<span class="fc" id="L124">                .andExpect(status().isOk())</span>
<span class="fc" id="L125">                .andExpect(jsonPath(&quot;$.content[0].analisisID&quot;).value(1))</span>
<span class="fc" id="L126">                .andExpect(jsonPath(&quot;$.page.totalElements&quot;).value(1));</span>
<span class="fc" id="L127">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;PUT /api/dosn/{id} - Actualizar DOSN&quot;)
    void actualizarDosn_debeRetornarDosnActualizado() throws Exception {
<span class="fc" id="L133">        dosnDTO.setComentarios(&quot;Actualizado&quot;);</span>
<span class="fc" id="L134">        when(dosnService.actualizarDosn(eq(1L), any(DosnRequestDTO.class))).thenReturn(dosnDTO);</span>

<span class="fc" id="L136">        mockMvc.perform(put(&quot;/api/dosn/1&quot;)</span>
<span class="fc" id="L137">                .with(csrf())</span>
<span class="fc" id="L138">                .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L139">                .content(objectMapper.writeValueAsString(dosnRequestDTO)))</span>
<span class="fc" id="L140">                .andExpect(status().isOk())</span>
<span class="fc" id="L141">                .andExpect(jsonPath(&quot;$.comentarios&quot;).value(&quot;Actualizado&quot;));</span>
<span class="fc" id="L142">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;DELETE /api/dosn/{id} - Eliminar DOSN&quot;)
    void eliminarDosn_debeRetornarNoContent() throws Exception {
<span class="fc" id="L148">        doNothing().when(dosnService).eliminarDosn(1L);</span>

<span class="fc" id="L150">        mockMvc.perform(delete(&quot;/api/dosn/1&quot;)</span>
<span class="fc" id="L151">                .with(csrf()))</span>
<span class="fc" id="L152">                .andExpect(status().isNoContent());</span>
<span class="fc" id="L153">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;PUT /api/dosn/{id}/desactivar - Desactivar DOSN&quot;)
    void desactivarDosn_debeRetornarOk() throws Exception {
<span class="fc" id="L159">        doNothing().when(dosnService).desactivarDosn(1L);</span>

<span class="fc" id="L161">        mockMvc.perform(put(&quot;/api/dosn/1/desactivar&quot;)</span>
<span class="fc" id="L162">                .with(csrf()))</span>
<span class="fc" id="L163">                .andExpect(status().isOk());</span>
<span class="fc" id="L164">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;PUT /api/dosn/{id}/reactivar - Reactivar DOSN&quot;)
    void reactivarDosn_debeRetornarDosnReactivado() throws Exception {
<span class="fc" id="L170">        when(dosnService.reactivarDosn(1L)).thenReturn(dosnDTO);</span>

<span class="fc" id="L172">        mockMvc.perform(put(&quot;/api/dosn/1/reactivar&quot;)</span>
<span class="fc" id="L173">                .with(csrf()))</span>
<span class="fc" id="L174">                .andExpect(status().isOk())</span>
<span class="fc" id="L175">                .andExpect(jsonPath(&quot;$.analisisID&quot;).value(1));</span>
<span class="fc" id="L176">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/dosn/lote/{idLote} - Obtener DOSN por lote&quot;)
    void obtenerDosnPorIdLote_debeRetornarLista() throws Exception {
<span class="fc" id="L182">        List&lt;DosnDTO&gt; lista = Arrays.asList(dosnDTO);</span>
<span class="fc" id="L183">        when(dosnService.obtenerDosnPorIdLote(100)).thenReturn(lista);</span>

<span class="fc" id="L185">        mockMvc.perform(get(&quot;/api/dosn/lote/100&quot;)</span>
<span class="fc" id="L186">                .with(csrf()))</span>
<span class="fc" id="L187">                .andExpect(status().isOk())</span>
<span class="fc" id="L188">                .andExpect(jsonPath(&quot;$[0].analisisID&quot;).value(1))</span>
<span class="fc" id="L189">                .andExpect(jsonPath(&quot;$[0].idLote&quot;).value(100));</span>
<span class="fc" id="L190">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;PUT /api/dosn/{id}/finalizar - Finalizar análisis&quot;)
    void finalizarAnalisis_debeRetornarDosnFinalizado() throws Exception {
<span class="fc" id="L196">        dosnDTO.setEstado(Estado.PENDIENTE_APROBACION);</span>
<span class="fc" id="L197">        when(dosnService.finalizarAnalisis(1L)).thenReturn(dosnDTO);</span>

<span class="fc" id="L199">        mockMvc.perform(put(&quot;/api/dosn/1/finalizar&quot;)</span>
<span class="fc" id="L200">                .with(csrf()))</span>
<span class="fc" id="L201">                .andExpect(status().isOk())</span>
<span class="fc" id="L202">                .andExpect(jsonPath(&quot;$.estado&quot;).value(&quot;PENDIENTE_APROBACION&quot;));</span>
<span class="fc" id="L203">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;PUT /api/dosn/{id}/aprobar - Aprobar análisis&quot;)
    void aprobarAnalisis_debeRetornarDosnAprobado() throws Exception {
<span class="fc" id="L209">        dosnDTO.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L210">        when(dosnService.aprobarAnalisis(1L)).thenReturn(dosnDTO);</span>

<span class="fc" id="L212">        mockMvc.perform(put(&quot;/api/dosn/1/aprobar&quot;)</span>
<span class="fc" id="L213">                .with(csrf()))</span>
<span class="fc" id="L214">                .andExpect(status().isOk())</span>
<span class="fc" id="L215">                .andExpect(jsonPath(&quot;$.estado&quot;).value(&quot;APROBADO&quot;));</span>
<span class="fc" id="L216">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;PUT /api/dosn/{id}/repetir - Marcar para repetir&quot;)
    void marcarParaRepetir_debeRetornarDosnParaRepetir() throws Exception {
<span class="fc" id="L222">        dosnDTO.setEstado(Estado.A_REPETIR);</span>
<span class="fc" id="L223">        when(dosnService.marcarParaRepetir(1L)).thenReturn(dosnDTO);</span>

<span class="fc" id="L225">        mockMvc.perform(put(&quot;/api/dosn/1/repetir&quot;)</span>
<span class="fc" id="L226">                .with(csrf()))</span>
<span class="fc" id="L227">                .andExpect(status().isOk())</span>
<span class="fc" id="L228">                .andExpect(jsonPath(&quot;$.estado&quot;).value(&quot;A_REPETIR&quot;));</span>
<span class="fc" id="L229">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>