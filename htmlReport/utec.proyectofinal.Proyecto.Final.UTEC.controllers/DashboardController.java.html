<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DashboardController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepPmsControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, RepTetrazolioViabilidadControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, Auth2FAControllerIntegrationTest Coverage Results, java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.controllers</a> &gt; <span class="el_source">DashboardController.java</span></div><h1>DashboardController.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.controllers;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import utec.proyectofinal.Proyecto.Final.UTEC.dtos.AnalisisPendienteDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.AnalisisPorAprobarDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.DashboardStatsDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.CursorPageResponse;
import utec.proyectofinal.Proyecto.Final.UTEC.exceptions.InvalidCursorException;
import utec.proyectofinal.Proyecto.Final.UTEC.services.DashboardService;

// CORS configurado globalmente en WebSecurityConfig
@RestController
@RequestMapping(&quot;/api/dashboard&quot;)
<span class="fc" id="L25">public class DashboardController {</span>

    @Autowired
    private DashboardService dashboardService;

    @GetMapping(&quot;/stats&quot;)
    public ResponseEntity&lt;DashboardStatsDTO&gt; obtenerEstadisticas() {
        try {
<span class="fc" id="L33">            DashboardStatsDTO stats = dashboardService.obtenerEstadisticas();</span>
<span class="fc" id="L34">            return ResponseEntity.ok(stats);</span>
<span class="fc" id="L35">        } catch (Exception e) {</span>
<span class="fc" id="L36">            System.err.println(&quot;Error al obtener estadísticas del dashboard: &quot; + e.getMessage());</span>
<span class="fc" id="L37">            e.printStackTrace();</span>
<span class="fc" id="L38">            return ResponseEntity.internalServerError().build();</span>
        }
    }
    
    /**
     * Endpoint offset estándar para análisis pendientes.
     * Usa paginación con page/size para navegación de páginas.
     * 
     * @param page Número de página (base 0)
     * @param size Número de items por página (default 10)
     * @return Página de análisis pendientes
     */
    @GetMapping(&quot;/analisis-pendientes&quot;)
    public ResponseEntity&lt;Page&lt;AnalisisPendienteDTO&gt;&gt; obtenerAnalisisPendientes(
            @RequestParam(defaultValue = &quot;0&quot;) int page,
            @RequestParam(defaultValue = &quot;10&quot;) int size) {
        try {
<span class="fc" id="L55">            Pageable pageable = PageRequest.of(page, size);</span>
<span class="fc" id="L56">            Page&lt;AnalisisPendienteDTO&gt; response = dashboardService.listarAnalisisPendientesPaginados(pageable);</span>
<span class="fc" id="L57">            return ResponseEntity.ok(response);</span>
<span class="fc" id="L58">        } catch (Exception e) {</span>
<span class="fc" id="L59">            System.err.println(&quot;Error al obtener análisis pendientes: &quot; + e.getMessage());</span>
<span class="fc" id="L60">            e.printStackTrace();</span>
<span class="fc" id="L61">            return ResponseEntity.internalServerError().build();</span>
        }
    }
    
    /**
     * Endpoint offset estándar para análisis por aprobar.
     * Usa paginación con page/size para navegación de páginas.
     * 
     * @param page Número de página (base 0)
     * @param size Número de items por página (default 10)
     * @return Página de análisis por aprobar
     */
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @GetMapping(&quot;/analisis-por-aprobar&quot;)
    public ResponseEntity&lt;Page&lt;AnalisisPorAprobarDTO&gt;&gt; obtenerAnalisisPorAprobar(
            @RequestParam(defaultValue = &quot;0&quot;) int page,
            @RequestParam(defaultValue = &quot;10&quot;) int size) {
        try {
<span class="fc" id="L79">            Pageable pageable = PageRequest.of(page, size);</span>
<span class="fc" id="L80">            Page&lt;AnalisisPorAprobarDTO&gt; response = dashboardService.listarAnalisisPorAprobarPaginados(pageable);</span>
<span class="fc" id="L81">            return ResponseEntity.ok(response);</span>
<span class="fc" id="L82">        } catch (Exception e) {</span>
<span class="fc" id="L83">            System.err.println(&quot;Error al obtener análisis por aprobar: &quot; + e.getMessage());</span>
<span class="fc" id="L84">            e.printStackTrace();</span>
<span class="fc" id="L85">            return ResponseEntity.internalServerError().build();</span>
        }
    }
    
    /**
     * Endpoint keyset para análisis pendientes.
     * Usa cursor Base64 para paginación eficiente sin OFFSET.
     * 
     * @param cursor Base64-encoded cursor de la última página (opcional para primera página)
     * @param size Número de items por página (default 20)
     * @return Página con items y nextCursor
     */
    @GetMapping(&quot;/analisis-pendientes/keyset&quot;)
    public ResponseEntity&lt;?&gt; obtenerAnalisisPendientesKeyset(
            @RequestParam(required = false) String cursor,
            @RequestParam(defaultValue = &quot;20&quot;) int size) {
        try {
<span class="fc" id="L102">            CursorPageResponse&lt;AnalisisPendienteDTO&gt; response = </span>
<span class="fc" id="L103">                dashboardService.listarAnalisisPendientesKeyset(cursor, size);</span>
<span class="fc" id="L104">            return ResponseEntity.ok(response);</span>
<span class="fc" id="L105">        } catch (InvalidCursorException e) {</span>
<span class="fc" id="L106">            return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L107">                .body(new ErrorResponse(&quot;Cursor inválido: &quot; + e.getMessage()));</span>
<span class="fc" id="L108">        } catch (Exception e) {</span>
<span class="fc" id="L109">            System.err.println(&quot;Error keyset analisis pendientes: &quot; + e.getMessage());</span>
<span class="fc" id="L110">            e.printStackTrace();</span>
<span class="fc" id="L111">            return ResponseEntity.internalServerError().build();</span>
        }
    }
    
    /**
     * Endpoint keyset para análisis por aprobar.
     * Usa cursor Base64 para paginación eficiente sin OFFSET.
     * 
     * @param cursor Base64-encoded cursor de la última página (opcional para primera página)
     * @param size Número de items por página (default 20)
     * @return Página con items y nextCursor
     */
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @GetMapping(&quot;/analisis-por-aprobar/keyset&quot;)
    public ResponseEntity&lt;?&gt; obtenerAnalisisPorAprobarKeyset(
            @RequestParam(required = false) String cursor,
            @RequestParam(defaultValue = &quot;20&quot;) int size) {
        try {
<span class="fc" id="L129">            CursorPageResponse&lt;AnalisisPorAprobarDTO&gt; response = </span>
<span class="fc" id="L130">                dashboardService.listarAnalisisPorAprobarKeyset(cursor, size);</span>
<span class="fc" id="L131">            return ResponseEntity.ok(response);</span>
<span class="fc" id="L132">        } catch (InvalidCursorException e) {</span>
<span class="fc" id="L133">            return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L134">                .body(new ErrorResponse(&quot;Cursor inválido: &quot; + e.getMessage()));</span>
<span class="fc" id="L135">        } catch (Exception e) {</span>
<span class="fc" id="L136">            System.err.println(&quot;Error keyset analisis por aprobar: &quot; + e.getMessage());</span>
<span class="fc" id="L137">            e.printStackTrace();</span>
<span class="fc" id="L138">            return ResponseEntity.internalServerError().build();</span>
        }
    }
    
    /**
     * DTO simple para respuestas de error.
     */
    private static class ErrorResponse {
        public final String error;
        
<span class="fc" id="L148">        public ErrorResponse(String error) {</span>
<span class="fc" id="L149">            this.error = error;</span>
<span class="fc" id="L150">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>