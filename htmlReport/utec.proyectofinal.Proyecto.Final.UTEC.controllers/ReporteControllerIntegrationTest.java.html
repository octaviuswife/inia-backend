<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReporteControllerIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.controllers</a> &gt; <span class="el_source">ReporteControllerIntegrationTest.java</span></div><h1>ReporteControllerIntegrationTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.controllers;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.*;
import utec.proyectofinal.Proyecto.Final.UTEC.services.ReporteService;

import java.time.LocalDate;
import java.util.HashMap;
import java.util.Map;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.when;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.csrf;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(ReporteController.class)
@DisplayName(&quot;Tests de integraci贸n para ReporteController&quot;)
<span class="fc" id="L26">class ReporteControllerIntegrationTest {</span>

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private ReporteService reporteService;

    private ReporteGeneralDTO reporteGeneralDTO;
    private ReporteGerminacionDTO reporteGerminacionDTO;
    private ReportePMSDTO reportePMSDTO;
    private ReportePurezaDTO reportePurezaDTO;
    private ReporteTetrazolioDTO reporteTetrazolioDTO;

    @BeforeEach
    void setUp() {
<span class="fc" id="L42">        Map&lt;String, Long&gt; analisisPorPeriodo = new HashMap&lt;&gt;();</span>
<span class="fc" id="L43">        analisisPorPeriodo.put(&quot;2024-01&quot;, 10L);</span>
<span class="fc" id="L44">        analisisPorPeriodo.put(&quot;2024-02&quot;, 15L);</span>

<span class="fc" id="L46">        Map&lt;String, Long&gt; analisisPorEstado = new HashMap&lt;&gt;();</span>
<span class="fc" id="L47">        analisisPorEstado.put(&quot;APROBADO&quot;, 20L);</span>
<span class="fc" id="L48">        analisisPorEstado.put(&quot;EN_PROCESO&quot;, 5L);</span>

<span class="fc" id="L50">        Map&lt;String, Double&gt; porcentajeCompletitud = new HashMap&lt;&gt;();</span>
<span class="fc" id="L51">        porcentajeCompletitud.put(&quot;completitud&quot;, 80.0);</span>

<span class="fc" id="L53">        Map&lt;String, Long&gt; topAnalisisProblemas = new HashMap&lt;&gt;();</span>
<span class="fc" id="L54">        topAnalisisProblemas.put(&quot;Germinacion&quot;, 3L);</span>
<span class="fc" id="L55">        topAnalisisProblemas.put(&quot;PMS&quot;, 2L);</span>

<span class="fc" id="L57">        reporteGeneralDTO = new ReporteGeneralDTO(</span>
<span class="fc" id="L58">            25L,</span>
            analisisPorPeriodo,
            analisisPorEstado,
            porcentajeCompletitud,
<span class="fc" id="L62">            7.5,</span>
            topAnalisisProblemas
        );

<span class="fc" id="L66">        Map&lt;String, Double&gt; mediaGerminacionPorEspecie = new HashMap&lt;&gt;();</span>
<span class="fc" id="L67">        mediaGerminacionPorEspecie.put(&quot;Trigo&quot;, 85.5);</span>
<span class="fc" id="L68">        mediaGerminacionPorEspecie.put(&quot;Cebada&quot;, 78.3);</span>

<span class="fc" id="L70">        Map&lt;String, Double&gt; tiempoPromedioPrimerConteo = new HashMap&lt;&gt;();</span>
<span class="fc" id="L71">        tiempoPromedioPrimerConteo.put(&quot;Trigo&quot;, 5.0);</span>

<span class="fc" id="L73">        Map&lt;String, Double&gt; tiempoPromedioUltimoConteo = new HashMap&lt;&gt;();</span>
<span class="fc" id="L74">        tiempoPromedioUltimoConteo.put(&quot;Trigo&quot;, 10.0);</span>

<span class="fc" id="L76">        reporteGerminacionDTO = new ReporteGerminacionDTO(</span>
            mediaGerminacionPorEspecie,
            tiempoPromedioPrimerConteo,
            tiempoPromedioUltimoConteo,
<span class="fc" id="L80">            15L</span>
        );

<span class="fc" id="L83">        reportePMSDTO = new ReportePMSDTO(</span>
<span class="fc" id="L84">            100L,</span>
<span class="fc" id="L85">            10L,</span>
<span class="fc" id="L86">            10.0,</span>
<span class="fc" id="L87">            5L</span>
        );

<span class="fc" id="L90">        Map&lt;String, Long&gt; contaminantesPorEspecie = new HashMap&lt;&gt;();</span>
<span class="fc" id="L91">        contaminantesPorEspecie.put(&quot;Trigo&quot;, 8L);</span>

<span class="fc" id="L93">        Map&lt;String, Double&gt; porcentajeMalezas = new HashMap&lt;&gt;();</span>
<span class="fc" id="L94">        porcentajeMalezas.put(&quot;Trigo&quot;, 2.5);</span>

<span class="fc" id="L96">        Map&lt;String, Double&gt; porcentajeOtrasSemillas = new HashMap&lt;&gt;();</span>
<span class="fc" id="L97">        porcentajeOtrasSemillas.put(&quot;Trigo&quot;, 1.5);</span>

<span class="fc" id="L99">        Map&lt;String, Double&gt; porcentajeCumpleEstandar = new HashMap&lt;&gt;();</span>
<span class="fc" id="L100">        porcentajeCumpleEstandar.put(&quot;Trigo&quot;, 90.0);</span>

<span class="fc" id="L102">        reportePurezaDTO = new ReportePurezaDTO(</span>
            contaminantesPorEspecie,
            porcentajeMalezas,
            porcentajeOtrasSemillas,
            porcentajeCumpleEstandar,
<span class="fc" id="L107">            100L</span>
        );

<span class="fc" id="L110">        Map&lt;String, Double&gt; mediaViabilidadPorEspecie = new HashMap&lt;&gt;();</span>
<span class="fc" id="L111">        mediaViabilidadPorEspecie.put(&quot;Trigo&quot;, 88.0);</span>

<span class="fc" id="L113">        reporteTetrazolioDTO = new ReporteTetrazolioDTO(</span>
            mediaViabilidadPorEspecie,
<span class="fc" id="L115">            20L</span>
        );
<span class="fc" id="L117">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Obtener reporte general sin filtros&quot;)
    void obtenerReporteGeneral_sinFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L123">        when(reporteService.obtenerReporteGeneral(null, null)).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L125">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L126">                .with(csrf()))</span>
<span class="fc" id="L127">                .andExpect(status().isOk())</span>
<span class="fc" id="L128">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25))</span>
<span class="fc" id="L129">                .andExpect(jsonPath(&quot;$.tiempoMedioFinalizacion&quot;).value(7.5))</span>
<span class="fc" id="L130">                .andExpect(jsonPath(&quot;$.analisisPorEstado.APROBADO&quot;).value(20));</span>
<span class="fc" id="L131">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Obtener reporte general con filtros de fecha&quot;)
    void obtenerReporteGeneral_conFiltrosFecha_debeRetornarReporte() throws Exception {
<span class="fc" id="L137">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L138">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L140">        when(reporteService.obtenerReporteGeneral(fechaInicio, fechaFin)).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L142">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L143">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L144">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L145">                .with(csrf()))</span>
<span class="fc" id="L146">                .andExpect(status().isOk())</span>
<span class="fc" id="L147">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25));</span>
<span class="fc" id="L148">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/germinacion - Obtener reporte de germinaci贸n&quot;)
    void obtenerReporteGerminacion_debeRetornarReporte() throws Exception {
<span class="fc" id="L154">        when(reporteService.obtenerReporteGerminacion(null, null)).thenReturn(reporteGerminacionDTO);</span>

<span class="fc" id="L156">        mockMvc.perform(get(&quot;/api/reportes/germinacion&quot;)</span>
<span class="fc" id="L157">                .with(csrf()))</span>
<span class="fc" id="L158">                .andExpect(status().isOk())</span>
<span class="fc" id="L159">                .andExpect(jsonPath(&quot;$.totalGerminaciones&quot;).value(15))</span>
<span class="fc" id="L160">                .andExpect(jsonPath(&quot;$.mediaGerminacionPorEspecie.Trigo&quot;).value(85.5))</span>
<span class="fc" id="L161">                .andExpect(jsonPath(&quot;$.mediaGerminacionPorEspecie.Cebada&quot;).value(78.3));</span>
<span class="fc" id="L162">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/germinacion - Obtener reporte de germinaci贸n con filtros&quot;)
    void obtenerReporteGerminacion_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L168">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L169">        LocalDate fechaFin = LocalDate.of(2024, 6, 30);</span>

<span class="fc" id="L171">        when(reporteService.obtenerReporteGerminacion(fechaInicio, fechaFin)).thenReturn(reporteGerminacionDTO);</span>

<span class="fc" id="L173">        mockMvc.perform(get(&quot;/api/reportes/germinacion&quot;)</span>
<span class="fc" id="L174">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L175">                .param(&quot;fechaFin&quot;, &quot;2024-06-30&quot;)</span>
<span class="fc" id="L176">                .with(csrf()))</span>
<span class="fc" id="L177">                .andExpect(status().isOk())</span>
<span class="fc" id="L178">                .andExpect(jsonPath(&quot;$.totalGerminaciones&quot;).value(15));</span>
<span class="fc" id="L179">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/pms - Obtener reporte de PMS&quot;)
    void obtenerReportePms_debeRetornarReporte() throws Exception {
<span class="fc" id="L185">        when(reporteService.obtenerReportePms(null, null)).thenReturn(reportePMSDTO);</span>

<span class="fc" id="L187">        mockMvc.perform(get(&quot;/api/reportes/pms&quot;)</span>
<span class="fc" id="L188">                .with(csrf()))</span>
<span class="fc" id="L189">                .andExpect(status().isOk())</span>
<span class="fc" id="L190">                .andExpect(jsonPath(&quot;$.totalPms&quot;).value(100))</span>
<span class="fc" id="L191">                .andExpect(jsonPath(&quot;$.muestrasConCVSuperado&quot;).value(10))</span>
<span class="fc" id="L192">                .andExpect(jsonPath(&quot;$.porcentajeMuestrasConCVSuperado&quot;).value(10.0))</span>
<span class="fc" id="L193">                .andExpect(jsonPath(&quot;$.muestrasConRepeticionesMaximas&quot;).value(5));</span>
<span class="fc" id="L194">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/pms - Obtener reporte de PMS con filtros&quot;)
    void obtenerReportePms_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L200">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L201">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L203">        when(reporteService.obtenerReportePms(fechaInicio, fechaFin)).thenReturn(reportePMSDTO);</span>

<span class="fc" id="L205">        mockMvc.perform(get(&quot;/api/reportes/pms&quot;)</span>
<span class="fc" id="L206">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L207">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L208">                .with(csrf()))</span>
<span class="fc" id="L209">                .andExpect(status().isOk())</span>
<span class="fc" id="L210">                .andExpect(jsonPath(&quot;$.totalPms&quot;).value(100));</span>
<span class="fc" id="L211">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza - Obtener reporte de pureza&quot;)
    void obtenerReportePureza_debeRetornarReporte() throws Exception {
<span class="fc" id="L217">        when(reporteService.obtenerReportePureza(null, null)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L219">        mockMvc.perform(get(&quot;/api/reportes/pureza&quot;)</span>
<span class="fc" id="L220">                .with(csrf()))</span>
<span class="fc" id="L221">                .andExpect(status().isOk())</span>
<span class="fc" id="L222">                .andExpect(jsonPath(&quot;$.contaminantesPorEspecie.Trigo&quot;).value(8))</span>
<span class="fc" id="L223">                .andExpect(jsonPath(&quot;$.porcentajeMalezas.Trigo&quot;).value(2.5))</span>
<span class="fc" id="L224">                .andExpect(jsonPath(&quot;$.porcentajeOtrasSemillas.Trigo&quot;).value(1.5))</span>
<span class="fc" id="L225">                .andExpect(jsonPath(&quot;$.porcentajeCumpleEstandar.Trigo&quot;).value(90.0));</span>
<span class="fc" id="L226">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza - Obtener reporte de pureza con filtros&quot;)
    void obtenerReportePureza_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L232">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L233">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L235">        when(reporteService.obtenerReportePureza(fechaInicio, fechaFin)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L237">        mockMvc.perform(get(&quot;/api/reportes/pureza&quot;)</span>
<span class="fc" id="L238">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L239">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L240">                .with(csrf()))</span>
<span class="fc" id="L241">                .andExpect(status().isOk())</span>
<span class="fc" id="L242">                .andExpect(jsonPath(&quot;$.contaminantesPorEspecie.Trigo&quot;).value(8));</span>
<span class="fc" id="L243">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/tetrazolio - Obtener reporte de tetrazolio&quot;)
    void obtenerReporteTetrazolio_debeRetornarReporte() throws Exception {
<span class="fc" id="L249">        when(reporteService.obtenerReporteTetrazolio(null, null)).thenReturn(reporteTetrazolioDTO);</span>

<span class="fc" id="L251">        mockMvc.perform(get(&quot;/api/reportes/tetrazolio&quot;)</span>
<span class="fc" id="L252">                .with(csrf()))</span>
<span class="fc" id="L253">                .andExpect(status().isOk())</span>
<span class="fc" id="L254">                .andExpect(jsonPath(&quot;$.totalTetrazolios&quot;).value(20))</span>
<span class="fc" id="L255">                .andExpect(jsonPath(&quot;$.viabilidadPorEspecie.Trigo&quot;).value(88.0));</span>
<span class="fc" id="L256">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/tetrazolio - Obtener reporte de tetrazolio con filtros&quot;)
    void obtenerReporteTetrazolio_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L262">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L263">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L265">        when(reporteService.obtenerReporteTetrazolio(fechaInicio, fechaFin)).thenReturn(reporteTetrazolioDTO);</span>

<span class="fc" id="L267">        mockMvc.perform(get(&quot;/api/reportes/tetrazolio&quot;)</span>
<span class="fc" id="L268">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L269">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L270">                .with(csrf()))</span>
<span class="fc" id="L271">                .andExpect(status().isOk())</span>
<span class="fc" id="L272">                .andExpect(jsonPath(&quot;$.totalTetrazolios&quot;).value(20));</span>
<span class="fc" id="L273">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn - Obtener reporte de DOSN&quot;)
    void obtenerReporteDosn_debeRetornarReporte() throws Exception {
<span class="fc" id="L279">        when(reporteService.obtenerReporteDosn(null, null)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L281">        mockMvc.perform(get(&quot;/api/reportes/dosn&quot;)</span>
<span class="fc" id="L282">                .with(csrf()))</span>
<span class="fc" id="L283">                .andExpect(status().isOk())</span>
<span class="fc" id="L284">                .andExpect(jsonPath(&quot;$.contaminantesPorEspecie.Trigo&quot;).value(8));</span>
<span class="fc" id="L285">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn - Obtener reporte de DOSN con filtros&quot;)
    void obtenerReporteDosn_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L291">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L292">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L294">        when(reporteService.obtenerReporteDosn(fechaInicio, fechaFin)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L296">        mockMvc.perform(get(&quot;/api/reportes/dosn&quot;)</span>
<span class="fc" id="L297">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L298">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L299">                .with(csrf()))</span>
<span class="fc" id="L300">                .andExpect(status().isOk())</span>
<span class="fc" id="L301">                .andExpect(jsonPath(&quot;$.porcentajeMalezas.Trigo&quot;).value(2.5));</span>
<span class="fc" id="L302">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza/contaminantes/{especie} - Obtener contaminantes de pureza por especie&quot;)
    void obtenerContaminantesPureza_debeRetornarMapa() throws Exception {
<span class="fc" id="L308">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L309">        contaminantes.put(&quot;Malezas&quot;, 2.5);</span>
<span class="fc" id="L310">        contaminantes.put(&quot;OtrasSemillas&quot;, 1.5);</span>

<span class="fc" id="L312">        when(reporteService.obtenerContaminantesPorEspeciePureza(eq(&quot;Trigo&quot;), isNull(), isNull())).thenReturn(contaminantes);</span>

<span class="fc" id="L314">        mockMvc.perform(get(&quot;/api/reportes/pureza/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L315">                .with(csrf()))</span>
<span class="fc" id="L316">                .andExpect(status().isOk())</span>
<span class="fc" id="L317">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(2.5))</span>
<span class="fc" id="L318">                .andExpect(jsonPath(&quot;$.OtrasSemillas&quot;).value(1.5));</span>
<span class="fc" id="L319">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza/contaminantes/{especie} - Obtener contaminantes de pureza por especie con filtros&quot;)
    void obtenerContaminantesPureza_conFiltros_debeRetornarMapa() throws Exception {
<span class="fc" id="L325">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L326">        contaminantes.put(&quot;Malezas&quot;, 3.0);</span>
<span class="fc" id="L327">        contaminantes.put(&quot;OtrasSemillas&quot;, 2.0);</span>

<span class="fc" id="L329">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L330">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L332">        when(reporteService.obtenerContaminantesPorEspeciePureza(eq(&quot;Trigo&quot;), eq(fechaInicio), eq(fechaFin))).thenReturn(contaminantes);</span>

<span class="fc" id="L334">        mockMvc.perform(get(&quot;/api/reportes/pureza/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L335">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L336">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L337">                .with(csrf()))</span>
<span class="fc" id="L338">                .andExpect(status().isOk())</span>
<span class="fc" id="L339">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(3.0));</span>
<span class="fc" id="L340">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn/contaminantes/{especie} - Obtener contaminantes de DOSN por especie&quot;)
    void obtenerContaminantesDosn_debeRetornarMapa() throws Exception {
<span class="fc" id="L346">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L347">        contaminantes.put(&quot;Malezas&quot;, 1.8);</span>
<span class="fc" id="L348">        contaminantes.put(&quot;OtrasSemillas&quot;, 1.2);</span>

<span class="fc" id="L350">        when(reporteService.obtenerContaminantesPorEspecieDosn(eq(&quot;Trigo&quot;), isNull(), isNull())).thenReturn(contaminantes);</span>

<span class="fc" id="L352">        mockMvc.perform(get(&quot;/api/reportes/dosn/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L353">                .with(csrf()))</span>
<span class="fc" id="L354">                .andExpect(status().isOk())</span>
<span class="fc" id="L355">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(1.8))</span>
<span class="fc" id="L356">                .andExpect(jsonPath(&quot;$.OtrasSemillas&quot;).value(1.2));</span>
<span class="fc" id="L357">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn/contaminantes/{especie} - Obtener contaminantes de DOSN por especie con filtros&quot;)
    void obtenerContaminantesDosn_conFiltros_debeRetornarMapa() throws Exception {
<span class="fc" id="L363">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L364">        contaminantes.put(&quot;Malezas&quot;, 2.2);</span>
<span class="fc" id="L365">        contaminantes.put(&quot;OtrasSemillas&quot;, 1.8);</span>

<span class="fc" id="L367">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L368">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L370">        when(reporteService.obtenerContaminantesPorEspecieDosn(eq(&quot;Trigo&quot;), eq(fechaInicio), eq(fechaFin))).thenReturn(contaminantes);</span>

<span class="fc" id="L372">        mockMvc.perform(get(&quot;/api/reportes/dosn/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L373">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L374">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L375">                .with(csrf()))</span>
<span class="fc" id="L376">                .andExpect(status().isOk())</span>
<span class="fc" id="L377">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(2.2));</span>
<span class="fc" id="L378">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Observador puede ver reportes&quot;)
    void obtenerReporteGeneral_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L384">        when(reporteService.obtenerReporteGeneral(null, null)).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L386">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L387">                .with(csrf()))</span>
<span class="fc" id="L388">                .andExpect(status().isOk());</span>
<span class="fc" id="L389">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;GET /api/reportes/germinacion - Observador puede ver reportes de germinaci贸n&quot;)
    void obtenerReporteGerminacion_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L395">        when(reporteService.obtenerReporteGerminacion(null, null)).thenReturn(reporteGerminacionDTO);</span>

<span class="fc" id="L397">        mockMvc.perform(get(&quot;/api/reportes/germinacion&quot;)</span>
<span class="fc" id="L398">                .with(csrf()))</span>
<span class="fc" id="L399">                .andExpect(status().isOk());</span>
<span class="fc" id="L400">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Solo fechaInicio especificada&quot;)
    void obtenerReporteGeneral_soloFechaInicio_debeRetornarReporte() throws Exception {
<span class="fc" id="L406">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>

<span class="fc" id="L408">        when(reporteService.obtenerReporteGeneral(eq(fechaInicio), isNull())).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L410">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L411">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L412">                .with(csrf()))</span>
<span class="fc" id="L413">                .andExpect(status().isOk())</span>
<span class="fc" id="L414">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25));</span>
<span class="fc" id="L415">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Solo fechaFin especificada&quot;)
    void obtenerReporteGeneral_soloFechaFin_debeRetornarReporte() throws Exception {
<span class="fc" id="L421">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L423">        when(reporteService.obtenerReporteGeneral(isNull(), eq(fechaFin))).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L425">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L426">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L427">                .with(csrf()))</span>
<span class="fc" id="L428">                .andExpect(status().isOk())</span>
<span class="fc" id="L429">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25));</span>
<span class="fc" id="L430">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>