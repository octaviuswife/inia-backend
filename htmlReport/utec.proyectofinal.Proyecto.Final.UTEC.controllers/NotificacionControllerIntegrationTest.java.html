<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificacionControllerIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.controllers</a> &gt; <span class="el_source">NotificacionControllerIntegrationTest.java</span></div><h1>NotificacionControllerIntegrationTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.controllers;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.MediaType;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.NotificacionRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.NotificacionDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoNotificacion;
import utec.proyectofinal.Proyecto.Final.UTEC.services.NotificacionService;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.doNothing;
import static org.mockito.Mockito.when;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.csrf;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(NotificacionController.class)
@DisplayName(&quot;Tests de integración para NotificacionController&quot;)
<span class="fc" id="L34">class NotificacionControllerIntegrationTest {</span>

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @MockBean
    private NotificacionService notificacionService;

    private NotificacionDTO notificacionDTO;
    private NotificacionRequestDTO notificacionRequestDTO;

    @BeforeEach
    void setUp() {
<span class="fc" id="L50">        notificacionDTO = new NotificacionDTO();</span>
<span class="fc" id="L51">        notificacionDTO.setId(1L);</span>
<span class="fc" id="L52">        notificacionDTO.setNombre(&quot;Test Notificación&quot;);</span>
<span class="fc" id="L53">        notificacionDTO.setMensaje(&quot;Mensaje de prueba&quot;);</span>
<span class="fc" id="L54">        notificacionDTO.setUsuarioId(1L);</span>
<span class="fc" id="L55">        notificacionDTO.setLeido(false);</span>
<span class="fc" id="L56">        notificacionDTO.setFechaCreacion(LocalDateTime.now());</span>
<span class="fc" id="L57">        notificacionDTO.setTipo(TipoNotificacion.USUARIO_REGISTRO);</span>
<span class="fc" id="L58">        notificacionDTO.setActivo(true);</span>

<span class="fc" id="L60">        notificacionRequestDTO = new NotificacionRequestDTO();</span>
<span class="fc" id="L61">        notificacionRequestDTO.setNombre(&quot;Test Notificación&quot;);</span>
<span class="fc" id="L62">        notificacionRequestDTO.setMensaje(&quot;Mensaje de prueba&quot;);</span>
<span class="fc" id="L63">        notificacionRequestDTO.setUsuarioId(1L);</span>
<span class="fc" id="L64">        notificacionRequestDTO.setTipo(TipoNotificacion.USUARIO_REGISTRO);</span>
<span class="fc" id="L65">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;POST /api/notificaciones - Crear notificación manual&quot;)
    void crearNotificacion_debeRetornarNotificacionCreada() throws Exception {
<span class="fc" id="L71">        when(notificacionService.crearNotificacion(any(NotificacionRequestDTO.class))).thenReturn(notificacionDTO);</span>

<span class="fc" id="L73">        mockMvc.perform(post(&quot;/api/notificaciones&quot;)</span>
<span class="fc" id="L74">                .with(csrf())</span>
<span class="fc" id="L75">                .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L76">                .content(objectMapper.writeValueAsString(notificacionRequestDTO)))</span>
<span class="fc" id="L77">                .andExpect(status().isOk())</span>
<span class="fc" id="L78">                .andExpect(jsonPath(&quot;$.id&quot;).value(1))</span>
<span class="fc" id="L79">                .andExpect(jsonPath(&quot;$.nombre&quot;).value(&quot;Test Notificación&quot;))</span>
<span class="fc" id="L80">                .andExpect(jsonPath(&quot;$.mensaje&quot;).value(&quot;Mensaje de prueba&quot;))</span>
<span class="fc" id="L81">                .andExpect(jsonPath(&quot;$.leido&quot;).value(false));</span>
<span class="fc" id="L82">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/notificaciones/usuario/{usuarioId} - Obtener notificaciones paginadas de un usuario&quot;)
    void obtenerNotificacionesPorUsuario_debeRetornarPaginacion() throws Exception {
<span class="fc" id="L88">        Page&lt;NotificacionDTO&gt; page = new PageImpl&lt;&gt;(</span>
<span class="fc" id="L89">            Arrays.asList(notificacionDTO),</span>
<span class="fc" id="L90">            PageRequest.of(0, 10),</span>
<span class="fc" id="L91">            1</span>
        );
        
<span class="fc" id="L94">        when(notificacionService.obtenerNotificacionesPorUsuarioConValidacion(eq(1L), any())).thenReturn(page);</span>

<span class="fc" id="L96">        mockMvc.perform(get(&quot;/api/notificaciones/usuario/1&quot;)</span>
<span class="fc" id="L97">                .param(&quot;page&quot;, &quot;0&quot;)</span>
<span class="fc" id="L98">                .param(&quot;size&quot;, &quot;10&quot;)</span>
<span class="fc" id="L99">                .with(csrf()))</span>
<span class="fc" id="L100">                .andExpect(status().isOk())</span>
<span class="fc" id="L101">                .andExpect(jsonPath(&quot;$.content&quot;).isArray())</span>
<span class="fc" id="L102">                .andExpect(jsonPath(&quot;$.content[0].id&quot;).value(1))</span>
<span class="fc" id="L103">                .andExpect(jsonPath(&quot;$.content[0].usuarioId&quot;).value(1));</span>
<span class="fc" id="L104">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/notificaciones/mis-notificaciones - Obtener mis notificaciones paginadas&quot;)
    void obtenerMisNotificaciones_debeRetornarPaginacion() throws Exception {
<span class="fc" id="L110">        Page&lt;NotificacionDTO&gt; page = new PageImpl&lt;&gt;(</span>
<span class="fc" id="L111">            Arrays.asList(notificacionDTO),</span>
<span class="fc" id="L112">            PageRequest.of(0, 10),</span>
<span class="fc" id="L113">            1</span>
        );
        
<span class="fc" id="L116">        when(notificacionService.obtenerMisNotificaciones(any())).thenReturn(page);</span>

<span class="fc" id="L118">        mockMvc.perform(get(&quot;/api/notificaciones/mis-notificaciones&quot;)</span>
<span class="fc" id="L119">                .param(&quot;page&quot;, &quot;0&quot;)</span>
<span class="fc" id="L120">                .param(&quot;size&quot;, &quot;10&quot;)</span>
<span class="fc" id="L121">                .with(csrf()))</span>
<span class="fc" id="L122">                .andExpect(status().isOk())</span>
<span class="fc" id="L123">                .andExpect(jsonPath(&quot;$.content&quot;).isArray())</span>
<span class="fc" id="L124">                .andExpect(jsonPath(&quot;$.content[0].id&quot;).value(1));</span>
<span class="fc" id="L125">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/notificaciones/usuario/{usuarioId}/no-leidas - Obtener notificaciones no leídas de un usuario&quot;)
    void obtenerNotificacionesNoLeidas_debeRetornarLista() throws Exception {
<span class="fc" id="L131">        NotificacionDTO notificacion1 = new NotificacionDTO();</span>
<span class="fc" id="L132">        notificacion1.setId(1L);</span>
<span class="fc" id="L133">        notificacion1.setLeido(false);</span>
        
<span class="fc" id="L135">        NotificacionDTO notificacion2 = new NotificacionDTO();</span>
<span class="fc" id="L136">        notificacion2.setId(2L);</span>
<span class="fc" id="L137">        notificacion2.setLeido(false);</span>

<span class="fc" id="L139">        List&lt;NotificacionDTO&gt; noLeidas = Arrays.asList(notificacion1, notificacion2);</span>
<span class="fc" id="L140">        when(notificacionService.obtenerNotificacionesNoLeidasConValidacion(1L)).thenReturn(noLeidas);</span>

<span class="fc" id="L142">        mockMvc.perform(get(&quot;/api/notificaciones/usuario/1/no-leidas&quot;)</span>
<span class="fc" id="L143">                .with(csrf()))</span>
<span class="fc" id="L144">                .andExpect(status().isOk())</span>
<span class="fc" id="L145">                .andExpect(jsonPath(&quot;$[0].leido&quot;).value(false))</span>
<span class="fc" id="L146">                .andExpect(jsonPath(&quot;$[1].leido&quot;).value(false))</span>
<span class="fc" id="L147">                .andExpect(jsonPath(&quot;$.length()&quot;).value(2));</span>
<span class="fc" id="L148">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/notificaciones/mis-notificaciones/no-leidas - Obtener mis notificaciones no leídas&quot;)
    void obtenerMisNotificacionesNoLeidas_debeRetornarLista() throws Exception {
<span class="fc" id="L154">        List&lt;NotificacionDTO&gt; noLeidas = Arrays.asList(notificacionDTO);</span>
<span class="fc" id="L155">        when(notificacionService.obtenerMisNotificacionesNoLeidas()).thenReturn(noLeidas);</span>

<span class="fc" id="L157">        mockMvc.perform(get(&quot;/api/notificaciones/mis-notificaciones/no-leidas&quot;)</span>
<span class="fc" id="L158">                .with(csrf()))</span>
<span class="fc" id="L159">                .andExpect(status().isOk())</span>
<span class="fc" id="L160">                .andExpect(jsonPath(&quot;$[0].leido&quot;).value(false))</span>
<span class="fc" id="L161">                .andExpect(jsonPath(&quot;$.length()&quot;).value(1));</span>
<span class="fc" id="L162">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/notificaciones/usuario/{usuarioId}/contar-no-leidas - Contar notificaciones no leídas&quot;)
    void contarNotificacionesNoLeidas_debeRetornarConteo() throws Exception {
<span class="fc" id="L168">        when(notificacionService.contarNotificacionesNoLeidasConValidacion(1L)).thenReturn(5L);</span>

<span class="fc" id="L170">        mockMvc.perform(get(&quot;/api/notificaciones/usuario/1/contar-no-leidas&quot;)</span>
<span class="fc" id="L171">                .with(csrf()))</span>
<span class="fc" id="L172">                .andExpect(status().isOk())</span>
<span class="fc" id="L173">                .andExpect(jsonPath(&quot;$&quot;).value(5));</span>
<span class="fc" id="L174">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/notificaciones/mis-notificaciones/contar-no-leidas - Contar mis notificaciones no leídas&quot;)
    void contarMisNotificacionesNoLeidas_debeRetornarConteo() throws Exception {
<span class="fc" id="L180">        when(notificacionService.contarMisNotificacionesNoLeidas()).thenReturn(3L);</span>

<span class="fc" id="L182">        mockMvc.perform(get(&quot;/api/notificaciones/mis-notificaciones/contar-no-leidas&quot;)</span>
<span class="fc" id="L183">                .with(csrf()))</span>
<span class="fc" id="L184">                .andExpect(status().isOk())</span>
<span class="fc" id="L185">                .andExpect(jsonPath(&quot;$&quot;).value(3));</span>
<span class="fc" id="L186">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;PUT /api/notificaciones/{notificacionId}/marcar-leida - Marcar notificación como leída&quot;)
    void marcarComoLeida_debeRetornarNotificacionActualizada() throws Exception {
<span class="fc" id="L192">        NotificacionDTO notificacionLeida = new NotificacionDTO();</span>
<span class="fc" id="L193">        notificacionLeida.setId(1L);</span>
<span class="fc" id="L194">        notificacionLeida.setLeido(true);</span>
        
<span class="fc" id="L196">        when(notificacionService.marcarComoLeida(1L)).thenReturn(notificacionLeida);</span>

<span class="fc" id="L198">        mockMvc.perform(put(&quot;/api/notificaciones/1/marcar-leida&quot;)</span>
<span class="fc" id="L199">                .with(csrf()))</span>
<span class="fc" id="L200">                .andExpect(status().isOk())</span>
<span class="fc" id="L201">                .andExpect(jsonPath(&quot;$.id&quot;).value(1))</span>
<span class="fc" id="L202">                .andExpect(jsonPath(&quot;$.leido&quot;).value(true));</span>
<span class="fc" id="L203">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;PUT /api/notificaciones/usuario/{usuarioId}/marcar-todas-leidas - Marcar todas como leídas de un usuario&quot;)
    void marcarTodasComoLeidas_debeRetornarOk() throws Exception {
<span class="fc" id="L209">        doNothing().when(notificacionService).marcarTodasComoLeidasConValidacion(1L);</span>

<span class="fc" id="L211">        mockMvc.perform(put(&quot;/api/notificaciones/usuario/1/marcar-todas-leidas&quot;)</span>
<span class="fc" id="L212">                .with(csrf()))</span>
<span class="fc" id="L213">                .andExpect(status().isOk());</span>
<span class="fc" id="L214">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;PUT /api/notificaciones/mis-notificaciones/marcar-todas-leidas - Marcar todas mis notificaciones como leídas&quot;)
    void marcarTodasMisNotificacionesComoLeidas_debeRetornarOk() throws Exception {
<span class="fc" id="L220">        doNothing().when(notificacionService).marcarTodasMisNotificacionesComoLeidas();</span>

<span class="fc" id="L222">        mockMvc.perform(put(&quot;/api/notificaciones/mis-notificaciones/marcar-todas-leidas&quot;)</span>
<span class="fc" id="L223">                .with(csrf()))</span>
<span class="fc" id="L224">                .andExpect(status().isOk());</span>
<span class="fc" id="L225">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;DELETE /api/notificaciones/{notificacionId} - Eliminar notificación&quot;)
    void eliminarNotificacion_debeRetornarOk() throws Exception {
<span class="fc" id="L231">        doNothing().when(notificacionService).eliminarNotificacion(1L);</span>

<span class="fc" id="L233">        mockMvc.perform(delete(&quot;/api/notificaciones/1&quot;)</span>
<span class="fc" id="L234">                .with(csrf()))</span>
<span class="fc" id="L235">                .andExpect(status().isOk());</span>
<span class="fc" id="L236">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;GET /api/notificaciones/mis-notificaciones - Observador puede ver sus notificaciones&quot;)
    void obtenerMisNotificaciones_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L242">        Page&lt;NotificacionDTO&gt; page = new PageImpl&lt;&gt;(</span>
<span class="fc" id="L243">            Arrays.asList(notificacionDTO),</span>
<span class="fc" id="L244">            PageRequest.of(0, 10),</span>
<span class="fc" id="L245">            1</span>
        );
        
<span class="fc" id="L248">        when(notificacionService.obtenerMisNotificaciones(any())).thenReturn(page);</span>

<span class="fc" id="L250">        mockMvc.perform(get(&quot;/api/notificaciones/mis-notificaciones&quot;)</span>
<span class="fc" id="L251">                .param(&quot;page&quot;, &quot;0&quot;)</span>
<span class="fc" id="L252">                .param(&quot;size&quot;, &quot;10&quot;)</span>
<span class="fc" id="L253">                .with(csrf()))</span>
<span class="fc" id="L254">                .andExpect(status().isOk());</span>
<span class="fc" id="L255">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/notificaciones/mis-notificaciones - Con paginación personalizada&quot;)
    void obtenerMisNotificaciones_conPaginacionPersonalizada_debeRetornarOk() throws Exception {
<span class="fc" id="L261">        Page&lt;NotificacionDTO&gt; page = new PageImpl&lt;&gt;(</span>
<span class="fc" id="L262">            Arrays.asList(notificacionDTO),</span>
<span class="fc" id="L263">            PageRequest.of(2, 5),</span>
<span class="fc" id="L264">            20</span>
        );
        
<span class="fc" id="L267">        when(notificacionService.obtenerMisNotificaciones(any())).thenReturn(page);</span>

<span class="fc" id="L269">        mockMvc.perform(get(&quot;/api/notificaciones/mis-notificaciones&quot;)</span>
<span class="fc" id="L270">                .param(&quot;page&quot;, &quot;2&quot;)</span>
<span class="fc" id="L271">                .param(&quot;size&quot;, &quot;5&quot;)</span>
<span class="fc" id="L272">                .with(csrf()))</span>
<span class="fc" id="L273">                .andExpect(status().isOk())</span>
<span class="fc" id="L274">                .andExpect(jsonPath(&quot;$.content&quot;).isArray())</span>
<span class="fc" id="L275">                .andExpect(jsonPath(&quot;$.content[0].id&quot;).value(1));</span>
<span class="fc" id="L276">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/notificaciones/usuario/{usuarioId} - Con paginación personalizada&quot;)
    void obtenerNotificacionesPorUsuario_conPaginacionPersonalizada_debeRetornarOk() throws Exception {
<span class="fc" id="L282">        Page&lt;NotificacionDTO&gt; page = new PageImpl&lt;&gt;(</span>
<span class="fc" id="L283">            Arrays.asList(notificacionDTO),</span>
<span class="fc" id="L284">            PageRequest.of(1, 15),</span>
<span class="fc" id="L285">            30</span>
        );
        
<span class="fc" id="L288">        when(notificacionService.obtenerNotificacionesPorUsuarioConValidacion(eq(1L), any())).thenReturn(page);</span>

<span class="fc" id="L290">        mockMvc.perform(get(&quot;/api/notificaciones/usuario/1&quot;)</span>
<span class="fc" id="L291">                .param(&quot;page&quot;, &quot;1&quot;)</span>
<span class="fc" id="L292">                .param(&quot;size&quot;, &quot;15&quot;)</span>
<span class="fc" id="L293">                .with(csrf()))</span>
<span class="fc" id="L294">                .andExpect(status().isOk())</span>
<span class="fc" id="L295">                .andExpect(jsonPath(&quot;$.content&quot;).isArray())</span>
<span class="fc" id="L296">                .andExpect(jsonPath(&quot;$.content[0].id&quot;).value(1));</span>
<span class="fc" id="L297">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;GET /api/notificaciones/mis-notificaciones/contar-no-leidas - Observador puede contar sus notificaciones&quot;)
    void contarMisNotificacionesNoLeidas_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L303">        when(notificacionService.contarMisNotificacionesNoLeidas()).thenReturn(2L);</span>

<span class="fc" id="L305">        mockMvc.perform(get(&quot;/api/notificaciones/mis-notificaciones/contar-no-leidas&quot;)</span>
<span class="fc" id="L306">                .with(csrf()))</span>
<span class="fc" id="L307">                .andExpect(status().isOk())</span>
<span class="fc" id="L308">                .andExpect(jsonPath(&quot;$&quot;).value(2));</span>
<span class="fc" id="L309">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;PUT /api/notificaciones/{notificacionId}/marcar-leida - Observador puede marcar como leída&quot;)
    void marcarComoLeida_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L315">        NotificacionDTO notificacionLeida = new NotificacionDTO();</span>
<span class="fc" id="L316">        notificacionLeida.setId(1L);</span>
<span class="fc" id="L317">        notificacionLeida.setLeido(true);</span>
        
<span class="fc" id="L319">        when(notificacionService.marcarComoLeida(1L)).thenReturn(notificacionLeida);</span>

<span class="fc" id="L321">        mockMvc.perform(put(&quot;/api/notificaciones/1/marcar-leida&quot;)</span>
<span class="fc" id="L322">                .with(csrf()))</span>
<span class="fc" id="L323">                .andExpect(status().isOk())</span>
<span class="fc" id="L324">                .andExpect(jsonPath(&quot;$.leido&quot;).value(true));</span>
<span class="fc" id="L325">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;DELETE /api/notificaciones/{notificacionId} - Observador puede eliminar notificación&quot;)
    void eliminarNotificacion_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L331">        doNothing().when(notificacionService).eliminarNotificacion(1L);</span>

<span class="fc" id="L333">        mockMvc.perform(delete(&quot;/api/notificaciones/1&quot;)</span>
<span class="fc" id="L334">                .with(csrf()))</span>
<span class="fc" id="L335">                .andExpect(status().isOk());</span>
<span class="fc" id="L336">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>